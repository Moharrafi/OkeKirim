<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OkeKirim</title>
    <script>
        // Apply saved dark mode ASAP (like indexaspal):
        // If user has a saved preference, use it; otherwise follow OS.
        (function () {
            try {
                var saved = localStorage.getItem('darkMode');
                var prefers = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (saved === 'dark' || (saved === null && prefers)) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            } catch (e) { }
        })();
    </script>
    <script>
        // Ensure Tailwind CDN uses class-based dark mode (not media)
        try {
            window.tailwind = window.tailwind || {};
            window.tailwind.config = { darkMode: 'class' };
            // Also expose global variable expected by CDN
            // Some environments read `tailwind.config` directly
            window.tailwindcss_config_applied = true;
        } catch (e) { }
        try {
            // Fallback global if CDN checks `tailwind` directly
            // This won't error if `tailwind` is not yet defined
            // The CDN will read this config when it initializes
            // eslint-disable-next-line no-global-assign
            tailwind = { config: { darkMode: 'class' } };
        } catch (e) { }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Double-ensure Tailwind uses class-based dark mode after CDN load
        try { tailwind.config = Object.assign({}, tailwind.config || {}, { darkMode: 'class' }); } catch (e) { }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>window.API_BASE = window.API_BASE || 'api';</script>
    <script>
        // Auth guard: redirect to login if not authenticated
        (function () {
            try {
                var url = (window.API_BASE || 'api') + '/auth.php?action=me';
                fetch(url, { credentials: 'same-origin' })
                    .then(function (res) { return res.json().catch(function () { return {}; }).then(function (data) { return { ok: res.ok, data: data }; }); })
                    .then(function (r) {
                        if (!r.ok || !r.data || r.data.success !== true) {
                            window.location.href = 'login.html';
                        }
                    })
                    .catch(function () { window.location.href = 'login.html'; });
            } catch (e) { /* ignore */ }
        })();
    </script>
    <!-- PDF export libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        /* Dark mode transition */
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        body {
            font-family: 'Inter', sans-serif;
        }

        .sidebar-transition {
            transition: transform 0.3s ease-out;
        }

        .content-transition {
            transition: margin-left 0.3s ease-out;
        }

        .smooth-hover {
            transition: all 0.2s ease-out;
        }

        .menu-item {
            transition: all 0.2s ease-out;
        }

        .menu-item:hover {
            transform: translateX(4px);
        }

        .card-hover {
            transition: all 0.2s ease-out;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .modal {
            transition: all 0.3s ease-out;
        }

        .fade-in {
            animation: fadeIn 0.8s cubic-bezier(0.22, 1, 0.36, 1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(12px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }

        }

        /* Dark mode toggle animation */
        .dark-mode-toggle {
            transition: all 0.3s ease;
        }

        .dark-mode-toggle:hover {
            transform: rotate(180deg);
        }

        /* Bell animation */
        .bell-animation {
            animation: bellRing 0.6s ease-in-out;
        }

        @keyframes bellRing {

            0%,
            100% {
                transform: rotate(0deg);
            }

            10%,
            30%,
            50%,
            70%,
            90% {
                transform: rotate(-10deg);
            }

            20%,
            40%,
            60%,
            80% {
                transform: rotate(10deg);
            }
        }

        /* User menu animation */
        .user-menu-animation {
            animation: userBounce 0.4s ease-out;
        }

        @keyframes userBounce {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        /* Notification badge pulse */
        .notification-badge {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        /* Dropdown slide animation */
        .dropdown-enter {
            animation: dropdownSlide 0.2s ease-out;
        }

        @keyframes dropdownSlide {
            from {
                opacity: 0;
                transform: translateY(-10px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Copied from indexaspal for dark mode animations/utilities */
        .dark-transition {
            transition: all 0.3s ease;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .hide-scrollbar::-webkit-scrollbar {
            width: 0;
            height: 0;
        }

        .thin-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 0, 0, 0.45) transparent;
        }

        .thin-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .thin-scrollbar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.06);
            border-radius: 8px;
        }

        .thin-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(100, 116, 139, 0.6);
            border-radius: 8px;
        }

        .dark .thin-scrollbar {
            scrollbar-color: rgba(51, 65, 85, 0.8) #0f172a;
        }

        .dark .thin-scrollbar::-webkit-scrollbar-track {
            background: #0f172a;
        }

        .dark .thin-scrollbar::-webkit-scrollbar-thumb {
            background-color: #334155;
        }

        /* Recent Activities scrollbar: dark mode track black */
        .dark #recentActivities {
            scrollbar-color: #334155 #000;
        }

        .dark #recentActivities::-webkit-scrollbar-track {
            background: #000;
        }

        .dark #recentActivities::-webkit-scrollbar-thumb {
            background-color: #334155;
        }

        /* Toast notifications (iPhone-like) */
        .toast-enter {
            animation: toastIn 0.25s ease-out;
        }

        .toast-leave {
            animation: toastOut 0.2s ease-in forwards;
        }

        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translateY(-8px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes toastOut {
            from {
                opacity: 1;
                transform: translateY(0) scale(1);
            }

            to {
                opacity: 0;
                transform: translateY(-8px) scale(0.98);
            }
        }
    </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
    <!-- Mobile Menu Overlay -->
    <div id="mobileOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden"></div>

    <!-- Mobile Menu Button (floating, like supir.html) -->
    <button id="mobile-menu-btn"
        class="fixed top-4 sm:top-3 left-3 z-[70] lg:hidden w-10 h-10 flex items-center justify-center rounded-lg border border-gray-200 bg-white text-gray-700 hover:bg-gray-100 hover:text-gray-900 shadow-sm transition-colors dark:bg-gray-800 dark:text-gray-200 dark:border-gray-700 dark:hover:bg-gray-700 dark:hover:text-white pointer-events-auto smooth-hover">
        <i class="fas fa-bars text-lg lg:text-xl"></i>
    </button>

    <!-- Sidebar -->
    <div id="sidebar"
        class="fixed left-0 top-0 h-full w-64 bg-gradient-to-b from-white via-gray-50 to-gray-100 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 border-r border-gray-200 dark:border-slate-700/50 shadow-2xl z-50 sidebar-transition transform -translate-x-full lg:translate-x-0 overflow-y-auto">
        <!-- Logo Section (sticky, visible on mobile) -->
        <div class="p-4 border-b border-gray-200 dark:border-slate-700/50 sticky top-0 z-10 bg-transparent">
            <div class="flex items-center space-x-2">
                <div class="relative">
                    <img src="img/okekirim.png" alt="OkeKirim"
                        class="w-12 h-12 rounded-lg object-contain bg-white dark:bg-slate-800 shadow-lg p-0.5">
                    <div class="absolute -top-1 -right-1 w-3 h-3 bg-green-400 rounded-full"></div>
                </div>
                <div class="min-w-0">
                    <h1 class="text-xl font-bold text-slate-900 dark:text-white truncate">OkeKirim</h1>
                    <p class="text-xs text-slate-500 dark:text-slate-300 truncate">Management System</p>
                </div>
            </div>
        </div>

        <!-- Navigation Menu -->
        <nav class="mt-2 px-3 pb-24">
            <div class="space-y-1">
                <div class="px-2 py-1">
                    <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Main Menu</p>
                </div>

                <a href="#"
                    class="menu-item nav-item active group flex items-center px-3 py-2 text-white bg-gradient-to-r from-blue-600 to-blue-500 rounded-lg shadow-lg transform transition-all duration-200"
                    data-page="dashboard">
                    <div
                        class="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center mr-2 group-hover:bg-white/30 transition-colors">
                        <i class="fas fa-chart-pie text-blue-600 dark:text-blue-300 text-sm"></i>
                    </div>
                    <div class="flex-1">
                        <span class="font-medium text-sm">Dashboard</span>
                        <p class="text-xs text-white">Overview</p>
                    </div>
                </a>

                <a href="#"
                    class="menu-item nav-item group flex items-center px-3 py-2 text-slate-700 hover:text-slate-900 hover:bg-gray-100 dark:text-slate-300 dark:hover:text-white dark:hover:bg-slate-800/50 rounded-lg transition-all duration-200"
                    data-page="drivers">
                    <div
                        class="w-8 h-8 bg-gray-100 dark:bg-slate-700/50 rounded-lg flex items-center justify-center mr-2 group-hover:bg-emerald-500/20 transition-colors">
                        <i
                            class="fas fa-users text-emerald-500 dark:text-emerald-400 group-hover:text-emerald-400 text-sm"></i>
                    </div>
                    <div class="flex-1">
                        <span class="font-medium text-sm">Kelola Supir</span>
                        <p
                            class="text-xs text-slate-500 dark:text-slate-300 group-hover:text-slate-600 dark:group-hover:text-slate-200">
                            Driver</p>
                    </div>
                </a>

                <a href="#"
                    class="menu-item nav-item group flex items-center px-3 py-2 text-slate-700 hover:text-slate-900 hover:bg-gray-100 dark:text-slate-300 dark:hover:text-white dark:hover:bg-slate-800/50 rounded-lg transition-all duration-200"
                    data-page="tax-kir">
                    <div
                        class="w-8 h-8 bg-gray-100 dark:bg-slate-700/50 rounded-lg flex items-center justify-center mr-2 group-hover:bg-orange-500/20 transition-colors">
                        <i
                            class="fas fa-file-alt text-orange-500 dark:text-orange-400 group-hover:text-orange-400 text-sm"></i>
                    </div>
                    <div class="flex-1">
                        <span class="font-medium text-sm">Pajak & KIR</span>
                        <p
                            class="text-xs text-slate-500 dark:text-slate-300 group-hover:text-slate-600 dark:group-hover:text-slate-200">
                            Document</p>
                    </div>
                </a>

                <a href="#"
                    class="menu-item nav-item group flex items-center px-3 py-2 text-slate-700 hover:text-slate-900 hover:bg-gray-100 dark:text-slate-300 dark:hover:text-white dark:hover:bg-slate-800/50 rounded-lg transition-all duration-200"
                    data-page="service">
                    <div
                        class="w-8 h-8 bg-gray-100 dark:bg-slate-700/50 rounded-lg flex items-center justify-center mr-2 group-hover:bg-purple-500/20 transition-colors">
                        <i
                            class="fas fa-wrench text-purple-500 dark:text-purple-400 group-hover:text-purple-400 text-sm"></i>
                    </div>
                    <div class="flex-1">
                        <span class="font-medium text-sm">Service</span>
                        <p
                            class="text-xs text-slate-500 dark:text-slate-300 group-hover:text-slate-600 dark:group-hover:text-slate-200">
                            Maintenance</p>
                    </div>
                </a>

                <a href="#"
                    class="menu-item nav-item group flex items-center px-3 py-2 text-slate-700 hover:text-slate-900 hover:bg-gray-100 dark:text-slate-300 dark:hover:text-white dark:hover:bg-slate-800/50 rounded-lg transition-all duration-200"
                    data-page="schedule">
                    <div
                        class="w-8 h-8 bg-gray-100 dark:bg-slate-700/50 rounded-lg flex items-center justify-center mr-2 group-hover:bg-teal-500/20 transition-colors">
                        <i
                            class="fas fa-calendar text-teal-500 dark:text-teal-400 group-hover:text-teal-400 text-sm"></i>
                    </div>
                    <div class="flex-1">
                        <span class="font-medium text-sm">Jadwal Tarikan</span>
                        <p
                            class="text-xs text-slate-500 dark:text-slate-300 group-hover:text-slate-600 dark:group-hover:text-slate-200">
                            Schedule</p>
                    </div>
                </a>

                <a href="#"
                    class="menu-item nav-item group flex items-center px-3 py-2 text-slate-700 hover:text-slate-900 hover:bg-gray-100 dark:text-slate-300 dark:hover:text-white dark:hover:bg-slate-800/50 rounded-lg transition-all duration-200"
                    data-page="debt">
                    <div
                        class="w-8 h-8 bg-gray-100 dark:bg-slate-700/50 rounded-lg flex items-center justify-center mr-2 group-hover:bg-red-500/20 transition-colors">
                        <i
                            class="fas fa-credit-card text-red-500 dark:text-red-400 group-hover:text-red-400 text-sm"></i>
                    </div>
                    <div class="flex-1">
                        <span class="font-medium text-sm">Kelola Hutang</span>
                        <p
                            class="text-xs text-slate-500 dark:text-slate-300 group-hover:text-slate-600 dark:group-hover:text-slate-200">
                            Debt</p>
                    </div>
                </a>

                <div class="px-2 py-1 mt-4">
                    <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Reports</p>
                </div>

                <a href="#"
                    class="menu-item nav-item group flex items-center px-3 py-2 text-slate-700 hover:text-slate-900 hover:bg-gray-100 dark:text-slate-300 dark:hover:text-white dark:hover:bg-slate-800/50 rounded-lg transition-all duration-200"
                    data-page="reports">
                    <div
                        class="w-8 h-8 bg-gray-100 dark:bg-slate-700/50 rounded-lg flex items-center justify-center mr-2 group-hover:bg-indigo-500/20 transition-colors">
                        <i
                            class="fas fa-chart-bar text-indigo-500 dark:text-indigo-400 group-hover:text-indigo-400 text-sm"></i>
                    </div>
                    <div class="flex-1">
                        <span class="font-medium text-sm">Laporan</span>
                        <p
                            class="text-xs text-slate-500 dark:text-slate-300 group-hover:text-slate-600 dark:group-hover:text-slate-200">
                            Analytics</p>
                    </div>
                </a>
            </div>
        </nav>

        <!-- Bottom Section -->
        <div
            class="absolute bottom-0 left-0 right-0 p-3 border-t border-gray-200 dark:border-slate-700/50 hidden lg:block">
            <div class="flex items-center justify-between text-slate-400 text-xs">
                <span>v2.1.0</span>
                <div class="flex items-center space-x-1">
                    <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                    <span>Online</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="content-transition lg:ml-64">
        <!-- Top Header -->
        <header
            class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 dark-transition relative z-30">
            <div class="flex items-center justify-between px-4 lg:px-6 py-3 lg:py-4">
                <div class="flex items-center space-x-2 lg:space-x-4 min-w-0 flex-1 ml-12 lg:ml-0">
                    <div class="min-w-0 flex-1">
                        <h2 id="pageTitle" class="text-lg lg:text-2xl font-bold text-gray-900 dark:text-white truncate">
                            Dashboard</h2>
                        <p class="text-xs lg:text-sm text-gray-500 dark:text-gray-400 hidden sm:block">Selamat datang di
                            sistem manajemen driver</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2 lg:space-x-3">
                    <!-- Dark Mode Toggle (from indexaspal) -->
                    <button
                        class="bg-gray-100 dark:bg-gray-700 p-2 rounded-lg transition-all duration-300 hover:bg-gray-200 dark:hover:bg-gray-600 group relative z-50"
                        id="dark-mode-toggle" onclick="toggleDarkMode()" title="Beralih Mode">
                        <div class="relative w-5 h-5">
                            <!-- Sun Icon (outline with 8 rays to ensure all visible) -->
                            <svg class="absolute inset-0 w-5 h-5 text-yellow-500 transition-all duration-500 transform rotate-0 scale-100 opacity-100 dark:rotate-180 dark:scale-0 dark:opacity-0"
                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="4"></circle>
                                <line x1="12" y1="2" x2="12" y2="5"></line>
                                <line x1="12" y1="19" x2="12" y2="22"></line>
                                <line x1="4.22" y1="4.22" x2="6.34" y2="6.34"></line>
                                <line x1="17.66" y1="17.66" x2="19.78" y2="19.78"></line>
                                <line x1="2" y1="12" x2="5" y2="12"></line>
                                <line x1="19" y1="12" x2="22" y2="12"></line>
                                <line x1="4.22" y1="19.78" x2="6.34" y2="17.66"></line>
                                <line x1="17.66" y1="6.34" x2="19.78" y2="4.22"></line>
                            </svg>
                            <!-- Moon Icon -->
                            <svg class="absolute inset-0 w-5 h-5 text-blue-600 dark:text-blue-400 transition-all duration-500 transform rotate-180 scale-0 opacity-0 dark:rotate-0 dark:scale-100 dark:opacity-100"
                                fill="currentColor" viewBox="0 0 20 20">
                                <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                            </svg>
                        </div>
                    </button>

                    <!-- Notifications -->
                    <div class="relative">
                        <button id="notificationBtn"
                            class="relative p-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 smooth-hover">
                            <i class="fas fa-bell text-base lg:text-xl"></i>
                            <span id="notificationCount"
                                class="absolute -top-0.5 -right-0.5 lg:-top-1 lg:-right-1 w-3.5 h-3.5 lg:w-4 lg:h-4 bg-red-500 rounded-full flex items-center justify-center notification-badge">
                                <span class="text-xs text-white font-bold" style="font-size: 9px;">3</span>
                            </span>
                        </button>

                        <!-- Notification Dropdown -->
                        <div id="notificationDropdown"
                            class="absolute mt-2 w-[75vw] max-w-sm sm:w-80 bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 z-50 hidden right-0 left-auto">
                            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Notifikasi</h3>
                                    <button id="markAllRead"
                                        class="text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400">Tandai
                                        Semua Dibaca</button>
                                </div>
                            </div>
                            <div id="notificationList" class="max-h-96 overflow-y-auto thin-scrollbar">
                                <!-- Notifications will be populated here -->
                            </div>
                            <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                                <button id="clearAllNotificationsBtn"
                                    class="w-full text-center text-sm text-red-600 hover:text-red-800 dark:text-red-400">Hapus
                                    Semua Notifikasi</button>
                            </div>
                        </div>
                    </div>

                    <!-- User Menu -->
                    <div class="relative">
                        <button id="userMenuBtn"
                            class="flex items-center space-x-2 lg:space-x-2 bg-gray-50 dark:bg-gray-700 rounded-lg px-2 lg:px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 smooth-hover">
                            <div
                                class="w-8 h-8 md:w-9 md:h-9 bg-blue-600 rounded-full aspect-square flex items-center justify-center overflow-hidden">
                                <i class="fas fa-user text-white text-sm md:text-base"></i>
                            </div>
                            <div class="text-left hidden sm:block min-w-0 max-w-[10rem]">
                                <span id="userDisplayNameTop"
                                    class="block text-sm font-semibold text-gray-900 dark:text-white truncate">Admin</span>
                                <p id="userEmailTop" class="text-xs text-gray-500 dark:text-gray-400 truncate">
                                    admin@driverpro.com</p>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400 text-xs lg:text-sm"></i>
                        </button>

                        <!-- User Dropdown -->
                        <div id="userDropdown"
                            class="absolute right-0 mt-2 w-64 sm:w-72 bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 z-50 hidden">
                            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                                <div class="flex items-center space-x-2">
                                    <div
                                        class="w-12 h-12 bg-blue-600 rounded-full aspect-square flex items-center justify-center overflow-hidden">
                                        <i class="fas fa-user text-white text-lg"></i>
                                    </div>
                                    <div class="min-w-0">
                                        <p id="userDisplayNameDrop"
                                            class="font-semibold text-gray-900 dark:text-white leading-snug break-words">
                                            Admin</p>
                                        <p id="userEmailDrop"
                                            class="text-sm text-gray-500 dark:text-gray-400 leading-snug break-words">
                                            admin@driverpro.com</p>
                                    </div>
                                </div>
                            </div>
                            <div class="py-2">
                                <a href="#"
                                    class="flex items-center px-4 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 smooth-hover"
                                    onclick="openUserProfile()">
                                    <i class="fas fa-user-circle text-gray-400 mr-3"></i>
                                    Profil Saya
                                </a>
                                <a href="#"
                                    class="flex items-center px-4 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 smooth-hover"
                                    onclick="openChangePassword()">
                                    <i class="fas fa-key text-gray-400 mr-3"></i>
                                    Ubah Password
                                </a>
                                <a href="#"
                                    class="flex items-center px-4 py-3 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 smooth-hover"
                                    onclick="openAccountSettings()">
                                    <i class="fas fa-cog text-gray-400 mr-3"></i>
                                    Pengaturan Akun
                                </a>
                                <div class="border-t border-gray-200 dark:border-gray-700 my-2"></div>
                                <a href="#"
                                    class="flex items-center px-4 py-3 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 smooth-hover"
                                    onclick="handleLogout()">
                                    <i class="fas fa-sign-out-alt text-red-500 mr-3"></i>
                                    Logout
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <main class="p-6 space-y-4">
            <!-- Dashboard Content -->
            <div id="dashboard-content" class="page-content">
                <!-- Stats Cards -->
                <div class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-8">
                    <div
                        class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-4 md:p-6 text-white card-hover transform hover:scale-105">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm font-medium">Total Supir Aktif</p>
                                <p id="totalDrivers" class="text-3xl font-bold mt-1">0</p>
                            </div>
                            <div
                                class="w-10 h-10 md:w-12 md:h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-users text-white text-xl"></i>
                            </div>
                        </div>
                        <div class="mt-4 flex items-center text-xs md:text-sm flex-wrap">
                            <div class="flex items-center bg-white bg-opacity-20 px-2 py-1 rounded-full">
                                <i class="fas fa-arrow-up text-white text-xs mr-1"></i>
                                <span class="text-white font-medium text-[10px] md:text-sm">+2</span>
                            </div>
                            <span class="text-blue-100 ml-2 text-xs md:text-sm break-words">dari bulan lalu</span>
                        </div>
                    </div>

                    <div
                        class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-4 md:p-6 text-white card-hover transform hover:scale-105">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm font-medium">Kendaraan Aktif</p>
                                <p id="activeVehicles" class="text-3xl font-bold mt-1">0</p>
                            </div>
                            <div
                                class="w-10 h-10 md:w-12 md:h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-truck text-white text-xl"></i>
                            </div>
                        </div>
                        <div class="mt-4 flex items-center text-xs md:text-sm flex-wrap">
                            <div class="flex items-center bg-white bg-opacity-20 px-2 py-1 rounded-full">
                                <i class="fas fa-check text-white text-xs mr-1"></i>
                                <span class="text-white font-medium text-[10px] md:text-sm">100%</span>
                            </div>
                            <span class="text-green-100 ml-2 text-xs md:text-sm break-words">operasional</span>
                        </div>
                    </div>

                    <div
                        class="bg-gradient-to-br from-yellow-500 to-orange-500 rounded-xl shadow-lg p-4 md:p-6 text-white card-hover transform hover:scale-105">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-yellow-100 text-sm font-medium">Jadwal Hari Ini</p>
                                <p id="todaySchedules" class="text-3xl font-bold mt-1">0</p>
                            </div>
                            <div
                                class="w-10 h-10 md:w-12 md:h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-calendar-check text-white text-xl"></i>
                            </div>
                        </div>
                        <div class="mt-4 flex items-center text-xs md:text-sm flex-wrap">
                            <div class="flex items-center bg-white bg-opacity-20 px-2 py-1 rounded-full">
                                <i class="fas fa-clock text-white text-xs mr-1"></i>
                                <span id="completedSchedules"
                                    class="text-white font-medium text-[10px] md:text-sm">0</span>
                            </div>
                            <span class="text-yellow-100 ml-2 text-xs md:text-sm break-words">selesai</span>
                        </div>
                    </div>

                    <div
                        class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-4 md:p-6 text-white card-hover transform hover:scale-105">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100 text-sm font-medium">Pendapatan Bulan Ini</p>
                                <p id="totalRevenue" class="text-2xl md:text-3xl font-bold mt-1">Rp 0</p>
                            </div>
                            <div
                                class="w-10 h-10 md:w-12 md:h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-money-bill-wave text-white text-xl"></i>
                            </div>
                        </div>
                        <div class="mt-4 flex items-center text-xs md:text-sm flex-wrap">
                            <div class="flex items-center bg-white bg-opacity-20 px-2 py-1 rounded-full">
                                <i class="fas fa-trending-up text-white text-xs mr-1"></i>
                                <span class="text-white font-medium text-[10px] md:text-sm">+12%</span>
                            </div>
                            <span class="text-purple-100 ml-2 text-xs md:text-sm break-words">dari target</span>
                        </div>
                    </div>
                </div>

                <!-- Revenue Share Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mb-8">
                    <div
                        class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 md:p-6 border border-gray-100 dark:border-gray-700 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white">Pembagian Pendapatan</h4>
                            <div
                                class="w-10 h-10 bg-indigo-100 dark:bg-indigo-900 rounded-lg flex items-center justify-center">
                                <i class="fas fa-chart-pie text-indigo-600 dark:text-indigo-400"></i>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Supir (60%)</span>
                                <span id="driverShare" class="text-sm font-semibold text-gray-900 dark:text-white">Rp
                                    0</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                <div class="bg-indigo-600 h-2 rounded-full" style="width: 60%"></div>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Perusahaan (40%)</span>
                                <span id="companyShare" class="text-sm font-semibold text-gray-900 dark:text-white">Rp
                                    0</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                <div class="bg-green-600 h-2 rounded-full" style="width: 40%"></div>
                            </div>
                        </div>
                    </div>

                    <div
                        class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 md:p-6 border border-gray-100 dark:border-gray-700 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white">Performa Hari Ini</h4>
                            <div
                                class="w-10 h-10 bg-emerald-100 dark:bg-emerald-900 rounded-lg flex items-center justify-center">
                                <i class="fas fa-tachometer-alt text-emerald-600 dark:text-emerald-400"></i>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Target Bulanan</span>
                                <span class="text-sm font-semibold text-gray-900 dark:text-white">Rp 10,000,000</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Tercapai</span>
                                <span id="todayRevenue"
                                    class="text-sm font-semibold text-emerald-600 dark:text-emerald-400">Rp 0</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                                <div id="progressBar"
                                    class="bg-gradient-to-r from-emerald-500 to-emerald-600 h-3 rounded-full transition-all duration-500"
                                    style="width: 0%"></div>
                            </div>
                            <div class="text-center">
                                <span id="progressPercentage"
                                    class="text-xs font-medium text-gray-500 dark:text-gray-400">0% dari target</span>
                            </div>
                        </div>
                    </div>

                    <div
                        class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 md:p-6 border border-gray-100 dark:border-gray-700 card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white">Statistik Cepat</h4>
                            <div
                                class="w-10 h-10 bg-rose-100 dark:bg-rose-900 rounded-lg flex items-center justify-center">
                                <i class="fas fa-bolt text-rose-600 dark:text-rose-400"></i>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Rata-rata per Trip</span>
                                <span id="avgTripRevenue" class="text-sm font-semibold text-gray-900 dark:text-white">Rp
                                    0</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Trip Terbanyak</span>
                                <span id="topDriverTrips" class="text-sm font-semibold text-gray-900 dark:text-white">0
                                    trip</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Efisiensi Armada</span>
                                <span id="fleetEfficiency"
                                    class="text-sm font-semibold text-emerald-600 dark:text-emerald-400">0%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 mb-8">
                    <!-- Monthly Revenue Chart -->
                    <div
                        class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-4 lg:p-6 card-hover">
                        <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-4 lg:mb-5 gap-3">
                            <div>
                                <h4 class="text-base lg:text-lg font-semibold text-gray-900 dark:text-white">Pendapatan
                                    Bulanan</h4>
                                <p class="text-xs lg:text-sm text-gray-500 dark:text-gray-400">Tren pendapatan 6 bulan
                                    terakhir</p>
                            </div>
                            <div class="flex items-center space-x-2 text-xs">
                                <div class="w-2 h-2 lg:w-3 lg:h-3 bg-blue-500 rounded-full"></div>
                                <span class="text-gray-500 dark:text-gray-400">Total</span>
                                <div class="w-2 h-2 lg:w-3 lg:h-3 bg-green-500 rounded-full ml-2 lg:ml-3"></div>
                                <span class="text-gray-500 dark:text-gray-400">Target</span>
                            </div>
                        </div>
                        <div class="h-64 sm:h-72 lg:h-80">
                            <canvas id="monthlyRevenueChart"></canvas>
                        </div>
                    </div>

                    <!-- Driver Performance Chart -->
                    <div
                        class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-4 lg:p-6 card-hover">
                        <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-4 lg:mb-5 gap-3">
                            <div>
                                <h4 class="text-base lg:text-lg font-semibold text-gray-900 dark:text-white">Performa
                                    Supir</h4>
                                <p class="text-xs lg:text-sm text-gray-500 dark:text-gray-400">Pendapatan per supir
                                    bulan ini</p>
                            </div>
                            <button
                                class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 text-xs lg:text-sm font-medium self-start sm:self-auto">
                                Lihat Detail
                            </button>
                        </div>
                        <div class="h-64 sm:h-72 lg:h-80">
                            <canvas id="driverPerformanceChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Driver Ranking & Live Updates -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 mb-8">
                    <!-- Driver Ranking -->
                    <div
                        class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 card-hover">
                        <div class="p-6 border-b border-gray-100 dark:border-gray-700">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <div
                                        class="w-10 h-10 bg-yellow-100 dark:bg-yellow-900 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-trophy text-yellow-600 dark:text-yellow-400"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Ranking Supir
                                        </h3>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Berdasarkan pendapatan bulan
                                            ini</p>
                                    </div>
                                </div>
                                <select id="rankingPeriod"
                                    class="text-sm border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-1 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <option value="month">Bulan Ini</option>
                                    <option value="week">Minggu Ini</option>
                                    <option value="today">Hari Ini</option>
                                </select>
                            </div>
                        </div>
                        <div id="driverRanking" class="p-6 space-y-4">
                            <!-- Driver ranking will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Jadwal Mendatang -->
                    <div
                        class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 card-hover">
                        <div class="p-6 border-b border-gray-100 dark:border-gray-700">
                            <div class="flex items-center space-x-2">
                                <div
                                    class="w-10 h-10 bg-indigo-100 dark:bg-indigo-900 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-calendar-alt text-indigo-600 dark:text-indigo-400"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Jadwal Mendatang
                                    </h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Jadwal 3 hari ke depan</p>
                                </div>
                            </div>
                        </div>
                        <div id="upcomingSchedules" class="p-6 space-y-3 max-h-96 overflow-y-auto">
                            <!-- Upcoming schedules will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Recent Activities & Reminders -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
                    <div
                        class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 card-hover">
                        <div class="p-6 border-b border-gray-100 dark:border-gray-700">
                            <div class="flex items-center space-x-2">
                                <div
                                    class="w-10 h-10 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-clock text-blue-600 dark:text-blue-400"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Aktivitas Terbaru</h3>
                            </div>
                        </div>
                        <div id="recentActivities" class="p-6 space-y-3 max-h-80 overflow-y-auto">
                            <!-- Activities will be populated by JavaScript -->
                        </div>
                    </div>

                    <div
                        class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 card-hover">
                        <div class="p-6 border-b border-gray-100 dark:border-gray-700">
                            <div class="flex items-center space-x-2">
                                <div
                                    class="w-10 h-10 bg-red-100 dark:bg-red-900 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-bell text-red-600 dark:text-red-400"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Reminder</h3>
                            </div>
                        </div>
                        <div id="reminders" class="p-6 space-y-2">
                            <!-- Reminders will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Drivers Content -->
            <div id="drivers-content" class="page-content hidden">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
                    <div>
                        <h3 class="text-3xl font-bold text-gray-900 dark:text-white">Kelola Supir</h3>
                        <p class="text-gray-600 dark:text-gray-400 mt-1">Manajemen data supir dan kendaraan secara
                            komprehensif</p>
                    </div>
                    <div class="flex items-center space-x-2 self-end sm:self-auto">
                        <button id="addDriverBtn"
                            class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-2 rounded-xl hover:from-blue-700 hover:to-blue-800 smooth-hover flex items-center space-x-2 shadow-lg">
                            <i class="fas fa-plus"></i>
                            <span>Tambah Supir</span>
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 mb-8">
                    <div
                        class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl shadow-lg p-4 md:p-6 text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm font-medium">Total Supir</p>
                                <p id="totalDriversCount" class="text-3xl font-bold mt-1">0</p>
                            </div>
                            <div
                                class="w-10 h-10 md:w-12 md:h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-users text-white text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div
                        class="bg-gradient-to-br from-green-500 to-green-600 rounded-2xl shadow-lg p-4 md:p-6 text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm font-medium">Supir Aktif</p>
                                <p id="activeDriversCount" class="text-3xl font-bold mt-1">0</p>
                            </div>
                            <div
                                class="w-10 h-10 md:w-12 md:h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-user-check text-white text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div
                        class="bg-gradient-to-br from-yellow-500 to-orange-500 rounded-2xl shadow-lg p-4 md:p-6 text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-yellow-100 text-sm font-medium">Dalam Perjalanan</p>
                                <p id="onTripDriversCount" class="text-3xl font-bold mt-1">0</p>
                            </div>
                            <div
                                class="w-10 h-10 md:w-12 md:h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-route text-white text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div
                        class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl shadow-lg p-4 md:p-6 text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100 text-sm font-medium">Performa Terbaik</p>
                                <p id="topDriverName" class="text-lg font-bold mt-1">-</p>
                            </div>
                            <div
                                class="w-10 h-10 md:w-12 md:h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-trophy text-white text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search and Filter -->
                <div
                    class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 p-4 lg:p-6 mb-8">
                    <div class="flex flex-col gap-4">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input type="text" id="searchDriver"
                                placeholder="Cari berdasarkan nama, kendaraan, atau nomor HP..."
                                class="w-full pl-10 pr-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400">
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <select id="filterStatus"
                                class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">Semua Status</option>
                                <option value="aktif">Aktif</option>
                                <option value="nonaktif">Non-Aktif</option>
                            </select>
                            <select id="sortBy"
                                class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="name">Urutkan: Nama</option>
                                <option value="vehicle">Urutkan: Kendaraan</option>
                                <option value="status">Urutkan: Status</option>
                                <option value="joinDate">Urutkan: Tanggal Bergabung</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Drivers Grid/Table Toggle -->
                <div class="flex justify-between items-center mb-5">
                    <div class="flex items-center space-x-3">
                        <span class="text-sm text-gray-600 dark:text-gray-400">Tampilan:</span>
                        <div class="flex bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
                            <button id="gridViewBtn"
                                class="px-3 py-1 rounded-md text-sm font-medium transition-colors bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm">
                                <i class="fas fa-th-large mr-2"></i>Grid
                            </button>
                            <button id="tableViewBtn"
                                class="px-3 py-1 rounded-md text-sm font-medium transition-colors text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">
                                <i class="fas fa-list mr-2"></i>Tabel
                            </button>
                        </div>
                    </div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                        Menampilkan <span id="driversCount">0</span> dari <span id="totalDriversDisplay">0</span> supir
                    </div>
                </div>

                <!-- Drivers Grid View -->
                <div id="driversGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-8">
                    <!-- Grid items will be populated by JavaScript -->
                </div>

                <!-- Drivers Table View -->
                <div id="driversTable"
                    class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                        Supir</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                        Kendaraan</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                        Kontak</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                        Status</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                        Kwitansi</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                        Bergabung</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                        Kwitansi</th>
                                </tr>
                            </thead>
                            <tbody id="driversTableBody"
                                class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tax & KIR Content -->
            <div id="tax-kir-content" class="page-content hidden">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-8 gap-4">
                    <div>
                        <h3 class="text-3xl font-bold text-gray-900 dark:text-white">Pajak & KIR</h3>
                        <p class="text-gray-600 dark:text-gray-400 mt-1">Manajemen dokumen kendaraan dan reminder
                            otomatis</p>
                    </div>
                    <div class="flex flex-wrap items-center gap-2 lg:gap-3 w-full lg:w-auto">
                        <button id="bulkReminderBtn"
                            class="bg-orange-600 text-white px-3 lg:px-4 py-2 rounded-xl hover:bg-orange-700 smooth-hover flex items-center space-x-1 lg:space-x-2 shadow-lg text-sm lg:text-base">
                            <i class="fas fa-bell text-sm lg:text-base"></i>
                            <span class="hidden sm:inline">Kirim Reminder</span>
                            <span class="sm:hidden">Reminder</span>
                        </button>
                        <button id="addDocumentBtn"
                            class="bg-gradient-to-r from-yellow-600 to-orange-600 text-white px-4 lg:px-6 py-2 rounded-xl hover:from-yellow-700 hover:to-orange-700 smooth-hover flex items-center space-x-1 lg:space-x-2 shadow-lg text-sm lg:text-base flex-1 lg:flex-none justify-center">
                            <i class="fas fa-plus text-sm lg:text-base"></i>
                            <span class="hidden sm:inline">Tambah Dokumen</span>
                            <span class="sm:hidden">Tambah</span>
                        </button>
                    </div>
                </div>

                <!-- Document Status Cards -->
                <div class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-8">
                    <div
                        class="bg-gradient-to-br from-red-500 to-red-600 rounded-2xl shadow-lg p-4 md:p-6 text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-red-100 text-sm font-medium">Akan Berakhir</p>
                                <p id="expiringDocs" class="text-3xl font-bold mt-1">0</p>
                                <p class="text-red-200 text-xs mt-1">&plusmn; 30 hari</p>
                            </div>
                            <div
                                class="w-10 h-10 md:w-12 md:h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-exclamation-triangle text-white text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div
                        class="bg-gradient-to-br from-green-500 to-green-600 rounded-2xl shadow-lg p-4 md:p-6 text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm font-medium">Aktif</p>
                                <p id="activeDocs" class="text-3xl font-bold mt-1">0</p>
                                <p class="text-green-200 text-xs mt-1">Masih berlaku</p>
                            </div>
                            <div
                                class="w-10 h-10 md:w-12 md:h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-check-circle text-white text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div
                        class="bg-gradient-to-br from-gray-500 to-gray-600 rounded-2xl shadow-lg p-4 md:p-6 text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-100 text-sm font-medium">Berakhir</p>
                                <p id="expiredDocs" class="text-3xl font-bold mt-1">0</p>
                                <p class="text-gray-200 text-xs mt-1">Perlu diperpanjang</p>
                            </div>
                            <div
                                class="w-10 h-10 md:w-12 md:h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-times-circle text-white text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div
                        class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl shadow-lg p-4 md:p-6 text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm font-medium">Total Dokumen</p>
                                <p id="totalDocs" class="text-3xl font-bold mt-1">0</p>
                                <p class="text-blue-200 text-xs mt-1">Semua jenis</p>
                            </div>
                            <div
                                class="w-10 h-10 md:w-12 md:h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-file-alt text-white text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filter and Search -->
                <div
                    class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 p-4 lg:p-6 mb-8">
                    <div class="flex flex-col gap-4">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input type="text" id="searchDocument"
                                placeholder="Cari berdasarkan kendaraan atau jenis dokumen..."
                                class="w-full pl-10 pr-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400">
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                            <select id="filterDocumentType"
                                class="px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">Semua Jenis</option>
                                <option value="STNK">STNK</option>
                                <option value="KIR">KIR</option>
                                <option value="Pajak">Pajak</option>
                                <option value="Asuransi">Asuransi</option>
                            </select>
                            <select id="filterDocumentStatus"
                                class="px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">Semua Status</option>
                                <option value="aktif">Aktif</option>
                                <option value="akan berakhir">Akan Berakhir</option>
                                <option value="berakhir">Berakhir</option>
                            </select>
                            <select id="sortDocuments"
                                class="px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="expiry">Urutkan: Tanggal Berakhir</option>
                                <option value="vehicle">Urutkan: Kendaraan</option>
                                <option value="type">Urutkan: Jenis</option>
                                <option value="status">Urutkan: Status</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Documents Grid/Table Toggle -->
                <div class="flex justify-between items-center mb-5">
                    <div class="flex items-center space-x-3">
                        <span class="text-sm text-gray-600 dark:text-gray-400">Tampilan:</span>
                        <div class="flex bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
                            <button id="documentsGridViewBtn"
                                class="px-3 py-1 rounded-md text-sm font-medium transition-colors bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm">
                                <i class="fas fa-th-large mr-2"></i>Grid
                            </button>
                            <button id="documentsTableViewBtn"
                                class="px-3 py-1 rounded-md text-sm font-medium transition-colors text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">
                                <i class="fas fa-list mr-2"></i>Tabel
                            </button>
                        </div>
                    </div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                        Menampilkan <span id="documentsCount">0</span> dari <span id="totalDocumentsDisplay">0</span>
                        dokumen
                    </div>
                </div>

                <!-- Documents Grid -->
                <div id="documentsGrid"
                    class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5 mb-8">
                    <!-- Grid items will be populated by JavaScript -->
                </div>

                <!-- Documents Table -->
                <div id="documentsTable"
                    class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden hidden dark-transition">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                        Kendaraan</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                        Jenis Dokumen</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                        Tanggal Berakhir</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                        Sisa Hari</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                        Status</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                        Kwitansi</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                        Kwitansi</th>
                                </tr>
                            </thead>
                            <tbody id="documentsTableBody"
                                class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Service Content -->
            <div id="service-content" class="page-content hidden">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-8 gap-4">
                    <div>
                        <h3 class="text-3xl font-bold text-gray-900 dark:text-white">Service Kendaraan</h3>
                        <p class="text-gray-600 dark:text-gray-400 mt-1">Manajemen jadwal service dan maintenance
                            kendaraan</p>
                    </div>
                    <div class="flex flex-wrap items-center gap-2 lg:gap-3 w-full lg:w-auto">
                        <button id="addServiceBtn"
                            class="bg-gradient-to-r from-purple-600 to-purple-700 text-white px-4 lg:px-6 py-2 rounded-xl hover:from-purple-700 hover:to-purple-800 smooth-hover flex items-center space-x-1 lg:space-x-2 shadow-lg text-sm lg:text-base flex-1 lg:flex-none justify-center">
                            <i class="fas fa-plus text-sm lg:text-base"></i>
                            <span class="hidden sm:inline">Jadwalkan Service</span>
                            <span class="sm:hidden">Tambah</span>
                        </button>
                        <button id="viewServiceHistoryBtn"
                            class="bg-gradient-to-r from-green-600 to-green-700 text-white px-4 lg:px-6 py-2 rounded-xl hover:from-green-700 hover:to-green-800 smooth-hover flex items-center space-x-2 shadow-lg text-sm lg:text-base flex-1 lg:flex-none justify-center">
                            <i class="fas fa-history"></i>
                            <span>History</span>
                        </button>
                    </div>
                </div>

                <!-- Service Status Cards -->
                <div class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-8">
                    <div
                        class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl shadow-lg p-4 md:p-6 text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm font-medium">Terjadwal</p>
                                <p id="scheduledServices" class="text-2xl md:text-3xl font-bold mt-1">0</p>
                                <p class="text-blue-200 text-xs mt-1">Service mendatang</p>
                            </div>
                            <div
                                class="w-10 h-10 md:w-12 md:h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-calendar text-white text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div
                        class="bg-gradient-to-br from-yellow-500 to-orange-500 rounded-2xl shadow-lg p-4 md:p-6 text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-yellow-100 text-sm font-medium">Dalam Proses</p>
                                <p id="inProgressServices" class="text-2xl md:text-3xl font-bold mt-1">0</p>
                                <p class="text-yellow-200 text-xs mt-1">Sedang dikerjakan</p>
                            </div>
                            <div
                                class="w-10 h-10 md:w-12 md:h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-wrench text-white text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div
                        class="bg-gradient-to-br from-green-500 to-green-600 rounded-2xl shadow-lg p-4 md:p-6 text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm font-medium">Selesai</p>
                                <p id="completedServices" class="text-2xl md:text-3xl font-bold mt-1">0</p>
                                <p class="text-green-200 text-xs mt-1">Bulan ini</p>
                            </div>
                            <div
                                class="w-10 h-10 md:w-12 md:h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-check-circle text-white text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div
                        class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl shadow-lg p-4 md:p-6 text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100 text-sm font-medium">Total Biaya</p>
                                <p id="totalServiceCost" class="text-2xl md:text-3xl font-bold mt-1">Rp 0</p>
                                <p class="text-purple-200 text-xs mt-1">Bulan ini</p>
                            </div>
                            <div
                                class="w-10 h-10 md:w-12 md:h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-money-bill-wave text-white text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filter and Search -->
                <div
                    class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 p-4 lg:p-6 mb-8">
                    <div class="flex flex-col gap-4">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input type="text" id="searchService" placeholder="Cari berdasarkan kendaraan atau supir..."
                                class="w-full pl-10 pr-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400">
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                            <select id="filterDriverVehicle"
                                class="px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">Semua Kendaraan / Supir</option>
                            </select>
                            <select id="filterServiceStatus"
                                class="px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">Semua Status</option>
                                <option value="terjadwal">Terjadwal</option>
                                <option value="dalam proses">Dalam Proses</option>
                                <option value="selesai">Selesai</option>
                                <option value="dibatalkan">Dibatalkan</option>
                            </select>
                            <input type="month" id="filterServiceMonth"
                                class="px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <select id="sortServices"
                                class="px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="date">Urutkan: Tanggal</option>
                                <option value="vehicle">Urutkan: Kendaraan</option>
                                <option value="type">Urutkan: Jenis</option>
                                <option value="cost">Urutkan: Biaya</option>
                                <option value="status">Urutkan: Status</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Services Grid/Table Toggle -->
                <div class="flex justify-between items-center mb-5">
                    <div class="flex items-center space-x-3">
                        <span class="text-sm text-gray-600 dark:text-gray-400">Tampilan:</span>
                        <div class="flex bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
                            <button id="servicesGridViewBtn"
                                class="px-3 py-1 rounded-md text-sm font-medium transition-colors bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm">
                                <i class="fas fa-th-large mr-2"></i>Grid
                            </button>
                            <button id="servicesTableViewBtn"
                                class="px-3 py-1 rounded-md text-sm font-medium transition-colors text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">
                                <i class="fas fa-list mr-2"></i>Tabel
                            </button>
                        </div>
                    </div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                        Menampilkan <span id="servicesCount">0</span> dari <span id="totalServicesDisplay">0</span>
                        service
                    </div>
                </div>

                <!-- Services Grid -->
                <div id="servicesGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5 mb-8">
                    <!-- Grid items will be populated by JavaScript -->
                </div>

                <!-- Services Table -->
                <div id="servicesTable"
                    class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden hidden dark-transition">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                        Kendaraan</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                        Jenis Service</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                        Tanggal</th>

                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                        Biaya</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                        Status</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                        Kwitansi</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                        Kwitansi</th>
                                </tr>
                            </thead>
                            <tbody id="servicesTableBody"
                                class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Table rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Schedule Content -->
            <div id="schedule-content" class="page-content hidden">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-8 gap-4">
                    <div>
                        <h3 class="text-3xl font-bold text-gray-900 dark:text-white">Jadwal Tarikan</h3>
                        <p class="text-gray-600 dark:text-gray-400 mt-1">Manajemen jadwal tarikan dan monitoring
                            perjalanan</p>
                    </div>
                    <div class="flex flex-wrap items-center gap-2 lg:gap-3 w-full lg:w-auto">
                        <button id="addScheduleBtn"
                            class="bg-gradient-to-r from-indigo-600 to-indigo-700 text-white px-4 lg:px-6 py-2 rounded-xl hover:from-indigo-700 hover:to-indigo-800 smooth-hover flex items-center space-x-1 lg:space-x-2 shadow-lg text-sm lg:text-base flex-1 lg:flex-none justify-center">
                            <i class="fas fa-plus text-sm lg:text-base"></i>
                            <span class="hidden sm:inline">Tambah Jadwal</span>
                            <span class="sm:hidden">Tambah</span>
                        </button>
                        <button id="openHistoryBtn"
                            class="bg-gradient-to-r from-emerald-600 to-emerald-700 text-white px-4 lg:px-6 py-2 rounded-xl hover:from-emerald-700 hover:to-emerald-800 smooth-hover flex items-center space-x-2 shadow-lg text-sm lg:text-base flex-1 lg:flex-none justify-center">
                            <i class="fas fa-history"></i>
                            <span class="hidden sm:inline">History Tarikan</span>
                            <span class="sm:hidden">History</span>
                        </button>
                    </div>
                </div>

                <!-- Schedule Stats Cards -->
                <div class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-8">
                    <div
                        class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl shadow-lg p-4 md:p-6 text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm font-medium">Hari Ini</p>
                                <p id="todaySchedulesCount" class="text-2xl md:text-3xl font-bold mt-1">0</p>
                                <p class="text-blue-200 text-xs mt-1">Total jadwal</p>
                            </div>
                            <div
                                class="w-10 h-10 md:w-12 md:h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-calendar-day text-white text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div
                        class="bg-gradient-to-br from-yellow-500 to-orange-500 rounded-2xl shadow-lg p-4 md:p-6 text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-yellow-100 text-sm font-medium">Nunggak</p>
                                <p id="onTripSchedulesCount" class="text-2xl md:text-3xl font-bold mt-1">0</p>
                                <p class="text-yellow-200 text-xs mt-1">Belum dibayar</p>
                            </div>
                            <div
                                class="w-10 h-10 md:w-12 md:h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-truck-moving text-white text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div
                        class="bg-gradient-to-br from-green-500 to-green-600 rounded-2xl shadow-lg p-4 md:p-6 text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm font-medium">Lunas Hari Ini</p>
                                <p id="completedTodayCount" class="text-2xl md:text-3xl font-bold mt-1">0</p>
                                <p class="text-green-200 text-xs mt-1">Trip lunas</p>
                            </div>
                            <div
                                class="w-10 h-10 md:w-12 md:h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-check-circle text-white text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div
                        class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl shadow-lg p-4 md:p-6 text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100 text-sm font-medium">Pendapatan Hari Ini</p>
                                <p id="todayEarnings" class="text-2xl md:text-3xl font-bold mt-1">Rp 0</p>
                                <p class="text-purple-200 text-xs mt-1">Total setoran</p>
                            </div>
                            <div
                                class="w-10 h-10 md:w-12 md:h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-money-bill-wave text-white text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filter and Search -->
                <div
                    class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 p-4 lg:p-6 mb-8">
                    <div class="flex flex-col gap-4">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input type="text" id="searchSchedule"
                                placeholder="Cari berdasarkan supir, lokasi, atau RIT..."
                                class="w-full pl-10 pr-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400">
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                            <select id="filterScheduleDriver"
                                class="px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">Semua Supir</option>
                            </select>
                            <select id="filterOrderType"
                                class="px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">Semua Tipe</option>
                                <option value="online">Online</option>
                                <option value="offline">Offline</option>
                            </select>
                            <input type="date" id="filterScheduleDateStart"
                                class="px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                placeholder="Tanggal Mulai">
                            <input type="date" id="filterScheduleDateEnd"
                                class="px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                placeholder="Tanggal Selesai">
                        </div>
                        <div class="mt-2 text-sm flex justify-end">
                            <span
                                class="px-3 py-1 rounded-lg bg-gray-100 dark:bg-gray-700 text-green-700 dark:text-green-300">Total
                                Tunggakan: <span id="totalOutstanding">Rp 0</span></span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-6">
                    <!-- Schedule List -->
                    <div class="col-span-1">
                        <div
                            class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                            <div class="p-6 border-b border-gray-100 dark:border-gray-700">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white">Jadwal Tarikan
                                        </h4>
                                        <p id="selectedDate" class="text-sm text-gray-500 dark:text-gray-400"></p>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <span class="text-sm text-gray-600 dark:text-gray-400">Tampilan:</span>
                                        <div class="flex bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
                                            <button id="schedulesGridViewBtn"
                                                class="px-3 py-1 rounded-md text-sm font-medium transition-colors bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm">
                                                <i class="fas fa-th-large mr-2"></i>Grid
                                            </button>
                                            <button id="schedulesTableViewBtn"
                                                class="px-3 py-1 rounded-md text-sm font-medium transition-colors text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">
                                                <i class="fas fa-list mr-2"></i>Tabel
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Schedules Grid -->
                            <div id="schedulesGrid"
                                class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5 md:gap-6 p-4">
                                <!-- Schedule items will be populated by JavaScript -->
                            </div>

                            <!-- Schedules Table -->
                            <div id="schedulesTable" class="hidden">
                                <div class="overflow-x-auto">
                                    <table class="w-full">
                                        <thead class="bg-gray-50 dark:bg-gray-700">
                                            <tr>
                                                <th
                                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                                    Supir</th>
                                                <th
                                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                                    Tanggal</th>
                                                <th
                                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                                    Lokasi Muat</th>
                                                <th
                                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                                    Lokasi Bongkar</th>
                                                <th
                                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                                    RIT</th>
                                                <th
                                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                                    Tipe</th>
                                                <th
                                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                                    Argo</th>
                                                <th
                                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                                    Setoran</th>
                                                <th
                                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                                    Status</th>
                                                <th
                                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                                    Kwitansi</th>
                                                <th
                                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                                    Kwitansi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="schedulesTableBody"
                                            class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                            <!-- Table rows will be populated by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Debt Management Content -->
            <div id="debt-content" class="page-content hidden">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-5 gap-4">
                    <div>
                        <h3 class="text-3xl font-bold text-gray-900 dark:text-white">Kelola Hutang</h3>
                        <p class="text-gray-600 dark:text-gray-400 mt-1">Daftar jadwal dengan status nunggak dan
                            pembayaran</p>
                    </div>
                    <div class="flex flex-wrap items-center gap-2 lg:gap-3 w-full lg:w-auto">
                        <button id="addDebtBtn"
                            class="bg-gradient-to-r from-amber-500 to-amber-600 text-white px-4 lg:px-6 py-2 rounded-xl hover:from-amber-600 hover:to-amber-700 smooth-hover flex items-center space-x-2 shadow-lg text-sm lg:text-base flex-1 lg:flex-none justify-center">
                            <i class="fas fa-plus"></i>
                            <span class="hidden sm:inline">Tambah Hutang</span>
                            <span class="sm:hidden">Tambah</span>
                        </button>
                        <button id="openDebtHistoryBtn"
                            class="bg-gradient-to-r from-emerald-600 to-emerald-700 text-white px-4 lg:px-6 py-2 rounded-xl hover:from-emerald-700 hover:to-emerald-800 smooth-hover flex items-center space-x-2 shadow-lg text-sm lg:text-base flex-1 lg:flex-none justify-center">
                            <i class="fas fa-history"></i>
                            <span class="hidden sm:inline">History Hutang</span>
                            <span class="sm:hidden">History</span>
                        </button>
                    </div>
                </div>

                <div
                    class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 p-4 lg:p-6 mb-5">
                    <div class="flex flex-col gap-4">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input type="text" id="searchDebt" placeholder="Cari supir/lokasi/RIT..."
                                class="w-full pl-10 pr-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400">
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                            <select id="filterDebtDriver"
                                class="px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">Semua Supir</option>
                            </select>
                            <input type="date" id="filterDebtDate"
                                class="px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <select id="sortDebts"
                                class="px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="date">Urutkan: Tanggal</option>
                                <option value="driver">Urutkan: Supir</option>
                                <option value="outstanding">Urutkan: Sisa Terbesar</option>
                            </select>
                            <div class="flex items-center justify-end">
                                <span
                                    class="px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700 text-amber-700 dark:text-amber-300">Total
                                    Hutang: <span id="debtTotalOutstanding">Rp 0</span></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div
                    class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                    <div class="p-5 space-y-5">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="text-lg font-semibold text-gray-900 dark:text-white">Daftar Hutang Aktif</h4>
                                <!-- <p class="text-sm text-gray-500 dark:text-gray-400">Pantau pembayaran dan sisa hutang supir</p> -->
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full" id="debtsTable">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                            Supir</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                            Tanggal</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                            Keterangan</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                            Jumlah</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                            Terbayar</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                            Sisa</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                            Status</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                            Aksi</th>

                                    </tr>
                                </thead>
                                <tbody id="debtsTableBody"
                                    class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                    <!-- Rows rendered by JS -->
                                </tbody>
                            </table>
                        </div>
                        <div id="debtPagination" class="flex items-center gap-2 justify-end hidden mt-4">
                            <div class="text-sm text-gray-600 dark:text-gray-400 hidden sm:block">
                                Menampilkan <span id="debtPageRange">0-0</span> dari <span id="debtTotal">0</span>
                            </div>
                            <button id="debtPrevPage" type="button"
                                class="px-3 py-1 rounded-lg border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">Prev</button>
                            <span id="debtPageInfo" class="text-sm text-gray-600 dark:text-gray-400">1/1</span>
                            <button id="debtNextPage" type="button"
                                class="px-3 py-1 rounded-lg border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Content -->
            <div id="reports-content" class="page-content hidden">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
                    <div class="min-w-0">
                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Laporan</h3>
                        <p class="text-gray-600 dark:text-gray-400">Analisis dan laporan sistem</p>
                    </div>
                    <div class="flex flex-wrap items-center gap-3 sm:gap-4 w-full sm:w-auto">
                        <select id="reportPeriod"
                            class="w-full sm:w-auto px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="7">7 Hari Terakhir</option>
                            <option value="30">30 Hari Terakhir</option>
                            <option value="90">3 Bulan Terakhir</option>
                        </select>
                        <button id="exportReport"
                            class="w-full sm:w-auto bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 smooth-hover flex items-center justify-center sm:justify-start gap-2">
                            <i class="fas fa-download"></i>
                            <span>Export</span>
                        </button>
                    </div>
                </div>

                <!-- Export Filters -->
                <div
                    class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-4 mb-5">
                    <div class="flex flex-wrap items-center gap-4">
                        <div class="flex items-center gap-2 w-full sm:w-auto">
                            <label for="expDataTypes" class="text-sm font-medium text-gray-700 dark:text-gray-300">Pilih
                                data:</label>
                            <select id="expDataTypes"
                                class="w-full sm:w-auto px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm min-w-[220px]">
                                <option value="drivers" selected>Data Supir</option>
                                <option value="documents">Data Pajak & KIR</option>
                                <option value="serviceHistory">History Service</option>
                                <option value="tripsPerDriver">Tarikan per Supir</option>
                                <option value="debts">Data Hutang</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2 w-full sm:w-auto sm:ml-auto">
                            <label for="expDriverFilter" class="text-sm text-gray-700 dark:text-gray-300">Filter
                                Supir:</label>
                            <select id="expDriverFilter"
                                class="w-full sm:w-auto px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm min-w-[200px]">
                                <option value="">Semua Supir</option>
                            </select>
                        </div>
                    </div>

                </div>

                <!-- Report Cards -->
                <div class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-5">
                    <div
                        class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-4 md:p-6 text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-white/80">Total Tarikan</p>
                                <p id="reportTotalTrips" class="text-2xl font-bold mt-1">0</p>
                            </div>
                            <div class="w-10 h-10 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-route text-white"></i>
                            </div>
                        </div>
                    </div>
                    <div
                        class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-4 md:p-6 text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-white/80">Pendapatan</p>
                                <p id="reportRevenue" class="text-2xl font-bold mt-1">Rp 0</p>
                            </div>
                            <div class="w-10 h-10 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-money-bill-wave text-white"></i>
                            </div>
                        </div>
                    </div>
                    <div
                        class="bg-gradient-to-br from-red-500 to-red-600 rounded-xl shadow-lg p-4 md:p-6 text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-white/80">Biaya Service</p>
                                <p id="reportServiceCost" class="text-2xl font-bold mt-1">Rp 0</p>
                            </div>
                            <div class="w-10 h-10 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-wrench text-white"></i>
                            </div>
                        </div>
                    </div>
                    <div
                        class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-4 md:p-6 text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-white/80">Profit</p>
                                <p id="reportProfit" class="text-2xl font-bold mt-1">Rp 0</p>
                            </div>
                            <div class="w-10 h-10 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-chart-line text-white"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Pendapatan Harian</h4>
                        <div style="height: 250px;">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Status Kendaraan</h4>
                        <div style="height: 250px;">
                            <canvas id="vehicleStatusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Content -->
            <div id="settings-content" class="page-content hidden">
                <div class="max-w-4xl">
                    <div class="flex justify-between items-center mb-5">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-900">Pengaturan</h3>
                            <p class="text-gray-600">Konfigurasi sistem dan preferensi</p>
                        </div>
                        <button id="saveSettings"
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 smooth-hover flex items-center space-x-2">
                            <i class="fas fa-save"></i>
                            <span>Simpan Pengaturan</span>
                        </button>
                    </div>

                    <div class="space-y-6">
                        <!-- General Settings -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">Pengaturan Umum</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Perusahaan</label>
                                    <input type="text" id="companyName"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        value="DriverPro Transport">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email Perusahaan</label>
                                    <input type="email" id="companyEmail"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        value="admin@driverpro.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nomor Telepon</label>
                                    <input type="tel" id="companyPhone"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        value="+62 21 1234 5678">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Alamat</label>
                                    <input type="text" id="companyAddress"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        value="Jakarta, Indonesia">
                                </div>
                            </div>
                        </div>

                        <!-- Notification Settings -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">Pengaturan Notifikasi</h4>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-900">Notifikasi Email</p>
                                        <p class="text-sm text-gray-500">Terima notifikasi melalui email</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="emailNotifications" class="sr-only peer" checked>
                                        <div
                                            class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                                        </div>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-900">Reminder Dokumen</p>
                                        <p class="text-sm text-gray-500">Pengingat dokumen yang akan berakhir</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="documentReminders" class="sr-only peer" checked>
                                        <div
                                            class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                                        </div>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-900">Notifikasi Service</p>
                                        <p class="text-sm text-gray-500">Pengingat jadwal service kendaraan</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="serviceNotifications" class="sr-only peer" checked>
                                        <div
                                            class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- System Settings -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">Pengaturan Sistem</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Zona Waktu</label>
                                    <select id="timezone"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="Asia/Jakarta">WIB (UTC+7)</option>
                                        <option value="Asia/Makassar">WITA (UTC+8)</option>
                                        <option value="Asia/Jayapura">WIT (UTC+9)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Format Tanggal</label>
                                    <select id="dateFormat"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                        <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                        <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Mata Uang</label>
                                    <select id="currency"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="IDR">Rupiah (IDR)</option>
                                        <option value="USD">US Dollar (USD)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Bahasa</label>
                                    <select id="language"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="id">Bahasa Indonesia</option>
                                        <option value="en">English</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Add Driver Modal -->
    <div id="addDriverModal"
        class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div
            class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto modal fade-in">
            <div class="p-6 border-b border-gray-100 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900 rounded-xl flex items-center justify-center">
                            <i class="fas fa-user-plus text-blue-600 dark:text-blue-400"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white">Tambah Supir Baru</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Lengkapi informasi supir dan kendaraan
                            </p>
                        </div>
                    </div>
                    <button
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 close-modal p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
            </div>
            <form id="addDriverForm" class="p-6 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Personal Information -->
                    <div class="space-y-2">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <i class="fas fa-user text-blue-600 dark:text-blue-400 mr-2"></i>
                            Informasi Personal
                        </h4>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nama Lengkap
                                *</label>
                            <input type="text" name="name" required
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
                                placeholder="Masukkan nama lengkap">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nomor HP
                                *</label>
                            <input type="tel" name="phone" required
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
                                placeholder="08xxxxxxxxxx">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email</label>
                            <input type="email" name="email"
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
                                placeholder="email@example.com">
                        </div>
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Alamat</label>
                            <textarea name="address" rows="3"
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
                                placeholder="Alamat lengkap"></textarea>
                        </div>
                    </div>

                    <!-- Vehicle Information -->
                    <div class="space-y-2">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <i class="fas fa-truck text-green-600 dark:text-green-400 mr-2"></i>
                            Informasi Kendaraan
                        </h4>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nomor
                                Kendaraan *</label>
                            <input type="text" name="vehicle" required
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
                                placeholder="B 1234 CD">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Jenis
                                Kendaraan</label>
                            <select name="vehicleType"
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="CDE">CDE</option>
                                <option value="CDD">CDD</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tahun
                                Kendaraan</label>
                            <input type="number" name="vehicleYear" min="1990" max="2024"
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
                                placeholder="2020">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Status
                                *</label>
                            <select name="status"
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="aktif">Aktif</option>
                                <option value="nonaktif">Non-Aktif</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tanggal
                                Bergabung</label>
                            <input type="date" name="joinDate"
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-2 pt-6 border-t border-gray-200 dark:border-gray-700 mt-6">
                    <button type="button"
                        class="px-6 py-3 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 close-modal font-medium">Batal</button>
                    <button type="submit"
                        class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-8 py-3 rounded-xl hover:from-blue-700 hover:to-blue-800 smooth-hover font-medium shadow-lg">
                        <i class="fas fa-save mr-2"></i>Simpan Supir
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Document Modal -->
    <div id="addDocumentModal"
        class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div
            class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto modal fade-in">
            <div class="p-6 border-b border-gray-100 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <div
                            class="w-10 h-10 bg-yellow-100 dark:bg-yellow-900 rounded-xl flex items-center justify-center">
                            <i class="fas fa-file-invoice text-yellow-600 dark:text-yellow-400"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white">Tambah Dokumen Baru</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Lengkapi informasi dokumen kendaraan</p>
                        </div>
                    </div>
                    <button
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 close-modal p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
            </div>
            <form id="addDocumentForm" class="p-6 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Document Information -->
                    <div class="space-y-2">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <i class="fas fa-file-contract text-yellow-600 dark:text-yellow-400 mr-2"></i>
                            Informasi Dokumen
                        </h4>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nomor
                                Kendaraan *</label>
                            <select name="vehicle" required
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">Pilih Kendaraan</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Jenis Dokumen
                                *</label>
                            <select name="type" required
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">Pilih Jenis Dokumen</option>
                                <option value="STNK">STNK (Surat Tanda Nomor Kendaraan)</option>
                                <option value="KIR">KIR (Kelaikan Jalan)</option>
                                <option value="Pajak">Pajak Kendaraan</option>
                                <option value="Asuransi">Asuransi Kendaraan</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nomor
                                Dokumen</label>
                            <input type="text" name="documentNumber"
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
                                placeholder="Nomor dokumen">
                        </div>
                    </div>

                    <!-- Date Information -->
                    <div class="space-y-2">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <i class="fas fa-calendar-check text-red-600 dark:text-red-400 mr-2"></i>
                            Informasi Tanggal
                        </h4>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tanggal
                                Terbit</label>
                            <input type="date" name="issueDate"
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tanggal
                                Berakhir *</label>
                            <input type="date" name="expiry" required
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Reminder
                                (hari sebelum berakhir)</label>
                            <select name="reminderDays"
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="7">7 hari sebelum</option>
                                <option value="14">14 hari sebelum</option>
                                <option value="30" selected>30 hari sebelum</option>
                                <option value="60">60 hari sebelum</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Biaya
                                Perpanjangan</label>
                            <input type="number" name="renewalCost"
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
                                placeholder="0">
                        </div>
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Catatan</label>
                            <textarea name="notes" rows="3"
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
                                placeholder="Catatan tambahan"></textarea>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-2 pt-6 border-t border-gray-200 dark:border-gray-700 mt-6">
                    <button type="button"
                        class="px-6 py-3 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 close-modal font-medium">Batal</button>
                    <button type="submit"
                        class="bg-gradient-to-r from-yellow-600 to-orange-600 text-white px-8 py-3 rounded-xl hover:from-yellow-700 hover:to-orange-700 smooth-hover font-medium shadow-lg">
                        <i class="fas fa-save mr-2"></i>Simpan Dokumen
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Service Modal -->
    <div id="addServiceModal"
        class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div
            class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto modal fade-in">
            <div class="p-6 border-b border-gray-100 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <div
                            class="w-10 h-10 bg-purple-100 dark:bg-purple-900 rounded-xl flex items-center justify-center">
                            <i class="fas fa-wrench text-purple-600 dark:text-purple-400"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white">Jadwalkan Service</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Lengkapi informasi service kendaraan</p>
                        </div>
                    </div>
                    <button
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 close-modal p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
            </div>
            <form id="addServiceForm" class="p-6 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Service Information -->
                    <div class="space-y-2">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <i class="fas fa-cog text-purple-600 dark:text-purple-400 mr-2"></i>
                            Informasi Service
                        </h4>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nomor
                                Kendaraan *</label>
                            <select name="vehicle" required
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">Pilih Kendaraan</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Jenis Service
                                *</label>
                            <select name="type" required
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">Pilih Jenis Service</option>
                                <option value="Service Rutin">Service Rutin</option>
                                <option value="Ganti Oli">Ganti Oli</option>
                                <option value="Perbaikan">Perbaikan</option>
                                <option value="Tune Up">Tune Up</option>
                                <option value="Ganti Ban">Ganti Ban</option>
                                <option value="Rem">Service Rem</option>
                                <option value="AC">Service AC</option>
                                <option value="Transmisi">Service Transmisi</option>
                            </select>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mt-3 mb-2">Jenis
                                Service Lainnya (opsional)</label>
                            <input type="text" name="customType"
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
                                placeholder="Contoh: Kampas Rem, Shockbreaker">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tanggal
                                Service *</label>
                            <input type="date" name="date" required
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>

                    </div>

                    <!-- Workshop & Cost Information -->
                    <div class="space-y-2">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <i class="fas fa-store text-orange-600 dark:text-orange-400 mr-2"></i>
                            Bengkel & Biaya
                        </h4>
                        <div id="serviceReceiptGroup" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Upload
                                Kwitansi</label>
                            <input type="file" name="receipt" accept="image/*,application/pdf"
                                class="w-full px-4 py-3 border border-dashed border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Format: PDF, JPG, atau PNG (maks
                                2MB)</p>
                            <div id="serviceReceiptPreview" class="mt-3 hidden">
                                <p class="text-xs text-gray-500 dark:text-gray-400">Kwitansi saat ini:</p>
                                <div id="serviceReceiptPreviewContent" class="mt-2"></div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Estimasi
                                Biaya *</label>
                            <input type="number" name="cost" required
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
                                placeholder="500000">
                        </div>
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Prioritas</label>
                            <select name="priority"
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="normal">Normal</option>
                                <option value="tinggi">Tinggi</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Catatan</label>
                            <textarea name="notes" rows="3"
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
                                placeholder="Catatan tambahan"></textarea>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-2 pt-6 border-t border-gray-200 dark:border-gray-700 mt-6">
                    <button type="button"
                        class="px-6 py-3 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 close-modal font-medium">Batal</button>
                    <button type="submit"
                        class="bg-gradient-to-r from-purple-600 to-purple-700 text-white px-8 py-3 rounded-xl hover:from-purple-700 hover:to-purple-800 smooth-hover font-medium shadow-lg">
                        <i class="fas fa-save mr-2"></i>Jadwalkan Service
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Schedule Modal -->
    <div id="addScheduleModal"
        class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div
            class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto modal fade-in">
            <div class="p-6 border-b border-gray-100 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <div
                            class="w-10 h-10 bg-indigo-100 dark:bg-indigo-900 rounded-xl flex items-center justify-center">
                            <i class="fas fa-calendar-plus text-indigo-600 dark:text-indigo-400"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white">Tambah Jadwal Tarikan</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Lengkapi informasi jadwal tarikan baru
                            </p>
                        </div>
                    </div>
                    <button
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 close-modal p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
            </div>
            <form id="addScheduleForm" class="p-6 space-y-4">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Driver & Schedule Information -->
                    <div class="space-y-2">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <i class="fas fa-user-tie text-indigo-600 dark:text-indigo-400 mr-2"></i>
                            Informasi Supir & Jadwal
                        </h4>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Supir
                                *</label>
                            <select name="driver" required
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">Pilih Supir</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tanggal
                                *</label>
                            <input type="date" name="date" required
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">RIT *</label>
                            <input type="text" name="rit" required
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
                                placeholder="Contoh: RIT001">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tipe Orderan
                                *</label>
                            <select name="orderType" required
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">Pilih Tipe</option>
                                <option value="online">Online</option>
                                <option value="offline">Offline</option>
                            </select>
                        </div>
                    </div>

                    <!-- Location Information -->
                    <div class="space-y-2">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <i class="fas fa-map-marker-alt text-green-600 dark:text-green-400 mr-2"></i>
                            Informasi Lokasi
                        </h4>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Lokasi Muat
                                *</label>
                            <input type="text" name="origin" required
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
                                placeholder="Alamat lokasi muat">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Lokasi
                                Bongkar *</label>
                            <input type="text" name="destination" required
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
                                placeholder="Alamat lokasi bongkar">
                        </div>
                    </div>

                    <!-- Financial Information -->
                    <div class="space-y-2">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <i class="fas fa-money-bill-wave text-purple-600 dark:text-purple-400 mr-2"></i>
                            Informasi Keuangan
                        </h4>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Argo (Total
                                Tarif) *</label>
                            <input type="number" name="fare" required
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
                                placeholder="1000000">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Setoran
                                Perusahaan (40%)</label>
                            <input type="number" name="companyShare" readonly
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-300"
                                placeholder="Otomatis dihitung">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Bagian Supir
                                (60%)</label>
                            <input type="number" name="driverShare" readonly
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-300"
                                placeholder="Otomatis dihitung">
                        </div>
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Catatan</label>
                            <textarea name="notes" rows="2"
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
                                placeholder="Catatan tambahan"></textarea>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-2 pt-6 border-t border-gray-200 dark:border-gray-700 mt-6">
                    <button type="button"
                        class="px-6 py-3 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 close-modal font-medium">Batal</button>
                    <button type="submit"
                        class="bg-gradient-to-r from-indigo-600 to-indigo-700 text-white px-8 py-3 rounded-xl hover:from-indigo-700 hover:to-indigo-800 smooth-hover font-medium shadow-lg">
                        <i class="fas fa-save mr-2"></i>Simpan Jadwal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Debt Modal -->
    <div id="addDebtModal"
        class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div
            class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto modal fade-in">
            <div class="p-6 border-b border-gray-100 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <div
                            class="w-10 h-10 bg-amber-100 dark:bg-amber-900 rounded-xl flex items-center justify-center">
                            <i class="fas fa-hand-holding-usd text-amber-600 dark:text-amber-400"></i>
                        </div>
                        <div>
                            <h3 id="addDebtModalTitle" class="text-xl font-bold text-gray-900 dark:text-white">Tambah
                                Hutang</h3>
                            <p id="addDebtModalSubtitle" class="text-sm text-gray-500 dark:text-gray-400">Catat hutang
                                (nunggak) baru</p>
                        </div>
                    </div>
                    <button
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 close-modal p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
            </div>
            <form id="addDebtForm" class="p-6 space-y-4">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <i class="fas fa-user-tie text-amber-600 dark:text-amber-400 mr-2"></i>
                            Data Hutang
                        </h4>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Supir
                                *</label>
                            <select name="driver" required
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">Pilih Supir</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tanggal
                                *</label>
                            <input type="date" name="date" required
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                    </div>
                    <div class="space-y-2">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <i class="fas fa-money-bill-wave text-purple-600 dark:text-purple-400 mr-2"></i>
                            Detail Hutang
                        </h4>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Keterangan
                                Hutang</label>
                            <textarea name="notes" rows="2"
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
                                placeholder="Contoh: Pinjaman BBM, uang jalan, dll"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Jumlah Hutang
                                *</label>
                            <input type="number" name="amount" required min="0"
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                placeholder="0">
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-2 pt-6 border-t border-gray-200 dark:border-gray-700 mt-6">
                    <button type="button"
                        class="px-6 py-3 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 close-modal font-medium">Batal</button>
                    <button type="submit"
                        class="bg-gradient-to-r from-amber-600 to-amber-700 text-white px-8 py-3 rounded-xl hover:from-amber-700 hover:to-amber-800 smooth-hover font-medium shadow-lg">
                        <i class="fas fa-save mr-2"></i>Simpan Hutang
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Service History Modal -->
    <div id="serviceHistoryModal"
        class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div
            class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-7xl w-full max-h-[90vh] overflow-y-auto overflow-x-hidden modal fade-in">
            <div class="p-6 border-b border-gray-100 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <div
                            class="w-10 h-10 bg-green-100 dark:bg-green-900 rounded-xl flex items-center justify-center">
                            <i class="fas fa-history text-green-600 dark:text-green-400"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white">History Service</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Daftar service yang sudah selesai</p>
                        </div>
                    </div>
                    <button
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 close-modal p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700"
                        onclick="closeModal('serviceHistoryModal')">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white">Daftar Hutang Aktif</h4>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Pantau pembayaran dan sisa hutang supir</p>
                    </div>
                </div>
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3 mb-4">
                    <div class="flex flex-col sm:flex-row gap-2 w-full lg:w-auto">
                        <select id="historyDriverFilter"
                            class="w-full sm:w-auto px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <option value="">Semua Supir</option>
                        </select>
                        <input type="month" id="historyMonthFilter"
                            class="w-full sm:w-auto px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white" />
                    </div>
                    <div class="flex items-center gap-2 w-full lg:w-auto justify-between sm:justify-start">
                        <button id="serviceHistoryPrevPage"
                            class="px-3 py-1 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600">Prev</button>
                        <span id="serviceHistoryPageInfo" class="text-sm text-gray-600 dark:text-gray-400">Halaman 1
                            dari 1</span>
                        <button id="serviceHistoryNextPage"
                            class="px-3 py-1 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600">Next</button>
                    </div>
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-400 mb-3 text-right">
                    Total Biaya: <span id="historyTotalCost">Rp 0</span>
                </div>
                <div class="w-full overflow-x-auto">
                    <table class="w-full min-w-[720px] md:min-w-0 table-auto">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                    Tanggal</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                    Kendaraan</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                    Supir</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                    Jenis</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                    Biaya</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                    Status</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                    Kwitansi</th>
                            </tr>
                        </thead>
                        <tbody id="serviceHistoryTableBody"
                            class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- History Schedules Page (Standalone) removed -->

    <!-- Edit Schedule Modal -->
    <div id="editScheduleModal"
        class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div
            class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto modal fade-in">
            <div class="p-6 border-b border-gray-100 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900 rounded-xl flex items-center justify-center">
                            <i class="fas fa-pen text-blue-600 dark:text-blue-400"></i>
                        </div>
                        <div>
                            <h3 id="editScheduleTitle" class="text-xl font-bold text-gray-900 dark:text-white">Edit
                                Jadwal Tarikan</h3>
                            <p id="editScheduleSubtitle" class="text-sm text-gray-500 dark:text-gray-400">Perbarui
                                informasi order tarikan</p>
                        </div>
                    </div>
                    <button
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 close-modal p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
            </div>
            <form id="editScheduleForm" class="p-6 space-y-4">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div id="editRouteSection" class="space-y-2">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <i class="fas fa-user-tie text-blue-600 dark:text-blue-400 mr-2"></i>
                            Informasi Supir & Jadwal
                        </h4>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Supir
                                *</label>
                            <select name="driver" required
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tanggal
                                *</label>
                            <input type="date" name="date" required
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>

                    </div>
                    <div id="editOrderSection" class="space-y-2">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <i class="fas fa-map-marked-alt text-blue-600 dark:text-blue-400 mr-2"></i>
                            Rute
                        </h4>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Lokasi
                                Muat</label>
                            <input type="text" name="origin"
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                placeholder="Lokasi muat">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Lokasi
                                Bongkar</label>
                            <input type="text" name="destination"
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                placeholder="Lokasi bongkar">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">RIT</label>
                            <input type="text" name="rit"
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                placeholder="RIT001">
                        </div>
                    </div>
                    <div class="space-y-2">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <i class="fas fa-dollar-sign text-blue-600 dark:text-blue-400 mr-2"></i>
                            Order
                        </h4>
                        <div id="editOrderTypeGroup">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tipe
                                Order</label>
                            <select name="orderType"
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="online">Online</option>
                                <option value="offline">Offline</option>
                            </select>
                        </div>
                        <div>
                            <label id="editFareLabel"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Argo</label>
                            <input type="number" name="fare"
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                placeholder="500000">
                        </div>
                        <div id="editStatusGroup">
                            <label
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Status</label>
                            <select name="status"
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="nunggak">Nunggak</option>
                                <option value="lunas">Lunas</option>
                            </select>
                        </div>
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Catatan</label>
                            <textarea name="notes" rows="3"
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                placeholder="Catatan tambahan"></textarea>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-2 pt-6 border-t border-gray-200 dark:border-gray-700 mt-6">
                    <button type="button"
                        class="px-6 py-3 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 close-modal font-medium">Batal</button>
                    <button type="submit"
                        class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-8 py-3 rounded-xl hover:from-blue-700 hover:to-blue-800 smooth-hover font-medium shadow-lg">
                        <i class="fas fa-save mr-2"></i>Simpan Perubahan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirm Delete Modal -->

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm mx-auto shadow-2xl transform modal">
            <div class="p-6 text-center">
                <div
                    class="w-14 h-14 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-sign-out-alt text-blue-600 dark:text-blue-400 text-2xl"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2">Keluar dari Akun</h3>
                <p class="text-gray-600 dark:text-gray-400 text-sm mb-1">Anda yakin ingin logout?</p>
            </div>
            <div class="px-6 pb-6">
                <div class="flex space-x-2">
                    <button
                        class="close-modal flex-1 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 py-2.5 px-4 rounded-lg font-medium text-sm transition-all duration-300">Batal</button>
                    <button onclick="confirmLogout()"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-800 text-white py-2.5 px-4 rounded-lg font-medium text-sm transition-all duration-300 transform hover:scale-105">
                        <i class="fas fa-check mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Monthly Target Modal -->
    <div id="monthlyTargetModal"
        class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md mx-auto shadow-2xl transform modal">
            <form id="monthlyTargetForm" class="p-6 space-y-6">
                <div class="text-center sm:text-left space-y-3">
                    <div
                        class="w-14 h-14 bg-emerald-100 dark:bg-emerald-900/30 rounded-full flex items-center justify-center mx-auto sm:mx-0">
                        <i class="fas fa-bullseye text-emerald-600 dark:text-emerald-400 text-2xl"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white">Atur Target Bulanan</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Masukkan Kwitansi target pendapatan
                            perusahaan untuk perhitungan progres.</p>
                    </div>
                </div>
                <div class="space-y-2">
                    <label for="monthlyTargetInput" class="text-sm font-medium text-gray-700 dark:text-gray-300">Target
                        Bulanan (Rp)</label>
                    <input id="monthlyTargetInput" name="monthlyTarget" type="number" min="100000" step="50000"
                        class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                        placeholder="Contoh: 15000000" required>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Nilai target akan disimpan di perangkat ini.</p>
                </div>
                <div class="flex flex-wrap sm:flex-nowrap sm:justify-end gap-3">
                    <button type="button" onclick="closeModal('monthlyTargetModal')"
                        class="flex-1 sm:flex-none px-5 py-2.5 rounded-xl border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">Batal</button>
                    <button type="submit"
                        class="flex-1 sm:flex-none px-5 py-2.5 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white font-medium transition-colors">Simpan</button>
                </div>
            </form>
        </div>
    </div>\n <!-- Export Report Confirmation Modal -->
    <div id="confirmExportModal"
        class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm mx-auto shadow-2xl transform modal">
            <div class="p-6 text-center">
                <div
                    class="w-14 h-14 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-file-export text-green-600 dark:text-green-400 text-2xl"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2">Export Laporan</h3>
                <p class="text-gray-600 dark:text-gray-400 text-sm mb-1">Ingin mengekspor laporan sesuai filter saat
                    ini?</p>
            </div>
            <div class="px-6 pb-6">
                <div class="flex space-x-2">
                    <button
                        class="close-modal flex-1 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 py-2.5 px-4 rounded-lg font-medium text-sm transition-all duration-300">Batal</button>
                    <button onclick="confirmExport()"
                        class="flex-1 bg-green-600 hover:bg-green-700 dark:bg-green-700 dark:hover:bg-green-800 text-white py-2.5 px-4 rounded-lg font-medium text-sm transition-all duration-300 transform hover:scale-105">
                        <i class="fas fa-check mr-2"></i>Export
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="confirmDeleteModal"
        class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm mx-auto shadow-2xl transform modal">
            <!-- Modal Header -->
            <div class="p-6 text-center">
                <div
                    class="w-14 h-14 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-trash-alt text-red-600 dark:text-red-400 text-2xl"></i>
                </div>
                <h3 id="confirmDeleteTitle" class="text-lg font-bold text-gray-900 dark:text-white mb-2">Hapus</h3>
                <p id="confirmDeleteMessage" class="text-gray-600 dark:text-gray-400 text-sm mb-1">Yakin ingin menghapus
                    jadwal ini?</p>
                <p class="text-gray-500 dark:text-gray-500 text-xs">Tindakan ini tidak dapat dibatalkan</p>
            </div>

            <!-- Modal Actions -->
            <div class="px-6 pb-6">
                <div class="flex space-x-2">
                    <button type="button"
                        class="close-modal flex-1 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 py-2.5 px-4 rounded-lg font-medium text-sm transition-all duration-300">Batal</button>
                    <button type="button" onclick="confirmDelete()"
                        class="flex-1 bg-red-600 hover:bg-red-700 dark:bg-red-700 dark:hover:bg-red-800 text-white py-2.5 px-4 rounded-lg font-medium text-sm transition-all duration-300 transform hover:scale-105">
                        <i class="fas fa-trash mr-2"></i>Hapus
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- History Schedules Modal -->
    <div id="historyScheduleModal"
        class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div
            class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-7xl w-full max-h-[90vh] overflow-y-auto overflow-x-hidden modal fade-in">
            <div class="p-6 border-b border-gray-100 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <div
                            class="w-10 h-10 bg-green-100 dark:bg-green-900 rounded-xl flex items-center justify-center">
                            <i class="fas fa-history text-green-600 dark:text-green-400"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white">History Tarikan (Lunas)</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Daftar tarikan yang sudah lunas</p>
                        </div>
                    </div>
                    <button
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 close-modal p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white">Daftar Hutang Aktif</h4>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Pantau pembayaran dan sisa hutang supir</p>
                    </div>
                </div>
                <!-- Filters + Pagination (top right) -->
                <div class="flex flex-col sm:flex-row sm:items-center gap-3 mb-4">
                    <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto flex-1">
                        <select id="historyFilterDriver"
                            class="w-full sm:w-auto px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <option value="">Semua Supir</option>
                        </select>
                        <input type="date" id="historyFilterDate"
                            class="w-full sm:w-auto px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    <div id="historyPagination"
                        class="flex items-center gap-2 sm:ml-auto hidden w-full sm:w-auto justify-between sm:justify-start">
                        <div class="text-sm text-gray-600 dark:text-gray-400 hidden sm:block">
                            Menampilkan <span id="historyPageRange">0-0</span> dari <span id="historyTotal">0</span>
                        </div>
                        <button id="historyPrevPage" type="button"
                            onclick="if (historyCurrentPage > 1) { historyCurrentPage--; renderHistoryModal(); }"
                            class="px-3 py-1 rounded-lg border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">Prev</button>
                        <span id="historyPageInfo" class="text-sm text-gray-600 dark:text-gray-400">1/1</span>
                        <button id="historyNextPage" type="button"
                            onclick="if (historyCurrentPage < historyTotalPages) { historyCurrentPage++; renderHistoryModal(); }"
                            class="px-3 py-1 rounded-lg border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                    Supir</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                    Tanggal</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                    Muat</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                    Bongkar</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                    RIT</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                    Tipe</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                    Argo</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                    Setoran (40%)</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                    Tanggal Lunas</th>
                            </tr>
                        </thead>
                        <tbody id="historySchedulesBody"
                            class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Rows rendered by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Schedule Modal -->
    <div id="paymentScheduleModal"
        class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-lg w-full modal fade-in">
            <div class="p-6 border-b border-gray-100 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <div
                            class="w-10 h-10 bg-green-100 dark:bg-green-900 rounded-xl flex items-center justify-center">
                            <i class="fas fa-credit-card text-green-600 dark:text-green-400"></i>
                        </div>
                        <div>
                            <h3 id="paymentModalTitle" class="text-xl font-bold text-gray-900 dark:text-white">
                                Pembayaran Setoran (40%)</h3>
                            <p id="paymentModalSubtitle" class="text-sm text-gray-500 dark:text-gray-400">Input jumlah
                                pembayaran untuk jadwal ini
                            </p>
                        </div>
                    </div>
                    <button
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 close-modal p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
            </div>
            <form id="paymentScheduleForm" class="p-6 space-y-4">
                <div class="space-y-2">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <p id="paymentCompanyShareLabel" class="text-gray-500 dark:text-gray-400">Setoran (40%)</p>
                            <p id="paymentCompanyShare" class="font-semibold text-gray-900 dark:text-white">Rp 0</p>
                        </div>
                        <div>
                            <p class="text-gray-500 dark:text-gray-400">Terbayar</p>
                            <p id="paymentPaid" class="font-semibold text-gray-900 dark:text-white">Rp 0</p>
                        </div>
                        <div>
                            <p class="text-gray-500 dark:text-gray-400">Sisa</p>
                            <p id="paymentRemaining" class="font-semibold text-red-600 dark:text-red-400">Rp 0</p>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Jumlah
                            Bayar</label>
                        <input type="number" name="amount" required min="0"
                            class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                            placeholder="0">
                    </div>
                    <div>
                        <label id="paymentNotesLabel"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Catatan</label>
                        <textarea name="notes" rows="2"
                            class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                            placeholder="Opsional"></textarea>
                    </div>
                </div>
                <div class="flex justify-end space-x-2 pt-6 border-t border-gray-200 dark:border-gray-700 mt-6">
                    <button type="button"
                        class="px-6 py-3 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 close-modal font-medium">Batal</button>
                    <button type="submit"
                        class="bg-gradient-to-r from-green-600 to-green-700 text-white px-8 py-3 rounded-xl hover:from-green-700 hover:to-green-800 smooth-hover font-medium shadow-lg">
                        <i class="fas fa-check mr-2"></i>Proses Pembayaran
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Debt History Modal -->
    <div id="debtHistoryModal"
        class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div
            class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-7xl w-full max-h-[90vh] overflow-y-auto overflow-x-hidden modal fade-in">
            <div class="p-6 border-b border-gray-100 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <div
                            class="w-10 h-10 bg-amber-100 dark:bg-amber-900 rounded-xl flex items-center justify-center">
                            <i class="fas fa-history text-amber-600 dark:text-amber-400"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white">History Hutang</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Riwayat dan daftar hutang dengan filter
                            </p>
                        </div>
                    </div>
                    <button
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 close-modal p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white">Daftar Hutang Aktif</h4>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Pantau pembayaran dan sisa hutang supir</p>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-center gap-3 mb-4">
                    <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto flex-1">
                        <select id="debtHistoryFilterDriver"
                            class="w-full sm:w-auto px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <option value="">Semua Supir</option>
                        </select>
                        <input type="date" id="debtHistoryFilterDate"
                            class="w-full sm:w-auto px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    <div id="debtHistoryPagination"
                        class="flex items-center gap-2 sm:ml-auto hidden w-full sm:w-auto justify-between sm:justify-start">
                        <div class="text-sm text-gray-600 dark:text-gray-400 hidden sm:block">
                            Menampilkan <span id="debtHistoryPageRange">0-0</span> dari <span
                                id="debtHistoryTotal">0</span>
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400 hidden sm:block">
                            &bull; Total Sisa: <span id="debtHistoryTotalRemaining">Rp 0</span>
                        </div>
                        <button id="debtHistoryPrevPage" type="button"
                            onclick="if (debtHistoryCurrentPage > 1) { debtHistoryCurrentPage--; renderDebtHistoryModal(); }"
                            class="px-3 py-1 rounded-lg border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">Prev</button>
                        <span id="debtHistoryPageInfo" class="text-sm text-gray-600 dark:text-gray-400">1/1</span>
                        <button id="debtHistoryNextPage" type="button"
                            onclick="if (debtHistoryCurrentPage < debtHistoryTotalPages) { debtHistoryCurrentPage++; renderDebtHistoryModal(); }"
                            class="px-3 py-1 rounded-lg border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                    Supir</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                    Tanggal</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                    Keterangan</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                    Jumlah</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                    Terbayar</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                    Sisa</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                    Status</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                    Terakhir Bayar</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                    Nominal</th>
                            </tr>
                        </thead>
                        <tbody id="debtHistoryBody"
                            class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Rows rendered by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <!-- User Profile Modal -->
    <div id="userProfileModal"
        class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div
            class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto modal fade-in">
            <div class="p-6 border-b border-gray-100 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Profil Saya</h3>
                    <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 close-modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <form id="userProfileForm" class="p-6 space-y-2">
                <div class="flex justify-center mb-5">
                    <div class="w-24 h-24 bg-blue-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-white text-3xl"></i>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nama Lengkap</label>
                    <input type="text" name="fullName" value="Administrator"
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email</label>
                    <input type="email" name="email" value="admin@driverpro.com"
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nomor HP</label>
                    <input type="tel" name="phone" value="+62 812 3456 7890"
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Role</label>
                    <input type="text" value="Super Admin" disabled
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-600 text-gray-500 dark:text-gray-400">
                </div>
                <div class="flex justify-end space-x-2 pt-4">
                    <button type="button"
                        class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 close-modal">Batal</button>
                    <button type="submit"
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 smooth-hover">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal"
        class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div
            class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto modal fade-in">
            <div class="p-6 border-b border-gray-100 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Ubah Password</h3>
                    <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 close-modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <form id="changePasswordForm" class="p-6 space-y-2">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Password Lama</label>
                    <input type="password" name="oldPassword" required
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Password Baru</label>
                    <input type="password" name="newPassword" required
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Konfirmasi Password
                        Baru</label>
                    <input type="password" name="confirmPassword" required
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                </div>
                <div class="flex justify-end space-x-2 pt-4">
                    <button type="button"
                        class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 close-modal">Batal</button>
                    <button type="submit"
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 smooth-hover">Ubah
                        Password</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Data Storage
        let drivers = JSON.parse(localStorage.getItem('drivers')) || [];
        let documents = JSON.parse(localStorage.getItem('documents')) || [];
        let services = JSON.parse(localStorage.getItem('services')) || [];
        let serviceHistory = JSON.parse(localStorage.getItem('serviceHistory')) || [];
        let schedules = JSON.parse(localStorage.getItem('schedules')) || [];
        let debts = JSON.parse(localStorage.getItem('debts')) || [];

        function sameId(a, b) {
            return String(a) === String(b);
        }
        (function normalizeServicesFromStorage() {
            try {
                const completedFromServices = (services || []).filter(s => (s.status || '').toLowerCase() === 'selesai');
                if (completedFromServices.length) {
                    const historyIds = new Set((serviceHistory || []).map(item => item && item.id != null ? String(item.id) : null));
                    completedFromServices.forEach(item => {
                        const idKey = item && item.id != null ? String(item.id) : null;
                        if (idKey && historyIds.has(idKey)) {
                            const existingIdx = serviceHistory.findIndex(h => sameId(h.id, item.id));
                            if (existingIdx !== -1) {
                                serviceHistory[existingIdx] = { ...serviceHistory[existingIdx], ...item };
                            }
                        } else {
                            serviceHistory.push(item);
                            if (idKey) { historyIds.add(idKey); }
                        }
                    });
                    services = services.filter(s => (s.status || '').toLowerCase() !== 'selesai');
                    try {
                        localStorage.setItem('services', JSON.stringify(services));
                        localStorage.setItem('serviceHistory', JSON.stringify(serviceHistory));
                    } catch (e) { }

                }

            } catch (e) { }

        })();

        function jsString(value) {
            if (value === null || value === undefined) return "''";
            const str = String(value)
                .replace(/\\/g, '\\')
                .replace(/'/g, "\'")
                .replace(/\r/g, '\r')
                .replace(/\n/g, '\n');
            return "'" + str + "'";
        }

        function lockScroll() {
            const currentLocks = parseInt(document.body.dataset.scrollLocks || '0', 10) || 0;
            if (currentLocks === 0) {
                const scrollY = window.scrollY || document.documentElement.scrollTop || 0;
                const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
                document.body.dataset.scrollRestore = String(scrollY);
                document.body.style.top = `-${scrollY}px`;
                document.body.classList.add('fixed', 'w-full');
                if (scrollbarWidth > 0) {
                    if (!document.body.dataset.scrollPadOriginal) {
                        document.body.dataset.scrollPadOriginal = document.body.style.paddingRight || '';
                    }
                    document.body.style.paddingRight = scrollbarWidth + 'px';
                    document.body.dataset.scrollPad = String(scrollbarWidth);
                }
            }
            document.body.dataset.scrollLocks = String(currentLocks + 1);
        }

        function unlockScroll() {
            const currentLocks = parseInt(document.body.dataset.scrollLocks || '0', 10) || 0;
            const next = Math.max(currentLocks - 1, 0);
            if (next === 0) {
                const restore = parseInt(document.body.dataset.scrollRestore || '0', 10) || 0;
                document.body.classList.remove('fixed', 'w-full');
                document.body.style.top = '';
                if (document.body.dataset.scrollPad) {
                    const originalPad = document.body.dataset.scrollPadOriginal || '';
                    document.body.style.paddingRight = originalPad;
                    delete document.body.dataset.scrollPad;
                    delete document.body.dataset.scrollPadOriginal;
                }
                delete document.body.dataset.scrollRestore;
                window.scrollTo(0, restore);
            }
            document.body.dataset.scrollLocks = String(next);
        }
        async function apiRequest(endpoint, options = {}) {
            const url = (window.API_BASE || 'api') + '/' + endpoint;
            const { method = 'GET', data } = options;
            const needsOverride = (method === 'PUT' || method === 'PATCH' || method === 'DELETE');
            const actualMethod = needsOverride ? 'POST' : method;
            const init = { method: actualMethod, headers: { 'Content-Type': 'application/json' } };
            const payload = needsOverride ? { _method: method, ...(data || {}) } : (data || undefined);
            if (payload) init.body = JSON.stringify(payload);
            if (needsOverride) { init.headers['X-HTTP-Method-Override'] = method; }
            const res = await fetch(url + ((needsOverride && data && data.id) ? ('?id=' + encodeURIComponent(data.id)) : ''), init);
            if (!res.ok) {
                let txt = '';
                try { txt = await res.text(); } catch (e) { }
                throw new Error('API error ' + res.status + (txt ? (': ' + txt) : ''));
            }
            return res.json();
        }

        async function bootstrapFromAPI() {
            try {
                const [dri, doc, srv, sch, deb] = await Promise.all([
                    apiRequest('drivers.php'),
                    apiRequest('documents.php'),
                    apiRequest('services.php'),
                    apiRequest('schedules.php'),
                    apiRequest('debts.php')
                ]);
                if (Array.isArray(dri)) { drivers = dri; localStorage.setItem('drivers', JSON.stringify(drivers)); }
                if (Array.isArray(doc)) { documents = doc; localStorage.setItem('documents', JSON.stringify(documents)); }
                if (Array.isArray(srv)) {
                    const completed = srv.filter(s => (s.status || '').toLowerCase() === 'selesai');
                    const active = srv.filter(s => (s.status || '').toLowerCase() !== 'selesai');
                    services = active;
                    serviceHistory = completed;
                    localStorage.setItem('services', JSON.stringify(services));
                    localStorage.setItem('serviceHistory', JSON.stringify(serviceHistory));
                }
                if (Array.isArray(sch)) { schedules = sch; localStorage.setItem('schedules', JSON.stringify(schedules)); }
                try { updateDashboard(); } catch (e) { }
            } catch (e) { console.warn('API bootstrap failed, using local data', e); }
        }
        let activities = JSON.parse(localStorage.getItem('activities')) || [];
        let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
        let settings = JSON.parse(localStorage.getItem('settings')) || {
            companyName: 'DriverPro Transport',
            companyEmail: 'admin@driverpro.com',
            companyPhone: '+62 21 1234 5678',
            companyAddress: 'Jakarta, Indonesia',
            emailNotifications: true,
            documentReminders: true,
            serviceNotifications: true,
            timezone: 'Asia/Jakarta',
            dateFormat: 'DD/MM/YYYY',
            currency: 'IDR',
            language: 'id'
        };

        // Initialize sample data if empty (disabled; using DB now)
        if (false) {
            const today = new Date();
            drivers = [
                {
                    id: 1,
                    name: 'Budi Santoso',
                    phone: '081234567890',
                    email: 'budi@example.com',
                    address: 'Jl. Sudirman No. 123, Jakarta',
                    vehicle: 'B 1234 CD',
                    vehicleType: 'Truk',
                    vehicleYear: 2020,
                    status: 'aktif',
                    joinDate: '2023-01-15'
                },
                {
                    id: 2,
                    name: 'Ahmad Wijaya',
                    phone: '081234567891',
                    email: 'ahmad@example.com',
                    address: 'Jl. Thamrin No. 456, Jakarta',
                    vehicle: 'B 5678 EF',
                    vehicleType: 'Container',
                    vehicleYear: 2019,
                    status: 'aktif',
                    joinDate: '2023-02-20'
                },
                {
                    id: 3,
                    name: 'Siti Nurhaliza',
                    phone: '081234567892',
                    email: 'siti@example.com',
                    address: 'Jl. Gatot Subroto No. 789, Jakarta',
                    vehicle: 'B 9012 GH',
                    vehicleType: 'Trailer',
                    vehicleYear: 2021,
                    status: 'aktif',
                    joinDate: '2023-03-10'
                },
                {
                    id: 4,
                    name: 'Joko Susilo',
                    phone: '081234567893',
                    email: 'joko@example.com',
                    address: 'Jl. Rasuna Said No. 321, Jakarta',
                    vehicle: 'B 3456 IJ',
                    vehicleType: 'Box',
                    vehicleYear: 2022,
                    status: 'aktif',
                    joinDate: '2023-04-05'
                },
                {
                    id: 5,
                    name: 'Andi Pratama',
                    phone: '081234567894',
                    email: 'andi@example.com',
                    address: 'Jl. HR Rasuna Said No. 654, Jakarta',
                    vehicle: 'B 7890 KL',
                    vehicleType: 'Truk',
                    vehicleYear: 2021,
                    status: 'aktif',
                    joinDate: '2023-05-12'
                }
            ];
            localStorage.setItem('drivers', JSON.stringify(drivers));
        }

        if (false) {
            documents = [
                {
                    id: 1,
                    vehicle: 'B 1234 CD',
                    type: 'KIR',
                    documentNumber: 'KIR123456789',
                    issueDate: '2023-12-31',
                    expiry: '2024-12-31',
                    reminderDays: 30,
                    renewalCost: 500000,
                    notes: 'KIR tahunan',
                    status: 'aktif'
                },
                {
                    id: 2,
                    vehicle: 'B 5678 EF',
                    type: 'STNK',
                    documentNumber: 'STNK987654321',
                    issueDate: '2023-02-15',
                    expiry: '2024-02-15',
                    reminderDays: 14,
                    renewalCost: 200000,
                    notes: 'STNK tahunan',
                    status: 'akan berakhir'
                },
                {
                    id: 3,
                    vehicle: 'B 9012 GH',
                    type: 'Pajak',
                    documentNumber: 'PJK456789123',
                    issueDate: '2023-03-20',
                    expiry: '2024-03-20',
                    reminderDays: 30,
                    renewalCost: 1500000,
                    notes: 'Pajak tahunan',
                    status: 'aktif'
                },
                {
                    id: 4,
                    vehicle: 'B 1234 CD',
                    type: 'Asuransi',
                    documentNumber: 'ASR789123456',
                    issueDate: '2023-06-01',
                    expiry: '2024-06-01',
                    reminderDays: 30,
                    renewalCost: 2000000,
                    notes: 'Asuransi comprehensive',
                    status: 'aktif'
                }
            ];
            localStorage.setItem('documents', JSON.stringify(documents));
        }

        if (false) {
            services = [
                {
                    id: 1,
                    vehicle: 'B 1234 CD',
                    type: 'Service Rutin',
                    date: '2024-02-10',
                    time: '08:00',
                    workshop: 'Bengkel Jaya Motor',
                    workshopAddress: 'Jl. Raya Bekasi No. 123',
                    cost: 500000,
                    priority: 'normal',
                    notes: 'Service rutin bulanan',
                    status: 'terjadwal'
                },
                {
                    id: 2,
                    vehicle: 'B 5678 EF',
                    type: 'Ganti Oli',
                    date: '2024-01-28',
                    time: '10:00',
                    workshop: 'Auto Service Center',
                    workshopAddress: 'Jl. Sudirman No. 456',
                    cost: 200000,
                    priority: 'normal',
                    notes: 'Ganti oli mesin',
                    status: 'selesai'
                },
                {
                    id: 3,
                    vehicle: 'B 9012 GH',
                    type: 'Perbaikan',
                    date: '2024-02-15',
                    time: '14:00',
                    workshop: 'Bengkel Mandiri',
                    workshopAddress: 'Jl. Gatot Subroto No. 789',
                    cost: 750000,
                    priority: 'tinggi',
                    notes: 'Perbaikan sistem rem',
                    status: 'dalam proses'
                }
            ];
            localStorage.setItem('services', JSON.stringify(services));
        }

        if (false) {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const twoDaysAgo = new Date(today);
            twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
            const threeDaysAgo = new Date(today);
            threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
            const fourDaysAgo = new Date(today);
            fourDaysAgo.setDate(fourDaysAgo.getDate() - 4);
            const fiveDaysAgo = new Date(today);
            fiveDaysAgo.setDate(fiveDaysAgo.getDate() - 5);
            const sixDaysAgo = new Date(today);
            sixDaysAgo.setDate(sixDaysAgo.getDate() - 6);
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

            schedules = [
                // Today
                {
                    id: 1,
                    driver: 'Budi Santoso',
                    date: today.toISOString().split('T')[0],
                    time: '08:00',
                    origin: 'Pelabuhan Tanjung Priok, Jakarta',
                    destination: 'Gudang Central, Bandung',
                    rit: 'RIT001',
                    orderType: 'online',
                    distance: 150,
                    duration: 4,
                    cargoType: 'Elektronik',
                    fare: 1000000,
                    companyShare: 400000,
                    driverShare: 600000,
                    fuelCost: 200000,
                    tollCost: 50000,
                    notes: 'Barang fragile, hati-hati',
                    status: 'nunggak'
                },
                {
                    id: 2,
                    driver: 'Ahmad Wijaya',
                    date: today.toISOString().split('T')[0],
                    time: '10:00',
                    origin: 'Pabrik Tekstil, Surabaya',
                    destination: 'Toko Grosir, Malang',
                    rit: 'RIT002',
                    orderType: 'offline',
                    distance: 90,
                    duration: 2.5,
                    cargoType: 'Tekstil',
                    fare: 500000,
                    companyShare: 200000,
                    driverShare: 300000,
                    fuelCost: 120000,
                    tollCost: 25000,
                    notes: '',
                    status: 'nunggak'
                },
                {
                    id: 3,
                    driver: 'Joko Susilo',
                    date: today.toISOString().split('T')[0],
                    time: '14:00',
                    origin: 'Pasar Induk, Jakarta',
                    destination: 'Supermarket, Cirebon',
                    rit: 'RIT003',
                    orderType: 'online',
                    distance: 230,
                    duration: 5,
                    cargoType: 'Makanan',
                    fare: 750000,
                    companyShare: 300000,
                    driverShare: 450000,
                    fuelCost: 180000,
                    tollCost: 40000,
                    notes: 'Produk segar, segera kirim',
                    status: 'nunggak'
                },

                // Yesterday
                {
                    id: 4,
                    driver: 'Budi Santoso',
                    date: yesterday.toISOString().split('T')[0],
                    time: '09:00',
                    origin: 'Gudang Pusat, Jakarta',
                    destination: 'Mall Besar, Semarang',
                    rit: 'RIT004',
                    orderType: 'online',
                    distance: 450,
                    duration: 8,
                    cargoType: 'Fashion',
                    fare: 800000,
                    companyShare: 320000,
                    driverShare: 480000,
                    fuelCost: 300000,
                    tollCost: 80000,
                    notes: '',
                    status: 'nunggak'
                },
                {
                    id: 5,
                    driver: 'Siti Nurhaliza',
                    date: yesterday.toISOString().split('T')[0],
                    time: '14:00',
                    origin: 'Pabrik Furniture, Bandung',
                    destination: 'Showroom, Yogyakarta',
                    rit: 'RIT005',
                    orderType: 'offline',
                    distance: 380,
                    duration: 7,
                    cargoType: 'Furniture',
                    fare: 750000,
                    companyShare: 300000,
                    driverShare: 450000,
                    fuelCost: 250000,
                    tollCost: 70000,
                    notes: 'Barang berat, perlu crane',
                    status: 'nunggak'
                },
                {
                    id: 6,
                    driver: 'Andi Pratama',
                    date: yesterday.toISOString().split('T')[0],
                    time: '16:00',
                    origin: 'Kantor Pusat, Jakarta',
                    destination: 'Cabang, Bekasi',
                    rit: 'RIT006',
                    orderType: 'online',
                    distance: 35,
                    duration: 1.5,
                    cargoType: 'Dokumen',
                    fare: 300000,
                    companyShare: 120000,
                    driverShare: 180000,
                    fuelCost: 50000,
                    tollCost: 15000,
                    notes: 'Dokumen penting',
                    status: 'nunggak'
                }
            ];
            localStorage.setItem('schedules', JSON.stringify(schedules));
        }

        if (notifications.length === 0) {
            notifications = [
                { id: 1, title: 'KIR Akan Berakhir', message: 'KIR kendaraan B 5678 EF akan berakhir dalam 5 hari', type: 'warning', read: false, timestamp: new Date().toISOString() },
                { id: 2, title: 'Service Terjadwal', message: 'Service rutin kendaraan B 1234 CD dijadwalkan besok', type: 'info', read: false, timestamp: new Date().toISOString() },
                { id: 3, title: 'Jadwal Lunas', message: 'Tarikan Jakarta-Bandung telah lunas', type: 'success', read: true, timestamp: new Date().toISOString() }
            ];
            localStorage.setItem('notifications', JSON.stringify(notifications));
        }

        // Utility Functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function formatStatus(status) {
            if (status === 'lunas') return 'Lunas';
            if (status === 'nunggak') return 'Nunggak';
            return status;
        }

        function toInt(value) {
            if (value === null || value === undefined || value === '') return 0;
            if (typeof value === 'number' && Number.isFinite(value)) return Math.round(value);
            const parsed = parseInt(value, 10);
            return Number.isNaN(parsed) ? 0 : parsed;
        }

        function formatCurrencyShort(amount) {
            const n = Number(amount) || 0;
            const abs = Math.abs(n);
            let value, suffix;
            if (abs >= 1000000000) { // >= 1 miliar
                value = n / 1000000000;
                suffix = ' m';
            } else if (abs >= 1000000) { // >= 1 Juta
                value = n / 1000000;
                suffix = ' jt';
            } else if (abs >= 1000) { // >= 1 Ribu
                value = n / 1000;
                suffix = ' rb';
            } else {
                return formatCurrency(n);
            }
            const rounded = Math.round(value * 10) / 10; // 1 decimal
            // gunakan koma sebagai pemisah desimal
            const txt = String(rounded).replace('.', ',');
            return 'Rp ' + txt + suffix;
        }

        function renderReceiptPreview(receipt, sizeClass = 'h-16 w-16') {
            if (!receipt || typeof receipt !== 'string') {
                return '';
            }
            const isDataUrl = receipt.startsWith('data:');
            const lower = receipt.toLowerCase();
            const isImage = isDataUrl || /\.(png|jpe?g|gif|webp)$/i.test(lower);
            if (isImage) {
                const safeSrc = isDataUrl ? receipt : encodeURI(receipt);
                return `<a href="${safeSrc}" target="_blank" rel="noopener" class="inline-flex items-center gap-3 text-purple-600 hover:text-purple-700">` +
                    `<img src="${safeSrc}" alt="Kwitansi" class="${sizeClass} rounded-lg object-cover border border-gray-200 dark:border-gray-700">` +
                    `<span class="text-sm font-medium">Lihat</span>` +
                    `</a>`;
            }
            const safeHref = encodeURI(receipt);
            return `<a href="${safeHref}" target="_blank" rel="noopener" class="text-sm font-medium text-purple-600 hover:text-purple-700">Unduh Kwitansi</a>`;
        }

        function renderReceiptCell(receipt) {
            const markup = renderReceiptPreview(receipt, 'h-12 w-12');
            return markup || '<span class="text-sm text-gray-400">-</span>';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID');
        }

        function addActivity(message) {
            const activity = {
                id: Date.now(),
                message: message,
                timestamp: new Date().toISOString()
            };
            activities.unshift(activity);
            if (activities.length > 10) activities = activities.slice(0, 10);
            localStorage.setItem('activities', JSON.stringify(activities));

            // Add notification for important activities
            if (message.includes('ditambahkan') || message.includes('dihapus') || message.includes('diubah') || message.includes('Pembayaran')) {
                addNotification('Aktivitas Sistem', message, 'info');
            }

            updateDashboard();
        }

        // Mobile menu functionality
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const closeSidebar = document.getElementById('closeSidebar');
        const mobileOverlay = document.getElementById('mobileOverlay');

        function openSidebar() {
            sidebar.classList.remove('-translate-x-full');
            mobileOverlay.classList.remove('hidden');
            lockScroll();
            sidebar.dataset.scrollLock = '1';
            // Hide or lower hamburger button under overlay on mobile
            if (typeof mobileMenuBtn !== 'undefined' && mobileMenuBtn) {
                mobileMenuBtn.classList.add('opacity-0', 'pointer-events-none', 'z-10');
                mobileMenuBtn.classList.remove('z-[70]');
            }
        }

        function closeSidebarFunc() {
            sidebar.classList.add('-translate-x-full');
            mobileOverlay.classList.add('hidden');
            if (sidebar.dataset.scrollLock === '1') {
                sidebar.dataset.scrollLock = '';
                unlockScroll();
            }
            // Restore hamburger button visibility and z-index
            if (typeof mobileMenuBtn !== 'undefined' && mobileMenuBtn) {
                mobileMenuBtn.classList.remove('opacity-0', 'pointer-events-none', 'z-10');
                mobileMenuBtn.classList.add('z-[70]');
            }
        }

        if (menuToggle) {
            menuToggle.addEventListener('click', openSidebar);
        }
        // Support floating mobile button (from supir.html)
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', openSidebar);
        }
        if (closeSidebar) {
            closeSidebar.addEventListener('click', closeSidebarFunc);
        }
        mobileOverlay.addEventListener('click', closeSidebarFunc);

        // Menu navigation
        // Keep sidebar state sane on resize between mobile/desktop
        window.addEventListener('resize', () => {
            try {
                if (window.innerWidth >= 1024) {
                    // Desktop: ensure sidebar visible and overlay hidden
                    sidebar.classList.remove('-translate-x-full');
                    mobileOverlay.classList.add('hidden');
                    if (sidebar.dataset.scrollLock === '1') {
                        sidebar.dataset.scrollLock = '';
                        unlockScroll();
                    }
                } else {
                    // Mobile: default hidden sidebar, overlay hidden
                    sidebar.classList.add('-translate-x-full');
                    mobileOverlay.classList.add('hidden');
                    if (sidebar.dataset.scrollLock === '1') {
                        sidebar.dataset.scrollLock = '';
                        unlockScroll();
                    }
                }
            } catch (e) { }
        });
        const menuItems = document.querySelectorAll('.menu-item');
        const pageContents = document.querySelectorAll('.page-content');
        const pageTitle = document.getElementById('pageTitle');

        const pageTitles = {
            'dashboard': 'Dashboard',
            'drivers': 'Kelola Supir',
            'tax-kir': 'Pajak & KIR',
            'service': 'Service',
            'schedule': 'Jadwal Tarikan',
            'debt': 'Kelola Hutang',
            'reports': 'Laporan',
            'settings': 'Pengaturan'
        };

        menuItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const page = item.getAttribute('data-page');

                if (page) {
                    // Update active menu item styles (preserve and restore base light/dark styles)
                    menuItems.forEach(mi => {
                        mi.classList.remove('active', 'text-white', 'bg-gradient-to-r', 'from-blue-600', 'to-blue-500', 'shadow-lg');
                        // ensure non-active items have their base light/dark styles
                        mi.classList.add('text-slate-700', 'hover:text-slate-900', 'hover:bg-gray-100',
                            'dark:text-slate-300', 'dark:hover:text-white', 'dark:hover:bg-slate-800/50');
                        const icon = mi.querySelector('i');
                        if (icon) {
                            icon.classList.remove('text-white', 'text-blue-200');
                        }
                        const sub = mi.querySelector('p.text-xs');
                        if (sub) {
                            sub.classList.remove('text-blue-100', 'text-white', 'dark:text-white');
                            sub.classList.add('text-slate-500', 'dark:text-slate-300');
                        }
                    });

                    item.classList.add('active', 'text-white', 'bg-gradient-to-r', 'from-blue-600', 'to-blue-500', 'shadow-lg');
                    item.classList.remove('text-slate-300', 'hover:text-white', 'hover:bg-slate-800/50', 'text-slate-700', 'hover:text-slate-900', 'hover:bg-gray-100',
                        'dark:text-slate-300', 'dark:hover:text-white', 'dark:hover:bg-slate-800/50');
                    const aSub = item.querySelector('p.text-xs');
                    if (aSub) {
                        aSub.classList.remove('text-slate-300', 'text-slate-500', 'dark:text-slate-300');
                        aSub.classList.add('text-white', 'dark:text-white');
                    }

                    // Show corresponding content with smooth fade-in
                    pageContents.forEach(content => {
                        content.classList.add('hidden');
                        content.classList.remove('fade-in');
                    });
                    const targetContent = document.getElementById(page + '-content');
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                        requestAnimationFrame(() => {
                            targetContent.classList.add('fade-in');
                        });
                    }

                    // Update page title
                    pageTitle.textContent = pageTitles[page] || 'Dashboard';

                    // Load page-specific content
                    switch (page) {
                        case 'dashboard':
                            updateDashboard();
                            break;
                        case 'drivers':
                            loadDrivers();
                            break;
                        case 'tax-kir':
                            loadDocuments();
                            break;
                        case 'service':
                            loadServices();
                            break;
                        case 'schedule':
                            loadSchedules();
                            break;
                        case 'debt':
                            loadDebts();
                            break;
                        case 'reports':
                            loadReports();
                            break;
                        case 'settings':
                            loadSettings();
                            break;
                    }

                    // Close sidebar on mobile after selection
                    if (window.innerWidth < 1024) {
                        closeSidebarFunc();
                    }
                }
            });
        });

        const DEFAULT_MONTHLY_TARGET = 10000000;
        const MONTHLY_TARGET_STORAGE_KEY = 'monthlyTarget';

        function getMonthlyTarget() {
            try {
                const stored = Number(localStorage.getItem(MONTHLY_TARGET_STORAGE_KEY));
                return Number.isFinite(stored) && stored > 0 ? stored : DEFAULT_MONTHLY_TARGET;
            } catch (e) {
                return DEFAULT_MONTHLY_TARGET;
            }
        }

        function setMonthlyTarget(value) {
            try {
                localStorage.setItem(MONTHLY_TARGET_STORAGE_KEY, String(value));
            } catch (e) { }
        }
        // Dashboard Functions
        function updateDashboard() {
            // Update stats
            document.getElementById('totalDrivers').textContent = drivers.length;
            document.getElementById('activeVehicles').textContent = drivers.filter(d => d.status === 'aktif').length;

            const today = new Date().toISOString().split('T')[0];
            const todaySchedules = schedules.filter(s => s.date === today);
            document.getElementById('todaySchedules').textContent = todaySchedules.length;
            document.getElementById('completedSchedules').textContent = todaySchedules.filter(s => s.status === 'lunas').length;

            // Calculate monthly revenue
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlySchedules = schedules.filter(s => {
                const scheduleDate = new Date(s.date);
                return scheduleDate.getMonth() === currentMonth &&
                    scheduleDate.getFullYear() === currentYear &&
                    s.status === 'lunas';
            });
            const monthlyCompanyShare = monthlySchedules.reduce((sum, s) => sum + toInt(s.companyShare ?? Math.round(toInt(s.fare) * 0.4)), 0);
            const monthlyDriverShare = monthlySchedules.reduce((sum, s) => sum + toInt(s.driverShare ?? Math.round(toInt(s.fare) * 0.6)), 0);

            const companyShare = monthlyCompanyShare;
            const driverShare = monthlyDriverShare;

            document.getElementById('driverShare').textContent = formatCurrency(driverShare);
            document.getElementById('companyShare').textContent = formatCurrency(companyShare);
            document.getElementById('totalRevenue').textContent = formatCurrencyShort(companyShare);

            // Update monthly performance (target bulanan)
            const monthlyTarget = getMonthlyTarget();
            const achieved = companyShare; // gunakan porsi perusahaan (40%) agar konsisten
            const progressPercentage = Math.min((achieved / monthlyTarget) * 100, 100);

            document.getElementById('todayRevenue').textContent = formatCurrency(achieved);
            document.getElementById('progressBar').style.width = progressPercentage + '%';
            document.getElementById('progressPercentage').textContent = Math.round(progressPercentage) + '% dari target (' + formatCurrency(monthlyTarget) + ')';

            // Update quick stats
            const completedTrips = schedules.filter(s => s.status === 'lunas');
            const avgTripRevenue = completedTrips.length > 0
                ? completedTrips.reduce((sum, s) => sum + toInt(s.companyShare ?? Math.round(toInt(s.fare) * 0.4)), 0) / completedTrips.length
                : 0;
            document.getElementById('avgTripRevenue').textContent = formatCurrency(avgTripRevenue);

            // Calculate top driver trips
            const driverTrips = {};
            completedTrips.forEach(trip => {
                driverTrips[trip.driver] = (driverTrips[trip.driver] || 0) + 1;
            });
            const maxTrips = Math.max(...Object.values(driverTrips), 0);
            document.getElementById('topDriverTrips').textContent = maxTrips + ' trip';

            // Calculate fleet efficiency
            const activeDrivers = drivers.filter(d => d.status === 'aktif').length;
            const efficiency = activeDrivers > 0 ? Math.round((todaySchedules.filter(s => s.status === 'lunas').length / activeDrivers) * 100) : 0;
            document.getElementById('fleetEfficiency').textContent = efficiency + '%';

            // Update charts
            updateMonthlyRevenueChart();
            updateDriverPerformanceChart();
            updateDriverRanking();
            updateUpcomingSchedules();

            // Update recent activities
            const activitiesHtml = activities.map(activity => `
                <div class="flex items-center space-x-4 p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 smooth-hover">
                    <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center">
                        <i class="fas fa-info text-blue-600 dark:text-blue-400 text-sm"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900 dark:text-white">${activity.message}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${new Date(activity.timestamp).toLocaleString('id-ID')}</p>
                    </div>
                </div>
            `).join('');
            document.getElementById('recentActivities').innerHTML = activitiesHtml || '<p class="text-gray-500 dark:text-gray-400 text-center py-4">Belum ada aktivitas</p>';

            // Update reminders
            const now = new Date();
            const reminders = [];

            documents.forEach(doc => {
                const expiryDate = new Date(doc.expiry);
                const daysUntilExpiry = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
                if (daysUntilExpiry <= 30 && daysUntilExpiry > 0) {
                    reminders.push({
                        type: 'document',
                        message: `${doc.type} kendaraan ${doc.vehicle} akan berakhir`,
                        detail: `Berakhir dalam ${daysUntilExpiry} hari`,
                        color: daysUntilExpiry <= 7 ? 'red' : 'yellow'
                    });
                }
            });

            services.filter(s => s.status === 'terjadwal').forEach(service => {
                const serviceDate = new Date(service.date);
                const daysUntilService = Math.ceil((serviceDate - now) / (1000 * 60 * 60 * 24));
                if (daysUntilService <= 3 && daysUntilService >= 0) {
                    reminders.push({
                        type: 'service',
                        message: `${service.type} kendaraan ${service.vehicle}`,
                        detail: daysUntilService === 0 ? 'Hari ini' : daysUntilService === 1 ? 'Besok' : `${daysUntilService} hari lagi`,
                        color: 'blue'
                    });
                }
            });

            const remindersHtml = reminders.map(reminder => `
                <div class="flex items-center space-x-4 p-4 bg-${reminder.color}-50 dark:bg-${reminder.color}-900/20 rounded-lg border border-${reminder.color}-200 dark:border-${reminder.color}-800">
                    <div class="w-10 h-10 bg-${reminder.color}-100 dark:bg-${reminder.color}-900 rounded-lg flex items-center justify-center">
                        <i class="fas fa-${reminder.type === 'document' ? 'exclamation-triangle' : 'calendar-alt'} text-${reminder.color}-600 dark:text-${reminder.color}-400 text-sm"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900 dark:text-white">${reminder.message}</p>
                        <p class="text-xs text-${reminder.color}-600 dark:text-${reminder.color}-400 font-medium">${reminder.detail}</p>
                    </div>
                </div>
            `).join('');
            document.getElementById('reminders').innerHTML = remindersHtml || '<p class="text-gray-500 dark:text-gray-400 text-center py-4">Tidak ada reminder</p>';
        }


        function openMonthlyTargetModal() {
            try {
                const form = document.getElementById("monthlyTargetForm");
                if (form) {
                    const input = form.querySelector("input[name=\"monthlyTarget\"]");
                    if (input) {
                        input.value = String(getMonthlyTarget());
                        setTimeout(() => { input.focus(); input.select(); }, 10);
                    }
                }
                openModal("monthlyTargetModal", { lockScroll: false });
            } catch (e) {
                openModal("monthlyTargetModal");
            }
        }

        function handleMonthlyTargetSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const input = form.querySelector("input[name=\"monthlyTarget\"]");
            if (!input) return;
            const rawValue = Number(input.value);
            if (!Number.isFinite(rawValue) || rawValue <= 0) {
                showToast("Gagal", "Target harus lebih besar dari 0", "error");
                input.focus();
                return;
            }
            setMonthlyTarget(Math.round(rawValue));
            closeModal("monthlyTargetModal");
            showToast("Berhasil", "Target bulanan diperbarui", "success");
            updateDashboard();
        }

        // Chart instances storage
        let monthlyRevenueChartInstance = null;
        let driverPerformanceChartInstance = null;
        let revenueChartInstance = null;
        let vehicleStatusChartInstance = null;

        // Monthly Revenue Chart
        function updateMonthlyRevenueChart() {
            try {
                const canvas = document.getElementById('monthlyRevenueChart');
                if (!canvas) return;

                const ctx = canvas.getContext('2d');

                // Destroy existing chart
                if (monthlyRevenueChartInstance) {
                    monthlyRevenueChartInstance.destroy();
                }

                // Generate last 6 months data
                const months = [];
                const revenues = [];
                const targets = [];

                for (let i = 5; i >= 0; i--) {
                    const date = new Date();
                    date.setMonth(date.getMonth() - i);
                    const monthName = date.toLocaleDateString('id-ID', { month: 'short' });
                    months.push(monthName);

                    // Calculate revenue for this month
                    const monthCompanyShare = schedules.filter(s => {
                        const scheduleDate = new Date(s.date);
                        return scheduleDate.getMonth() === date.getMonth() &&
                            scheduleDate.getFullYear() === date.getFullYear() &&
                            s.status === 'lunas';
                    }).reduce((sum, s) => sum + toInt(s.companyShare ?? Math.round(toInt(s.fare) * 0.4)), 0);

                    revenues.push(monthCompanyShare);
                    targets.push(10000000); // Target porsi perusahaan (40%) per bulan
                }

                monthlyRevenueChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Pendapatan Perusahaan (40%)',
                            data: revenues,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointBackgroundColor: 'rgb(59, 130, 246)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5
                        }, {
                            label: 'Target',
                            data: targets,
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            borderDash: [5, 5],
                            tension: 0.4,
                            pointBackgroundColor: 'rgb(34, 197, 94)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: 'rgba(255, 255, 255, 0.1)',
                                borderWidth: 1,
                                callbacks: {
                                    label: function (context) {
                                        return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: '#6B7280',
                                    font: {
                                        size: window.innerWidth < 640 ? 10 : 12
                                    }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(107, 114, 128, 0.1)'
                                },
                                ticks: {
                                    color: '#6B7280',
                                    font: {
                                        size: window.innerWidth < 640 ? 10 : 12
                                    },
                                    callback: function (value) {
                                        if (window.innerWidth < 640) {
                                            // Shorter format for mobile
                                            if (value >= 1000000) {
                                                return (value / 1000000).toFixed(0) + 'M';
                                            } else if (value >= 1000) {
                                                return (value / 1000).toFixed(0) + 'K';
                                            }
                                            return value;
                                        }
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating monthly revenue chart:', error);
            }
        }

        // Driver Performance Chart
        function updateDriverPerformanceChart() {
            try {
                const canvas = document.getElementById('driverPerformanceChart');
                if (!canvas) return;

                const ctx = canvas.getContext('2d');

                // Destroy existing chart
                if (driverPerformanceChartInstance) {
                    driverPerformanceChartInstance.destroy();
                }

                // Calculate driver revenues for current month
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();

                const driverRevenues = {};
                schedules.filter(s => {
                    const scheduleDate = new Date(s.date);
                    return scheduleDate.getMonth() === currentMonth &&
                        scheduleDate.getFullYear() === currentYear &&
                        s.status === 'lunas';
                }).forEach(schedule => {
                    const driverKey = schedule.driver || 'Tidak diketahui';
                    const revenueShare = toInt(schedule.driverShare ?? Math.round(toInt(schedule.fare) * 0.6));
                    driverRevenues[driverKey] = (driverRevenues[driverKey] || 0) + revenueShare;

                    driverRevenues[schedule.driver] = (driverRevenues[schedule.driver] || 0) + (schedule.fare * 0.6); // 60% share
                });

                const driverNames = Object.keys(driverRevenues);
                const revenues = Object.values(driverRevenues);

                // If no data, show placeholder
                if (driverNames.length === 0) {
                    driverNames.push('Belum ada data');
                    revenues.push(0);
                }

                driverPerformanceChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: driverNames,
                        datasets: [{
                            label: 'Pendapatan (60%)',
                            data: revenues,
                            backgroundColor: [
                                'rgba(59, 130, 246, 0.8)',
                                'rgba(34, 197, 94, 0.8)',
                                'rgba(251, 191, 36, 0.8)',
                                'rgba(239, 68, 68, 0.8)',
                                'rgba(168, 85, 247, 0.8)',
                                'rgba(236, 72, 153, 0.8)',
                                'rgba(14, 165, 233, 0.8)'
                            ],
                            borderColor: [
                                'rgb(59, 130, 246)',
                                'rgb(34, 197, 94)',
                                'rgb(251, 191, 36)',
                                'rgb(239, 68, 68)',
                                'rgb(168, 85, 247)',
                                'rgb(236, 72, 153)',
                                'rgb(14, 165, 233)'
                            ],
                            borderWidth: 2,
                            borderRadius: 8,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: 'rgba(255, 255, 255, 0.1)',
                                borderWidth: 1,
                                callbacks: {
                                    label: function (context) {
                                        return 'Pendapatan: ' + formatCurrency(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: '#6B7280',
                                    maxRotation: window.innerWidth < 640 ? 90 : 45,
                                    font: {
                                        size: window.innerWidth < 640 ? 9 : 12
                                    },
                                    callback: function (value, index) {
                                        const label = this.getLabelForValue(value);
                                        if (window.innerWidth < 640) {
                                            // Show only first name on mobile
                                            return label.split(' ')[0];
                                        }
                                        return label;
                                    }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(107, 114, 128, 0.1)'
                                },
                                ticks: {
                                    color: '#6B7280',
                                    font: {
                                        size: window.innerWidth < 640 ? 10 : 12
                                    },
                                    callback: function (value) {
                                        if (window.innerWidth < 640) {
                                            // Shorter format for mobile
                                            if (value >= 1000000) {
                                                return (value / 1000000).toFixed(0) + 'M';
                                            } else if (value >= 1000) {
                                                return (value / 1000).toFixed(0) + 'K';
                                            }
                                            return value;
                                        }
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating driver performance chart:', error);
            }
        }

        // Driver Ranking
        function updateDriverRanking() {
            const period = document.getElementById('rankingPeriod')?.value || 'month';
            let filteredSchedules = Array.isArray(schedules) ? schedules.slice() : [];

            const now = new Date();
            if (period === 'today') {
                const today = now.toISOString().split('T')[0];
                filteredSchedules = filteredSchedules.filter(s => s.date === today);
            } else if (period === 'week') {
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                filteredSchedules = filteredSchedules.filter(s => new Date(s.date) >= weekAgo);
            } else if (period === 'month') {
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                filteredSchedules = filteredSchedules.filter(s => {
                    const scheduleDate = new Date(s.date);
                    return scheduleDate.getMonth() === currentMonth && scheduleDate.getFullYear() === currentYear;
                });
            }

            // Calculate driver stats
            const driverStats = {};
            filteredSchedules.forEach(schedule => {
                if (!driverStats[schedule.driver]) {
                    driverStats[schedule.driver] = {
                        name: schedule.driver,
                        trips: 0,
                        revenue: 0,
                        driverShare: 0
                    };
                }
                driverStats[schedule.driver].trips++;
                driverStats[schedule.driver].revenue += schedule.fare;
                driverStats[schedule.driver].driverShare += schedule.fare * 0.6;
            });

            // Sort by driver share (descending)
            const sortedDrivers = Object.values(driverStats).sort((a, b) => b.revenue - a.revenue);

            const rankingHtml = sortedDrivers.map((driver, index) => {
                const rankColors = ['text-yellow-600', 'text-gray-600', 'text-orange-600'];
                const rankIcons = ['fas fa-trophy', 'fas fa-medal', 'fas fa-award'];
                const rankColor = rankColors[index] || 'text-blue-600';
                const rankIcon = rankIcons[index] || 'fas fa-star';

                return `
                    <div class="flex items-center justify-between p-3 lg:p-4 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 smooth-hover">
                        <div class="flex items-center space-x-2 lg:space-x-4 min-w-0 flex-1">
                            <div class="flex items-center justify-center w-6 h-6 lg:w-8 lg:h-8 flex-shrink-0">
                                <span class="text-sm lg:text-lg font-bold ${rankColor}">#${index + 1}</span>
                            </div>
                            <div class="w-8 h-8 lg:w-10 lg:h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-user text-white text-xs lg:text-sm"></i>
                            </div>
                            <div class="min-w-0 flex-1">
                                <p class="font-semibold text-gray-900 dark:text-white text-sm lg:text-base truncate">${driver.name}</p>
                                <p class="text-xs lg:text-sm text-gray-500 dark:text-gray-400 truncate">${driver.trips} trip &bull; ${window.innerWidth < 640 ? formatCurrency(driver.revenue).replace('Rp ', '').replace('.000', 'K').replace('.000.000', 'M') : formatCurrency(driver.revenue)} total</p>
                            </div>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <p class="font-bold text-gray-900 dark:text-white text-sm lg:text-base">${window.innerWidth < 640 ? formatCurrency(driver.driverShare).replace('Rp ', '').replace('.000', 'K').replace('.000.000', 'M') : formatCurrency(driver.driverShare)}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400 hidden sm:block">Bagian supir</p>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('driverRanking').innerHTML = rankingHtml || '<p class="text-gray-500 dark:text-gray-400 text-center py-8">Belum ada data ranking</p>';
        }

        // Upcoming Schedules
        function updateUpcomingSchedules() {
            const today = new Date();
            const threeDaysLater = new Date();
            threeDaysLater.setDate(today.getDate() + 3);

            const upcomingSchedules = schedules.filter(schedule => {
                const scheduleDate = new Date(schedule.date);
                return scheduleDate >= today && scheduleDate <= threeDaysLater && schedule.status === 'terjadwal';
            }).sort((a, b) => new Date(a.date) - new Date(b.date));

            const schedulesHtml = upcomingSchedules.map(schedule => {
                const scheduleDate = new Date(schedule.date);
                const isToday = scheduleDate.toDateString() === today.toDateString();
                const isTomorrow = scheduleDate.toDateString() === new Date(today.getTime() + 24 * 60 * 60 * 1000).toDateString();

                let dateLabel;
                if (isToday) {
                    dateLabel = 'Hari ini';
                } else if (isTomorrow) {
                    dateLabel = 'Besok';
                } else {
                    dateLabel = scheduleDate.toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric', month: 'short' });
                }

                return `
                    <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 smooth-hover">
                        <div class="flex items-center space-x-2">
                            <div class="w-10 h-10 bg-indigo-100 dark:bg-indigo-900 rounded-lg flex items-center justify-center">
                                <i class="fas fa-truck text-indigo-600 dark:text-indigo-400 text-sm"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-900 dark:text-white text-sm">${schedule.driver}</p>
                                <p class="text-xs text-gray-600 dark:text-gray-400">${schedule.origin} &rarr; ${schedule.destination}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${isToday ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200'}">
                                ${dateLabel}
                            </span>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${schedule.time} &bull; ${formatCurrency(schedule.fare)}</p>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('upcomingSchedules').innerHTML = schedulesHtml || '<p class="text-gray-500 dark:text-gray-400 text-center py-8">Tidak ada jadwal mendatang</p>';
        }

        // Global variables for drivers view
        let currentDriversView = 'grid';
        let filteredDrivers = [...drivers];

        // Drivers Functions
        function loadDrivers() {
            updateDriversStats();
            filterAndSortDrivers();
            if (currentDriversView === 'grid') {
                renderDriversGrid();
            } else {
                renderDriversTable();
            }
        }

        function updateDriversStats() {
            const totalDrivers = drivers.length;
            const activeDrivers = drivers.filter(d => d.status === 'aktif').length;
            const onTripDrivers = Math.floor(activeDrivers * 0.6); // Simulate drivers on trip

            // Find top performer
            const driverRevenues = {};
            schedules.filter(s => s.status === 'lunas').forEach(schedule => {
                driverRevenues[schedule.driver] = (driverRevenues[schedule.driver] || 0) + schedule.fare;
            });
            const topDriver = Object.keys(driverRevenues).reduce((a, b) =>
                driverRevenues[a] > driverRevenues[b] ? a : b, '-'
            );

            document.getElementById('totalDriversCount').textContent = totalDrivers;
            document.getElementById('activeDriversCount').textContent = activeDrivers;
            document.getElementById('onTripDriversCount').textContent = onTripDrivers;
            document.getElementById('topDriverName').textContent = topDriver.split(' ')[0] || '-';
        }

        function filterAndSortDrivers() {
            const searchTerm = document.getElementById('searchDriver')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('filterStatus')?.value || '';
            const sortBy = document.getElementById('sortBy')?.value || 'name';

            filteredDrivers = drivers.filter(driver => {
                const matchesSearch = driver.name.toLowerCase().includes(searchTerm) ||
                    driver.vehicle.toLowerCase().includes(searchTerm) ||
                    driver.phone.includes(searchTerm) ||
                    (driver.email && driver.email.toLowerCase().includes(searchTerm));
                const matchesStatus = !statusFilter || driver.status === statusFilter;
                return matchesSearch && matchesStatus;
            });

            // Sort drivers
            filteredDrivers.sort((a, b) => {
                switch (sortBy) {
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'vehicle':
                        return a.vehicle.localeCompare(b.vehicle);
                    case 'status':
                        return a.status.localeCompare(b.status);
                    case 'joinDate':
                        return new Date(b.joinDate || '2023-01-01') - new Date(a.joinDate || '2023-01-01');
                    default:
                        return 0;
                }
            });

            // Update counters
            document.getElementById('driversCount').textContent = filteredDrivers.length;
            document.getElementById('totalDriversDisplay').textContent = drivers.length;
        }

        function renderDriversGrid() {
            const grid = document.getElementById('driversGrid');
            const table = document.getElementById('driversTable');

            grid.classList.remove('hidden');
            table.classList.add('hidden');

            const html = filteredDrivers.map(driver => {
                const driverId = jsString(driver.id);
                const deleteMsg = jsString(`Hapus supir ${driver.name || ''}?`);
                const statusColor = driver.status === 'aktif' ? 'green' : 'red';
                const statusIcon = driver.status === 'aktif' ? 'check-circle' : 'times-circle';

                return `
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 p-6 card-hover">
                        <div class="flex items-start justify-between mb-5">
                            <div class="flex items-center space-x-3">
                                <div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center shadow-lg">
                                    <i class="fas fa-user text-white text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-gray-900 dark:text-white">${driver.name}</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">${driver.vehicleType || 'Kendaraan'} ${driver.vehicleYear || ''}</p>
                                </div>
                            </div>
                            <span class="inline-flex items-center px-3 py-1.5 text-xs font-medium rounded-full bg-${statusColor}-100 text-${statusColor}-800 dark:bg-${statusColor}-900 dark:text-${statusColor}-200 shadow-sm">
                                <i class="fas fa-${statusIcon} mr-1.5"></i>${driver.status.charAt(0).toUpperCase() + driver.status.slice(1)}
                            </span>
                        </div>
                        
                        <div class="space-y-2">
                            <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                                <div class="w-8 h-8 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-truck text-gray-500 dark:text-gray-400"></i>
                                </div>
                                <span class="font-medium text-gray-900 dark:text-white">${driver.vehicle}</span>
                            </div>
                            <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                                <div class="w-8 h-8 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-phone text-gray-500 dark:text-gray-400"></i>
                                </div>
                                <span>${driver.phone}</span>
                            </div>
                            ${driver.email ? `
                                <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                                    <div class="w-8 h-8 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center mr-3">
                                        <i class="fas fa-envelope text-gray-500 dark:text-gray-400"></i>
                                    </div>
                                    <span class="truncate">${driver.email}</span>
                                </div>
                            ` : ''}
                            <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                                <div class="w-8 h-8 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-calendar text-gray-500 dark:text-gray-400"></i>
                                </div>
                                <span>Bergabung ${formatDate(driver.joinDate || '2023-01-01')}</span>
                            </div>
                        </div>

                        <div class="flex justify-between items-center mt-6 pt-5 border-t border-gray-200 dark:border-gray-700">
                            <div class="flex space-x-2">
                                <button onclick="viewDriverDetail(${driverId})" class="inline-flex items-center px-3 py-2 text-xs font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors">
                                    <i class="fas fa-eye mr-1.5"></i>Detail
                                </button>
                                <button onclick="editDriver(${driverId})" class="inline-flex items-center px-3 py-2 text-xs font-medium text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-900/20 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/40 transition-colors">
                                    <i class="fas fa-edit mr-1.5"></i>Edit
                                </button>
                            </div>
                            <button onclick="openConfirmDelete('driver', ${driverId}, ${deleteMsg})" class="inline-flex items-center px-3 py-2 text-xs font-medium text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors">
                                <i class="fas fa-trash mr-1.5"></i>Hapus
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            grid.innerHTML = html || '<div class="col-span-full text-center py-12 text-gray-500 dark:text-gray-400">Tidak ada supir ditemukan</div>';
        }

        function renderDriversTable() {
            const grid = document.getElementById('driversGrid');
            const table = document.getElementById('driversTable');
            const tbody = document.getElementById('driversTableBody');

            grid.classList.add('hidden');
            table.classList.remove('hidden');

            const html = filteredDrivers.map(driver => {
                const driverId = jsString(driver.id);
                const deleteMsg = jsString(`Hapus supir ${driver.name || ''}?`);
                const statusColor = driver.status === 'aktif' ? 'green' : 'red';
                const statusIcon = driver.status === 'aktif' ? 'check-circle' : 'times-circle';

                return `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center mr-3">
                                    <i class="fas fa-user text-white text-sm"></i>
                                </div>
                                <div>
                                    <div class="text-sm font-semibold text-gray-900 dark:text-white">${driver.name}</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">${driver.vehicleType || 'Kendaraan'} ${driver.vehicleYear || ''}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900 dark:text-white">${driver.vehicle}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">${driver.vehicleType || ''}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900 dark:text-white">${driver.phone}</div>
                            ${driver.email ? `<div class="text-xs text-gray-500 dark:text-gray-400">${driver.email}</div>` : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-1 text-xs font-medium rounded-full bg-${statusColor}-100 text-${statusColor}-800 dark:bg-${statusColor}-900 dark:text-${statusColor}-200">
                                <i class="fas fa-${statusIcon} mr-1.5"></i>${driver.status.charAt(0).toUpperCase() + driver.status.slice(1)}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                            ${formatDate(driver.joinDate || '2023-01-01')}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex space-x-2">
                                <button onclick="viewDriverDetail(${driverId})" class="inline-flex items-center px-2 py-1 text-xs font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 rounded-md hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors">
                                    <i class="fas fa-eye mr-1"></i>Detail
                                </button>
                                <button onclick="editDriver(${driverId})" class="inline-flex items-center px-2 py-1 text-xs font-medium text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-900/20 rounded-md hover:bg-green-100 dark:hover:bg-green-900/40 transition-colors">
                                    <i class="fas fa-edit mr-1"></i>Edit
                                </button>
                                <button onclick="openConfirmDelete('driver', ${driverId}, ${deleteMsg})" class="inline-flex items-center px-2 py-1 text-xs font-medium text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 rounded-md hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors">
                                    <i class="fas fa-trash mr-1"></i>Hapus
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = html || '<tr><td colspan="6" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">Tidak ada supir ditemukan</td></tr>';
        }

        function viewDriverDetail(id) {
            const driver = drivers.find(d => sameId(d.id, id));
            if (!driver) return;

            const driverId = jsString(driver.id);
            // Create detail modal content
            const modalContent = `
                <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" id="driverDetailModal" data-lock-scroll="1" data-remove-on-backdrop="1">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-user text-white text-lg"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-bold text-gray-900 dark:text-white">${driver.name}</h3>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Detail Informasi Supir</p>
                                    </div>
                                </div>
                                <button onclick="closeDriverDetail()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                                    <i class="fas fa-times text-lg"></i>
                                </button>
                            </div>
                        </div>
                        <div class="p-6 space-y-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="text-lg font-semibold text-gray-900 dark:text-white">Daftar Hutang Aktif</h4>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Pantau pembayaran dan sisa hutang supir</p>
                            </div>
                        </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Informasi Personal</h4>
                                    <div class="space-y-2">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600 dark:text-gray-400">Nama:</span>
                                            <span class="font-medium text-gray-900 dark:text-white">${driver.name}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600 dark:text-gray-400">No. HP:</span>
                                            <span class="font-medium text-gray-900 dark:text-white">${driver.phone}</span>
                                        </div>
                                        ${driver.email ? `
                                            <div class="flex justify-between">
                                                <span class="text-gray-600 dark:text-gray-400">Email:</span>
                                                <span class="font-medium text-gray-900 dark:text-white">${driver.email}</span>
                                            </div>
                                        ` : ''}
                                        ${driver.address ? `
                                            <div class="flex justify-between">
                                                <span class="text-gray-600 dark:text-gray-400">Alamat:</span>
                                                <span class="font-medium text-gray-900 dark:text-white text-right">${driver.address}</span>
                                            </div>
                                        ` : ''}
                                        <div class="flex justify-between">
                                            <span class="text-gray-600 dark:text-gray-400">Status:</span>
                                            <span class="px-2 py-1 text-xs font-medium rounded-full ${driver.status === 'aktif' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${driver.status}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600 dark:text-gray-400">Bergabung:</span>
                                            <span class="font-medium text-gray-900 dark:text-white">${formatDate(driver.joinDate || '2023-01-01')}</span>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Informasi Kendaraan</h4>
                                    <div class="space-y-2">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600 dark:text-gray-400">No. Kendaraan:</span>
                                            <span class="font-medium text-gray-900 dark:text-white">${driver.vehicle}</span>
                                        </div>
                                        ${driver.vehicleType ? `
                                            <div class="flex justify-between">
                                                <span class="text-gray-600 dark:text-gray-400">Jenis:</span>
                                                <span class="font-medium text-gray-900 dark:text-white">${driver.vehicleType}</span>
                                            </div>
                                        ` : ''}
                                        ${driver.vehicleYear ? `
                                            <div class="flex justify-between">
                                                <span class="text-gray-600 dark:text-gray-400">Tahun:</span>
                                                <span class="font-medium text-gray-900 dark:text-white">${driver.vehicleYear}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="p-6 border-t border-gray-200 dark:border-gray-700">
                            <div class="flex justify-end space-x-2">
                                <button onclick="closeDriverDetail()" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">Tutup</button>
                                <button onclick="editDriver(${driverId}); closeDriverDetail();" class="bg-blue-600 text-white px-6 py-2 rounded-xl hover:bg-blue-700">Edit Supir</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalContent);
            lockScroll();
        }

        function closeDriverDetail() {
            const modal = document.getElementById('driverDetailModal');
            if (modal) {
                modal.remove();
                unlockScroll();
            }
        }

        async function addDriver(driverData) {
            try {
                const created = await apiRequest('drivers.php', { method: 'POST', data: driverData });
                drivers.unshift(created);
                localStorage.setItem('drivers', JSON.stringify(drivers));
                loadDrivers();
                addActivity(`Supir baru ${driverData.name} ditambahkan`);
                showToast('Berhasil', `Supir ${driverData.name} ditambahkan`, 'success');
            } catch (e) {
                console.error(e);
                alert('Gagal menambahkan supir.');
            }
        }

        function editDriver(id) {
            const driver = drivers.find(d => sameId(d.id, id));
            if (!driver) return;

            // Populate form with driver data
            const form = document.getElementById('addDriverForm');
            form.querySelector('[name="name"]').value = driver.name;
            form.querySelector('[name="phone"]').value = driver.phone;
            form.querySelector('[name="email"]').value = driver.email || '';
            form.querySelector('[name="address"]').value = driver.address || '';
            form.querySelector('[name="vehicle"]').value = driver.vehicle;
            form.querySelector('[name="vehicleType"]').value = driver.vehicleType || 'CDE';
            form.querySelector('[name="vehicleYear"]').value = driver.vehicleYear || '';
            form.querySelector('[name="status"]').value = driver.status;
            form.querySelector('[name="joinDate"]').value = driver.joinDate || '';

            // Change modal title and button text
            document.querySelector('#addDriverModal h3').textContent = 'Edit Supir';
            document.querySelector('#addDriverModal button[type="submit"]').innerHTML = '<i class="fas fa-save mr-2"></i>Update Supir';

            // Store edit mode
            form.dataset.editId = id;

            openModal('addDriverModal');
        }

        async function deleteDriver(id) {
            try { await apiRequest('drivers.php', { method: 'DELETE', data: { id } }); } catch (e) { console.warn('API delete driver failed, falling back', e); }
            const driver = drivers.find(d => sameId(d.id, id));
            drivers = drivers.filter(d => !sameId(d.id, id));
            localStorage.setItem('drivers', JSON.stringify(drivers));
            loadDrivers();
            if (driver) {
                addActivity(`Supir ${driver.name} dihapus`);
                showToast('Berhasil', `Supir ${driver.name} dihapus`, 'success');
            }
        }

        // Global variables for documents view
        let filteredDocuments = [...documents];
        let currentDocumentsView = 'grid';

        // Documents Functions
        function loadDocuments() {
            updateDocumentsStats();
            filterAndSortDocuments();
            if (currentDocumentsView === 'grid') {
                renderDocumentsGrid();
            } else {
                renderDocumentsTable();
            }
            populateVehicleDropdown();
        }

        function updateDocumentsStats() {
            const now = new Date();
            let expiring = 0, active = 0, expired = 0;

            documents.forEach(doc => {
                const expiryDate = new Date(doc.expiry);
                const daysUntilExpiry = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));

                if (daysUntilExpiry < 0) {
                    expired++;
                } else if (daysUntilExpiry <= 30) {
                    expiring++;
                } else {
                    active++;
                }
            });

            document.getElementById('expiringDocs').textContent = expiring;
            document.getElementById('activeDocs').textContent = active;
            document.getElementById('expiredDocs').textContent = expired;
            document.getElementById('totalDocs').textContent = documents.length;
        }

        function filterAndSortDocuments() {
            const searchTerm = document.getElementById('searchDocument')?.value.toLowerCase() || '';
            const typeFilter = document.getElementById('filterDocumentType')?.value || '';
            const statusFilter = document.getElementById('filterDocumentStatus')?.value || '';
            const sortBy = document.getElementById('sortDocuments')?.value || 'expiry';

            const now = new Date();

            filteredDocuments = documents.filter(doc => {
                const matchesSearch = doc.vehicle.toLowerCase().includes(searchTerm) ||
                    doc.type.toLowerCase().includes(searchTerm);
                const matchesType = !typeFilter || doc.type === typeFilter;

                // Calculate status for filtering
                const expiryDate = new Date(doc.expiry);
                const daysUntilExpiry = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
                let docStatus;
                if (daysUntilExpiry < 0) {
                    docStatus = 'berakhir';
                } else if (daysUntilExpiry <= 30) {
                    docStatus = 'akan berakhir';
                } else {
                    docStatus = 'aktif';
                }

                const matchesStatus = !statusFilter || docStatus === statusFilter;
                return matchesSearch && matchesType && matchesStatus;
            });

            // Sort documents
            filteredDocuments.sort((a, b) => {
                switch (sortBy) {
                    case 'expiry':
                        return new Date(a.expiry) - new Date(b.expiry);
                    case 'vehicle':
                        return a.vehicle.localeCompare(b.vehicle);
                    case 'type':
                        return a.type.localeCompare(b.type);
                    case 'status':
                        const now = new Date();
                        const aDays = Math.ceil((new Date(a.expiry) - now) / (1000 * 60 * 60 * 24));
                        const bDays = Math.ceil((new Date(b.expiry) - now) / (1000 * 60 * 60 * 24));
                        return aDays - bDays;
                    default:
                        return 0;
                }
            });

            // Update counters
            document.getElementById('documentsCount').textContent = filteredDocuments.length;
            document.getElementById('totalDocumentsDisplay').textContent = documents.length;
        }

        function renderDocumentsGrid() {
            const grid = document.getElementById('documentsGrid');
            const table = document.getElementById('documentsTable');

            grid.classList.remove('hidden');
            table.classList.add('hidden');

            const now = new Date();

            const html = filteredDocuments.map(doc => {
                const docId = jsString(doc.id);
                const deleteMsg = jsString(`Hapus dokumen ${doc.type || ''} untuk ${doc.vehicle || ''}?`);
                const expiryDate = new Date(doc.expiry);
                const daysUntilExpiry = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
                let status, statusClass, statusIcon;

                if (daysUntilExpiry < 0) {
                    status = 'Berakhir';
                    statusClass = 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
                    statusIcon = 'times-circle';
                } else if (daysUntilExpiry <= 30) {
                    status = 'Akan Berakhir';
                    statusClass = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
                    statusIcon = 'exclamation-triangle';
                } else {
                    status = 'Aktif';
                    statusClass = 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
                    statusIcon = 'check-circle';
                }

                const typeColors = {
                    'STNK': 'blue',
                    'KIR': 'green',
                    'Pajak': 'yellow',
                    'Asuransi': 'purple'
                };
                const typeColor = typeColors[doc.type] || 'gray';

                return `
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 p-5 card-hover">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center space-x-2">
                                <div class="w-10 h-10 bg-${typeColor}-100 dark:bg-${typeColor}-900 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-file-invoice text-${typeColor}-600 dark:text-${typeColor}-400"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900 dark:text-white">${doc.type}</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">${doc.vehicle}</p>
                                    <p class="text-xs text-gray-400 dark:text-gray-500">${getDriverNameByVehicle(doc.vehicle)}</p>
                                </div>
                            </div>
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">
                                <i class="fas fa-${statusIcon} mr-1"></i>${status}
                            </span>
                        </div>
                        
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600 dark:text-gray-400">Berakhir:</span>
                                <span class="font-medium text-gray-900 dark:text-white">${formatDate(doc.expiry)}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600 dark:text-gray-400">Sisa Hari:</span>
                                <span class="font-medium ${daysUntilExpiry < 0 ? 'text-red-600' : daysUntilExpiry <= 30 ? 'text-yellow-600' : 'text-green-600'}">${daysUntilExpiry < 0 ? 'Berakhir' : daysUntilExpiry + ' hari'}</span>
                            </div>
                            ${doc.renewalCost ? `
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600 dark:text-gray-400">Biaya:</span>
                                    <span class="font-medium text-gray-900 dark:text-white">${formatCurrency(doc.renewalCost)}</span>
                                </div>
                            ` : ''}
                        </div>

                        <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                            <button onclick="editDocument(${docId})" class="inline-flex items-center px-3 py-2 text-xs font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors">
                                <i class="fas fa-pen mr-1.5"></i>Edit
                            </button>
                            <button onclick="openConfirmDelete('document', ${docId}, ${deleteMsg})" class="inline-flex items-center px-3 py-2 text-xs font-medium text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors">
                                <i class="fas fa-trash mr-1.5"></i>Hapus
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            grid.innerHTML = html || '<div class="col-span-full text-center py-12 text-gray-500 dark:text-gray-400">Tidak ada dokumen ditemukan</div>';
        }

        function renderDocumentsTable() {
            const grid = document.getElementById('documentsGrid');
            const table = document.getElementById('documentsTable');
            const tbody = document.getElementById('documentsTableBody');

            grid.classList.add('hidden');
            table.classList.remove('hidden');

            const now = new Date();

            const html = filteredDocuments.map(doc => {
                const docId = jsString(doc.id);
                const deleteMsg = jsString(`Hapus dokumen ${doc.type || ''} untuk ${doc.vehicle || ''}?`);
                const expiryDate = new Date(doc.expiry);
                const daysUntilExpiry = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
                let status, statusClass;

                if (daysUntilExpiry < 0) {
                    status = 'Berakhir';
                    statusClass = 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
                } else if (daysUntilExpiry <= 30) {
                    status = 'Akan Berakhir';
                    statusClass = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
                } else {
                    status = 'Aktif';
                    statusClass = 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
                }

                return `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900 dark:text-white">${doc.vehicle}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">${getDriverNameByVehicle(doc.vehicle)}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${doc.type}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${formatDate(doc.expiry)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${daysUntilExpiry < 0 ? 'text-red-600' : daysUntilExpiry <= 30 ? 'text-yellow-600' : 'text-green-600'}">${daysUntilExpiry < 0 ? 'Berakhir' : daysUntilExpiry + ' hari'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">
                                ${status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex space-x-2">
                                <button onclick="editDocument(${docId})" class="inline-flex items-center px-2 py-1 text-xs font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 rounded-md hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors">
                                    <i class="fas fa-pen mr-1"></i>Edit
                                </button>
                                <button onclick="openConfirmDelete('document', ${docId}, ${deleteMsg})" class="inline-flex items-center px-2 py-1 text-xs font-medium text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 rounded-md hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors">
                                    <i class="fas fa-trash mr-1"></i>Hapus
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = html || '<tr><td colspan="6" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">Tidak ada dokumen ditemukan</td></tr>';
        }

        function populateVehicleDropdown() {
            const vehicleSelect = document.querySelector('#addDocumentForm select[name="vehicle"]');
            const vehicleOptions = drivers.map(driver =>
                `<option value="${driver.vehicle}" data-driver="${driver.name}">${driver.vehicle} - ${driver.name}</option>`
            ).join('');
            vehicleSelect.innerHTML = '<option value="">Pilih Kendaraan</option>' + vehicleOptions;
        }

        function getDriverNameByVehicle(vehicle) {
            const driver = drivers.find(d => d.vehicle === vehicle);
            return driver ? driver.name : 'Unknown';
        }

        async function addDocument(docData) {
            try {
                const created = await apiRequest('documents.php', { method: 'POST', data: docData });
                documents.unshift(created);
                localStorage.setItem('documents', JSON.stringify(documents));
                loadDocuments();
                addActivity(`Dokumen ${docData.type} untuk ${docData.vehicle} ditambahkan`);
                showToast('Berhasil', `Dokumen ${docData.type} untuk ${docData.vehicle} ditambahkan`, 'success');
            } catch (e) { console.error(e); alert('Gagal menambahkan dokumen.'); }
        }

        function editDocument(id) {
            const doc = documents.find(d => sameId(d.id, id));
            if (!doc) return;

            // Populate form with document data
            const form = document.getElementById('addDocumentForm');
            form.querySelector('[name="vehicle"]').value = doc.vehicle;
            form.querySelector('[name="type"]').value = doc.type;
            form.querySelector('[name="documentNumber"]').value = doc.documentNumber || '';
            form.querySelector('[name="issueDate"]').value = doc.issueDate || '';
            form.querySelector('[name="expiry"]').value = doc.expiry;
            form.querySelector('[name="reminderDays"]').value = doc.reminderDays || 30;
            form.querySelector('[name="renewalCost"]').value = doc.renewalCost || '';
            form.querySelector('[name="notes"]').value = doc.notes || '';

            // Change modal title and button text
            document.querySelector('#addDocumentModal h3').textContent = 'Edit Dokumen';
            document.querySelector('#addDocumentModal button[type="submit"]').innerHTML = '<i class="fas fa-save mr-2"></i>Update Dokumen';

            // Store edit mode
            form.dataset.editId = id;

            openModal('addDocumentModal');
        }

        async function deleteDocument(id) {
            try { await apiRequest('documents.php', { method: 'DELETE', data: { id } }); } catch (e) { console.warn('API delete document failed', e); }
            const doc = documents.find(d => sameId(d.id, id));
            documents = documents.filter(d => !sameId(d.id, id));
            localStorage.setItem('documents', JSON.stringify(documents));
            loadDocuments();
            if (doc) {
                addActivity(`Dokumen ${doc.type} untuk ${doc.vehicle} dihapus`);
                showToast('Berhasil', `Dokumen ${doc.type} untuk ${doc.vehicle} dihapus`, 'success');
            }
        }

        function sendBulkReminders() {
            const now = new Date();
            const expiringDocs = documents.filter(doc => {
                const expiryDate = new Date(doc.expiry);
                const daysUntilExpiry = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
                return daysUntilExpiry <= 30 && daysUntilExpiry > 0;
            });

            if (expiringDocs.length === 0) {
                alert('Tidak ada dokumen yang perlu diingatkan saat ini.');
                return;
            }

            // Simulate sending reminders
            expiringDocs.forEach(doc => {
                addNotification(
                    'Reminder Dokumen',
                    `${doc.type} kendaraan ${doc.vehicle} akan berakhir dalam ${Math.ceil((new Date(doc.expiry) - now) / (1000 * 60 * 60 * 24))} hari`,
                    'warning'
                );
            });

            alert(`Berhasil mengirim ${expiringDocs.length} reminder dokumen!`);
            addActivity(`Bulk reminder dikirim untuk ${expiringDocs.length} dokumen`);
        }

        function exportDocumentsData() {
            const csvContent = [
                ['Kendaraan', 'Jenis Dokumen', 'Nomor Dokumen', 'Tanggal Terbit', 'Tanggal Berakhir', 'Biaya Perpanjangan', 'Status'],
                ...documents.map(doc => {
                    const now = new Date();
                    const expiryDate = new Date(doc.expiry);
                    const daysUntilExpiry = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
                    let status;
                    if (daysUntilExpiry < 0) {
                        status = 'Berakhir';
                    } else if (daysUntilExpiry <= 30) {
                        status = 'Akan Berakhir';
                    } else {
                        status = 'Aktif';
                    }

                    return [
                        doc.vehicle,
                        doc.type,
                        doc.documentNumber || '',
                        doc.issueDate || '',
                        doc.expiry,
                        doc.renewalCost || '',
                        status
                    ];
                })
            ].map(row => row.join(',')).join('');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dokumen_kendaraan_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            addActivity('Data dokumen berhasil diekspor');
        }

        // Services Functions
        let currentServicesView = 'grid';
        let filteredServices = [...services];
        function loadServices() {
            // Update service status counts
            const scheduled = services.filter(s => s.status === 'terjadwal').length;
            const inProgress = services.filter(s => s.status === 'dalam proses').length;
            const completed = serviceHistory.length; // selesai dipindah ke history
            const totalCost = serviceHistory.reduce((sum, s) => sum + (s.cost || 0), 0);

            document.getElementById('scheduledServices').textContent = scheduled;
            document.getElementById('inProgressServices').textContent = inProgress;
            document.getElementById('completedServices').textContent = completed;
            document.getElementById('totalServiceCost').textContent = formatCurrencyShort(totalCost);

            // Update counters summary
            document.getElementById('servicesCount').textContent = services.length;
            document.getElementById('totalServicesDisplay').textContent = services.length;

            // Populate filters and apply filtering/sorting
            populateServiceDriverVehicleFilter();
            filterAndSortServices();
            // Render current view
            if (currentServicesView === 'grid') {
                renderServicesGrid();
            } else {
                renderServicesTable();
            }
        }

        async function addService(serviceData) {
            try {
                const created = await apiRequest('services.php', { method: 'POST', data: serviceData });
                const status = (created.status || '').toLowerCase();
                services = services.filter(s => !sameId(s.id, created.id));
                serviceHistory = serviceHistory.filter(s => !sameId(s.id, created.id));
                if (status === 'selesai') {
                    serviceHistory.unshift(created);
                } else {
                    services.unshift(created);
                }
                localStorage.setItem('services', JSON.stringify(services));
                localStorage.setItem('serviceHistory', JSON.stringify(serviceHistory));
                loadServices();
                const activityStatus = status === 'selesai' ? 'diselesaikan' : 'dijadwalkan';
                addActivity(`Service ${created.type || serviceData.type || ''} untuk ${created.vehicle || serviceData.vehicle || ''} ${activityStatus}`);
                const toastStatus = status === 'selesai' ? 'diselesaikan' : 'dijadwalkan';
                showToast('Berhasil', `Service ${created.type || serviceData.type || ''} untuk ${created.vehicle || serviceData.vehicle || ''} ${toastStatus}`, 'success');
            } catch (e) {
                console.error(e);
                alert('Gagal menambah service');
            }
        }

        async function updateServiceStatus(id) {
            const service = services.find(s => sameId(s.id, id));
            const statuses = ['terjadwal', 'dalam proses', 'selesai'];
            const currentIndex = statuses.indexOf(service.status);
            const nextIndex = (currentIndex + 1) % statuses.length;

            service.status = statuses[nextIndex];
            if (service.status === 'selesai') {
                // pindahkan ke history
                serviceHistory = serviceHistory.filter(s => !sameId(s.id, id));
                serviceHistory.unshift({ ...service });
                services = services.filter(s => !sameId(s.id, id));
                localStorage.setItem('serviceHistory', JSON.stringify(serviceHistory));
            }
            try {
                await apiRequest('services.php', { method: 'PUT', data: { id: id, vehicle: service.vehicle, driver: service.driver, type: service.type, date: service.date, cost: service.cost, status: service.status } });
            } catch (e) { /* ignore */ }
            localStorage.setItem('services', JSON.stringify(services));
            loadServices();
            addActivity(`Status service ${service.type} untuk ${service.vehicle} diubah menjadi ${service.status}`);
        }

        async function deleteService(id) {
            try { await apiRequest('services.php', { method: 'DELETE', data: { id } }); } catch (e) { console.warn(e); }
            const service = services.find(s => sameId(s.id, id));
            services = services.filter(s => !sameId(s.id, id));
            localStorage.setItem('services', JSON.stringify(services));
            loadServices();
            if (service) {
                addActivity(`Service ${service.type} untuk ${service.vehicle} dihapus`);
                showToast('Berhasil', `Service ${service.type} untuk ${service.vehicle} dihapus`, 'success');
            }
        }

        function editService(id) {
            const service = services.find(s => sameId(s.id, id));
            if (!service) return;
            const form = document.getElementById('addServiceForm');
            // Pastikan dropdown kendaraan terisi dulu
            populateServiceVehicleDropdown();
            // Set vehicle
            const vehicleSelect = form.querySelector('[name="vehicle"]');
            if (vehicleSelect) {
                // Jika opsi belum ada, tambahkan sementara
                const values = Array.from(vehicleSelect.options).map(o => o.value);
                if (service.vehicle && !values.includes(service.vehicle)) {
                    const opt = document.createElement('option');
                    opt.value = service.vehicle;
                    opt.textContent = `${service.vehicle} - ${getDriverNameByVehicle(service.vehicle) || service.driver || ''}`;
                    vehicleSelect.appendChild(opt);
                }
                vehicleSelect.value = service.vehicle || '';
            }
            // Set type
            const typeSelect = form.querySelector('[name="type"]');
            if (typeSelect) {
                const existingValues = Array.from(typeSelect.options).map(o => o.value);
                if (service.type && !existingValues.includes(service.type)) {
                    const opt = document.createElement('option');
                    opt.value = service.type; opt.textContent = service.type;
                    typeSelect.appendChild(opt);
                }
                typeSelect.value = service.type || '';
            }
            // Set date
            form.querySelector('[name="date"]').value = service.date || '';
            // Other fields
            form.querySelector('[name="cost"]').value = service.cost || 0;
            form.querySelector('[name="priority"]').value = service.priority || 'normal';
            form.querySelector('[name="notes"]').value = service.notes || '';
            const receiptGroup = document.getElementById('serviceReceiptGroup');
            if (receiptGroup) receiptGroup.classList.remove('hidden');
            const receiptInput = form.querySelector('input[name="receipt"]');
            if (receiptInput) receiptInput.value = '';
            const receiptPreview = document.getElementById('serviceReceiptPreview');
            const receiptPreviewContent = document.getElementById('serviceReceiptPreviewContent');
            if (receiptPreview && receiptPreviewContent) {
                if (service.receipt) {
                    receiptPreview.classList.remove('hidden');
                    receiptPreviewContent.innerHTML = renderReceiptPreview(service.receipt);
                } else {
                    receiptPreview.classList.add('hidden');
                    receiptPreviewContent.innerHTML = '';
                }
            }

            // Change modal title and button
            document.querySelector('#addServiceModal h3').textContent = 'Edit Service';
            document.querySelector('#addServiceModal button[type="submit"]').innerHTML = '<i class="fas fa-save mr-2"></i>Update Service';
            form.dataset.editId = id;
            openModal('addServiceModal');
        }

        function populateServiceVehicleDropdown() {
            const vehicleSelect = document.querySelector('#addServiceForm select[name="vehicle"]');
            if (!vehicleSelect) return;
            const set = new Set();
            const driverOptions = (drivers || []).map(driver => {
                set.add(driver.vehicle);
                return `<option value="${driver.vehicle}" data-driver="${driver.name}">${driver.vehicle} - ${driver.name}</option>`;
            });
            // Tambahkan kendaraan dari services (fallback) jika belum ada di daftar supir
            const serviceOptions = (services || [])
                .filter(s => s.vehicle && !set.has(s.vehicle))
                .map(s => {
                    const name = getDriverNameByVehicle(s.vehicle) || s.driver || '';
                    set.add(s.vehicle);
                    return `<option value="${s.vehicle}">${s.vehicle}${name ? ' - ' + name : ''}</option>`;
                });
            vehicleSelect.innerHTML = '<option value="">Pilih Kendaraan</option>' + driverOptions.join('') + serviceOptions.join('');
        }

        function populateServiceDriverVehicleFilter() {
            const select = document.getElementById('filterDriverVehicle');
            if (!select) return;
            const previous = select.value;
            // Bangun opsi dengan label "<kendaraan> - <supir>"
            let pairs = [];
            if (Array.isArray(drivers) && drivers.length) {
                pairs = drivers
                    .filter(d => d?.vehicle && d?.name)
                    .map(d => ({ value: d.vehicle, label: `${d.vehicle} - ${d.name}` }));
            } else {
                // Fallback dari data services
                const tmp = new Map();
                (services || []).forEach(s => {
                    const veh = s?.vehicle || '';
                    if (!veh) return;
                    const name = getDriverNameByVehicle(veh) || s?.driver || '';
                    if (!tmp.has(veh)) tmp.set(veh, name);
                });
                pairs = Array.from(tmp.entries()).map(([veh, name]) => ({ value: veh, label: `${veh} - ${name || '-'}` }));
            }
            // Unique by value (vehicle)
            const seen = new Set();
            const uniquePairs = pairs.filter(p => !seen.has(p.value) && seen.add(p.value));
            // Sort by vehicle label
            uniquePairs.sort((a, b) => a.label.localeCompare(b.label));
            const options = ['<option value="">Semua Kendaraan / Supir</option>']
                .concat(uniquePairs.map(p => `<option value="${p.value}">${p.label}</option>`))
                .join('');
            select.innerHTML = options;
            if (uniquePairs.find(p => p.value === previous)) select.value = previous;
        }

        function filterAndSortServices() {
            const searchTerm = document.getElementById('searchService')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('filterServiceStatus')?.value || '';
            const kvFilter = document.getElementById('filterDriverVehicle')?.value || '';
            const monthFilter = document.getElementById('filterServiceMonth')?.value || '';
            const sortBy = document.getElementById('sortServices')?.value || 'date';

            filteredServices = (services || []).filter(s => {
                const matchesSearch = !searchTerm ||
                    (s.vehicle || '').toLowerCase().includes(searchTerm) ||
                    (getDriverNameByVehicle(s.vehicle) || s.driver || '').toLowerCase().includes(searchTerm) ||
                    ((Array.isArray(s.types) ? s.types.join(' ') : (s.type || '')).toLowerCase().includes(searchTerm));
                const matchesStatus = !statusFilter || s.status === statusFilter;
                const matchesKV = !kvFilter || s.vehicle === kvFilter;
                const matchesMonth = !monthFilter || ((s.date || '').slice(0, 7) === monthFilter);
                return matchesSearch && matchesStatus && matchesKV && matchesMonth;
            });

            // Sort
            filteredServices.sort((a, b) => {
                switch (sortBy) {
                    case 'vehicle':
                        return (a.vehicle || '').localeCompare(b.vehicle || '');
                    case 'type':
                        return ((Array.isArray(a.types) ? a.types.join(' ') : (a.type || ''))
                            .localeCompare(Array.isArray(b.types) ? b.types.join(' ') : (b.type || '')));
                    case 'cost':
                        return (a.cost || 0) - (b.cost || 0);
                    case 'status':
                        return (a.status || '').localeCompare(b.status || '');
                    case 'date':
                    default:
                        return new Date(a.date || 0) - new Date(b.date || 0);
                }
            });

            // Update counters
            document.getElementById('servicesCount').textContent = filteredServices.length;
            document.getElementById('totalServicesDisplay').textContent = (services || []).length;
        }

        function renderServicesGrid() {
            const grid = document.getElementById('servicesGrid');
            const table = document.getElementById('servicesTable');
            if (!grid || !table) return;

            grid.classList.remove('hidden');
            table.classList.add('hidden');

            const typeColors = {
                'Service Rutin': 'purple',
                'Ganti Oli': 'yellow',
                'Perbaikan': 'red',
                'Tune Up': 'indigo',
                'Ganti Ban': 'orange',
                'Rem': 'blue',
                'AC': 'cyan',
                'Transmisi': 'teal'
            };

            const html = filteredServices.map(service => {
                const serviceId = jsString(service.id);
                const deleteMsg = jsString(`Hapus service untuk ${service.vehicle || service.driver || ''}?`);
                const color = typeColors[service.type] || 'gray';
                let statusClass;
                switch (service.status) {
                    case 'terjadwal':
                        statusClass = 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';
                        break;
                    case 'dalam proses':
                        statusClass = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
                        break;
                    case 'selesai':
                        statusClass = 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
                        break;
                    default:
                        statusClass = 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200';
                }

                const typeLabel = service.type || '';
                return `
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 p-5 card-hover dark-transition">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center space-x-2">
                                <div class="w-10 h-10 bg-${color}-100 dark:bg-${color}-900 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-wrench text-${color}-600 dark:text-${color}-400"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900 dark:text-white">${typeLabel}</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">${service.vehicle}</p>
                                    <p class="text-xs text-gray-400 dark:text-gray-500">${getDriverNameByVehicle(service.vehicle)}</p>
                                </div>
                            </div>
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">${service.status}</span>
                        </div>

                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600 dark:text-gray-400">Tanggal:</span>
                                <span class="font-medium text-gray-900 dark:text-white">${service.date ? formatDate(service.date) : '-'}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600 dark:text-gray-400">Biaya:</span>
                                <span class="font-medium text-gray-900 dark:text-white">${formatCurrency(service.cost || 0)}</span>
                            </div>
                        </div>

                        <div class="flex justify-between items-center mt-5 pt-4 border-t border-gray-200 dark:border-gray-700">
                            <div></div>
                            <div class="flex space-x-2">
                                <button onclick="updateServiceStatus(${serviceId})" class="inline-flex items-center px-3 py-2 text-xs font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors">
                                    <i class="fas fa-sync-alt mr-1.5"></i>Update
                                </button>
                                <button onclick="editService(${serviceId})" class="inline-flex items-center px-3 py-2 text-xs font-medium text-yellow-600 dark:text-yellow-400 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg hover:bg-yellow-100 dark:hover:bg-yellow-900/40 transition-colors">
                                    <i class="fas fa-edit mr-1.5"></i>Edit
                                </button>
                                <button onclick="openConfirmDelete('service', ${serviceId}, ${deleteMsg})" class="inline-flex items-center px-3 py-2 text-xs font-medium text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors">
                                    <i class="fas fa-trash mr-1.5"></i>Hapus
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            grid.innerHTML = html || '<div class="text-center text-gray-500 dark:text-gray-400 py-8">Tidak ada service</div>';
        }

        function renderServicesTable() {
            const grid = document.getElementById('servicesGrid');
            const table = document.getElementById('servicesTable');
            if (!grid || !table) return;

            table.classList.remove('hidden');
            grid.classList.add('hidden');

            const tbody = document.getElementById('servicesTableBody');
            const html = filteredServices.map(service => {
                const serviceId = jsString(service.id);
                const deleteMsg = jsString(`Hapus service untuk ${service.vehicle || service.driver || ''}?`);
                let statusClass;
                switch (service.status) {
                    case 'terjadwal':
                        statusClass = 'bg-blue-100 text-blue-800';
                        break;
                    case 'dalam proses':
                        statusClass = 'bg-yellow-100 text-yellow-800';
                        break;
                    case 'selesai':
                        statusClass = 'bg-green-100 text-green-800';
                        break;
                    default:
                        statusClass = 'bg-gray-100 text-gray-800';
                }

                const typeLabel = service.type || '';
                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${service.vehicle}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${typeLabel}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${service.date ? formatDate(service.date) : '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${formatCurrency(service.cost)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">${service.status}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="updateServiceStatus(${serviceId})" class="text-blue-600 hover:text-blue-900 mr-3">Update</button>
                            <button onclick="editService(${serviceId})" class="text-yellow-600 hover:text-yellow-900 mr-3">Edit</button>
                            <button onclick="openConfirmDelete('service', ${serviceId}, ${deleteMsg})" class="inline-flex items-center px-2 py-1 text-xs font-medium text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 rounded-md hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors">
                                <i class="fas fa-trash mr-1"></i>Hapus
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            tbody.innerHTML = html;
        }

        // Schedule Functions
        function loadSchedules() {
            // Update schedule stats
            const today = new Date().toISOString().split('T')[0];
            const todaySchedules = schedules.filter(s => s.date === today);
            const onTripSchedules = schedules.filter(s => s.status === 'nunggak');
            const completedToday = schedules.filter(s => s.date === today && s.status === 'lunas');
            const todayEarnings = completedToday.reduce((sum, s) => sum + (s.fare * 0.4), 0); // 40% company share

            document.getElementById('todaySchedulesCount').textContent = todaySchedules.length;
            document.getElementById('onTripSchedulesCount').textContent = onTripSchedules.length;
            document.getElementById('completedTodayCount').textContent = completedToday.length;
            document.getElementById('todayEarnings').textContent = formatCurrencyShort(todayEarnings);

            // Populate driver dropdown in add schedule form
            const driverSelect = document.querySelector('#addScheduleForm select[name="driver"]');
            const driverOptions = drivers.map(driver =>
                `<option value="${driver.name}">${driver.name} (${driver.vehicle})</option>`
            ).join('');
            driverSelect.innerHTML = '<option value="">Pilih Supir</option>' + driverOptions;
            // Populate driver filter options
            populateScheduleDriverFilter();

            // Load schedules grid/table
            filterAndSortSchedules();
            renderSchedules();
        }

        function filterAndSortSchedules() {
            const searchTerm = document.getElementById('searchSchedule')?.value.toLowerCase() || '';
            const driverFilter = document.getElementById('filterScheduleDriver')?.value || '';
            const orderTypeFilter = document.getElementById('filterOrderType')?.value || '';
            const startDateValue = document.getElementById('filterScheduleDateStart')?.value || '';
            const endDateValue = document.getElementById('filterScheduleDateEnd')?.value || '';
            let startDate = startDateValue ? new Date(startDateValue) : null;
            let endDate = endDateValue ? new Date(endDateValue) : null;
            if (startDate && endDate && startDate > endDate) {
                const temp = startDate;
                startDate = endDate;
                endDate = temp;
            }

            filteredSchedules = schedules.filter(schedule => {
                const matchesSearch = schedule.driver.toLowerCase().includes(searchTerm) ||
                    schedule.origin.toLowerCase().includes(searchTerm) ||
                    schedule.destination.toLowerCase().includes(searchTerm) ||
                    schedule.rit.toLowerCase().includes(searchTerm);
                const matchesDriver = !driverFilter || schedule.driver === driverFilter;
                const matchesStatus = schedule.status !== 'lunas';
                const matchesOrderType = !orderTypeFilter || schedule.orderType === orderTypeFilter;
                const scheduleDate = schedule.date ? new Date(schedule.date) : null;
                const matchesDateRange = (!startDate || (scheduleDate && scheduleDate >= startDate)) &&
                    (!endDate || (scheduleDate && scheduleDate <= endDate));
                const isNotDebt = schedule.orderType !== 'hutang';
                return matchesSearch && matchesDriver && matchesStatus && matchesOrderType && matchesDateRange && isNotDebt;
            });

            filteredSchedules.sort((a, b) => {
                const dateA = a.date ? new Date(a.date) : new Date(0);
                const dateB = b.date ? new Date(b.date) : new Date(0);
                return dateB - dateA;
            });

            updateOutstandingSummary();
        }

        // Debt (Kelola Hutang) Functions
        let debtsFiltered = [];
        let debtCurrentPage = 1;
        let debtTotalPages = 1;
        const debtPageSize = 10;
        function loadDebts() {
            // Populate driver filter
            populateDebtDriverFilter();
            // Prepare and render
            filterAndSortDebts();
            renderDebtsTable();
        }

        function populateDebtDriverFilter() {
            const select = document.getElementById('filterDebtDriver');
            if (!select) return;
            const current = select.value;
            const rawNames = drivers.map(d => d.name).concat((debts || []).map(d => d.driver));
            const names = Array.from(new Set(rawNames.filter(Boolean))).sort();
            const options = ['<option value="">Semua Supir</option>'].concat(names.map(n => `<option value="${n}">${n}</option>`));
            select.innerHTML = options.join('');
            if (names.includes(current)) select.value = current; else select.value = '';
        }

        function filterAndSortDebts() {
            const searchTerm = document.getElementById('searchDebt')?.value.toLowerCase() || '';
            const driverFilter = document.getElementById('filterDebtDriver')?.value || '';
            const dateFilter = document.getElementById('filterDebtDate')?.value || '';
            const sortBy = document.getElementById('sortDebts')?.value || 'date';

            debtsFiltered = (debts || []).filter(d => {
                const matchesSearch = (d.driver || '').toLowerCase().includes(searchTerm) ||
                    (d.notes || '').toLowerCase().includes(searchTerm);
                const matchesDriver = !driverFilter || d.driver === driverFilter;
                const matchesDate = !dateFilter || d.date === dateFilter;
                return matchesSearch && matchesDriver && matchesDate;
            }).filter(d => {
                const remaining = Math.max((d.amount || 0) - (d.paidAmount || 0), 0);
                return remaining > 0;
            });

            debtsFiltered.sort((a, b) => {
                switch (sortBy) {
                    case 'driver':
                        return (a.driver || '').localeCompare(b.driver || '');
                    case 'outstanding': {
                        const aOut = Math.max((a.amount || 0) - (a.paidAmount || 0), 0);
                        const bOut = Math.max((b.amount || 0) - (b.paidAmount || 0), 0);
                        return bOut - aOut;
                    }
                    case 'date':
                    default: {
                        const timeA = a.date ? new Date(a.date).getTime() : 0;
                        const timeB = b.date ? new Date(b.date).getTime() : 0;
                        return timeB - timeA;
                    }
                }
            });

            const total = debtsFiltered.reduce((sum, d) => {
                const remaining = Math.max((d.amount || 0) - (d.paidAmount || 0), 0);
                return sum + remaining;
            }, 0);
            const el = document.getElementById('debtTotalOutstanding');
            if (el) el.textContent = formatCurrency(total);
        }

        function renderDebtsTable() {
            const tbody = document.getElementById('debtsTableBody');
            if (!tbody) return;
            const total = debtsFiltered.length;
            const totalPages = Math.max(1, Math.ceil(total / debtPageSize));
            debtTotalPages = totalPages;
            if (debtCurrentPage > totalPages) debtCurrentPage = totalPages;
            if (debtCurrentPage < 1) debtCurrentPage = 1;
            const startIdx = (debtCurrentPage - 1) * debtPageSize;
            const endIdx = Math.min(startIdx + debtPageSize, total);
            const pageItems = debtsFiltered.slice(startIdx, endIdx);

            const html = pageItems.map(d => {
                const debtId = jsString(d.id);
                const deleteMsg = jsString(`Hapus hutang untuk ${d.driver || ''}?`);
                const amount = d.amount || 0;
                const paid = d.paidAmount || 0;
                const remaining = Math.max(amount - paid, 0);
                const statusRaw = (d.status || '').toLowerCase();
                const status = remaining <= 0 || statusRaw === 'lunas' ? 'Lunas' : 'Belum Lunas';
                const statusClass = status === 'Lunas'
                    ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200'
                    : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
                const dateCell = d.date ? formatDate(d.date) : '-';
                return `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 dark:text-white">${d.driver || '-'}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 dark:text-white">${dateCell}</td>
                        <td class="px-6 py-3 text-sm text-gray-900 dark:text-white max-w-xs truncate">${d.notes || ''}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 dark:text-white">${formatCurrency(amount)}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-semibold text-green-600 dark:text-green-400">${formatCurrency(paid)}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm ${remaining > 0 ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'}">${formatCurrency(remaining)}</td>
                        <td class="px-6 py-3 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">${status}</span>
                        </td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium">
                            <div class="flex space-x-2">
                                <button onclick="paySchedule(${debtId}, 'debt')" class="inline-flex items-center px-2 py-1 text-xs font-medium text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-900/20 rounded-md hover:bg-green-100 dark:hover:bg-green-900/40 transition-colors">
                                    <i class="fas fa-credit-card mr-1"></i>Bayar
                                </button>
                                <button onclick="openEditDebt(${debtId})" class="inline-flex items-center px-2 py-1 text-xs font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 rounded-md hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors">
                                    <i class="fas fa-edit mr-1"></i>Edit
                                </button>
                                <button onclick="openConfirmDelete('debt', ${debtId}, ${deleteMsg})" class="inline-flex items-center px-2 py-1 text-xs font-medium text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 rounded-md hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors">
                                    <i class="fas fa-trash mr-1"></i>Hapus
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            tbody.innerHTML = html || '<tr><td colspan="8" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">Tidak ada hutang ditemukan</td></tr>';

            const pag = document.getElementById('debtPagination');
            const rangeEl = document.getElementById('debtPageRange');
            const totalEl = document.getElementById('debtTotal');
            const infoEl = document.getElementById('debtPageInfo');
            const prevBtn = document.getElementById('debtPrevPage');
            const nextBtn = document.getElementById('debtNextPage');
            if (total > debtPageSize) pag?.classList.remove('hidden'); else pag?.classList.add('hidden');
            if (rangeEl) rangeEl.textContent = total === 0 ? '0-0' : `${startIdx + 1}-${endIdx}`;
            if (totalEl) totalEl.textContent = String(total);
            if (infoEl) infoEl.textContent = `${total === 0 ? 0 : debtCurrentPage}/${Math.max(1, totalPages)}`;
            if (prevBtn) prevBtn.disabled = debtCurrentPage <= 1;
            if (nextBtn) nextBtn.disabled = debtCurrentPage >= totalPages;
        }

        // Add Debt
        function setDebtModalMode(mode) {
            const title = document.getElementById('addDebtModalTitle');
            const subtitle = document.getElementById('addDebtModalSubtitle');
            const submitBtn = document.getElementById('addDebtSubmitBtn');
            if (mode === 'edit') {
                if (title) title.textContent = 'Edit Hutang';
                if (subtitle) subtitle.textContent = 'Perbarui informasi hutang supir';
                if (submitBtn) submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Perbarui Hutang';
            } else {
                if (title) title.textContent = 'Tambah Hutang';
                if (subtitle) subtitle.textContent = 'Catat hutang (nunggak) baru';
                if (submitBtn) submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Simpan Hutang';
            }
        }

        function populateDebtDriverSelect(select, selected) {
            if (!select) return;
            const names = drivers.map(d => d.name).filter(Boolean);
            if (selected && !names.includes(selected)) {
                names.push(selected);
            }
            const options = ['<option value="">Pilih Supir</option>'].concat(
                Array.from(new Set(names)).sort().map(n => `<option value="${n}">${n}</option>`)
            );
            select.innerHTML = options.join('');
            if (selected) {
                select.value = selected;
            }
        }

        function openAddDebt() {
            const form = document.getElementById('addDebtForm');
            if (!form) return;
            delete form.dataset.editId;
            setDebtModalMode('add');
            form.reset();
            const select = form.querySelector('select[name="driver"]');
            populateDebtDriverSelect(select, '');
            const dateInput = form.querySelector('input[name="date"]');
            if (dateInput) {
                dateInput.value = dateInput.value || new Date().toISOString().split('T')[0];
            }
            openModal('addDebtModal');
        }

        function openEditDebt(id) {
            const debt = (debts || []).find(d => sameId(d.id, id));
            if (!debt) return;
            const form = document.getElementById('addDebtForm');
            if (!form) return;
            form.dataset.editId = debt.id;
            setDebtModalMode('edit');
            populateDebtDriverSelect(form.querySelector('select[name="driver"]'), debt.driver || '');
            const dateInput = form.querySelector('input[name="date"]');
            if (dateInput) dateInput.value = debt.date || '';
            const notesInput = form.querySelector('textarea[name="notes"]');
            if (notesInput) notesInput.value = debt.notes || '';
            const amountInput = form.querySelector('input[name="amount"]');
            if (amountInput) amountInput.value = toInt(debt.amount);
            openModal('addDebtModal');
        }

        async function saveDebt(form, data) {
            const isEdit = Boolean(form.dataset.editId);
            const id = form.dataset.editId;
            const driver = (data.driver || '').trim();
            if (!driver) {
                alert('Supir wajib dipilih');
                return;
            }
            const amount = Math.max(toInt(data.amount), 0);
            const dateValue = data.date || new Date().toISOString().split('T')[0];
            const notes = (data.notes || '').trim();

            if (isEdit) {
                const existing = (debts || []).find(d => sameId(d.id, id));
                if (!existing) {
                    showToast('Gagal', 'Data hutang tidak ditemukan', 'error');
                    return;
                }
                const paidAmount = toInt(existing.paidAmount);
                const remaining = Math.max(amount - paidAmount, 0);
                const payload = {
                    id: existing.id,
                    driver,
                    vehicle: existing.vehicle || '',
                    type: existing.type || 'hutang',
                    amount,
                    date: dateValue,
                    dueDate: existing.dueDate ?? existing.due_date ?? null,
                    status: remaining <= 0 ? 'lunas' : 'belum_lunas',
                    paidAmount,
                    lastPaidAt: existing.lastPaidAt || existing.last_paid_at || null,
                    paidOffAt: remaining <= 0 ? (existing.paidOffAt || existing.paid_off_at || new Date().toISOString()) : null,
                    notes
                };
                try {
                    const updated = await apiRequest('debts.php', { method: 'PUT', data: payload });
                    const idx = (debts || []).findIndex(d => sameId(d.id, existing.id));
                    if (idx !== -1) {
                        debts[idx] = { ...debts[idx], ...updated };
                    }
                    localStorage.setItem('debts', JSON.stringify(debts));
                    loadDebts();
                    renderDebtHistoryModal();
                    addActivity(`Hutang ${driver} diperbarui`);
                    showToast('Berhasil', `Hutang untuk ${driver} diperbarui`, 'success');
                    setDebtModalMode('add');
                    delete form.dataset.editId;
                    form.reset();
                    closeModal('addDebtModal');
                } catch (err) {
                    console.error(err);
                    showToast('Gagal', 'Gagal memperbarui hutang', 'error');
                }
                return;
            }

            const payload = {
                driver,
                vehicle: '',
                type: 'hutang',
                amount,
                date: dateValue,
                dueDate: null,
                status: amount > 0 ? 'belum_lunas' : 'lunas',
                paidAmount: 0,
                lastPaidAt: null,
                paidOffAt: null,
                notes
            };
            try {
                const created = await apiRequest('debts.php', { method: 'POST', data: payload });
                debts = Array.isArray(debts) ? debts : [];
                debts.unshift(created);
                localStorage.setItem('debts', JSON.stringify(debts));
                loadDebts();
                renderDebtHistoryModal();
                addActivity(`Hutang baru untuk ${created.driver || driver} ditambahkan`);
                showToast('Berhasil', `Hutang untuk ${created.driver || driver} ditambahkan`, 'success');
                form.reset();
                setDebtModalMode('add');
                closeModal('addDebtModal');
            } catch (err) {
                console.error(err);
                showToast('Gagal', 'Gagal menambahkan hutang', 'error');
            }
        }

        // Debt History (modal)
        let debtHistoryCurrentPage = 1;
        let debtHistoryTotalPages = 1;
        const debtHistoryPageSize = 5;

        function openDebtHistory() {
            // Populate driver filter
            const select = document.getElementById('debtHistoryFilterDriver');
            if (select) {
                const current = select.value;
                const names = Array.from(new Set(drivers.map(d => d.name))).sort();
                const options = ['<option value="">Semua Supir</option>'].concat(names.map(n => `<option value="${n}">${n}</option>`));
                select.innerHTML = options.join('');
                if (names.includes(current)) select.value = current; else select.value = '';
            }
            debtHistoryCurrentPage = 1;
            renderDebtHistoryModal();
            openModal('debtHistoryModal');
        }

        function renderDebtHistoryModal() {
            const tbody = document.getElementById('debtHistoryBody');
            if (!tbody) return;
            const driverFilter = document.getElementById('debtHistoryFilterDriver')?.value || '';
            const dateFilter = document.getElementById('debtHistoryFilterDate')?.value || '';

            const normalized = (debts || []).map(d => ({
                ...d,
                amount: toInt(d.amount),
                paidAmount: toInt(d.paidAmount),
                status: (d.status || '').toLowerCase(),
                baseDate: d.date || d.dueDate || d.due_date || '',
                lastPayment: d.paidOffAt || d.paid_off_at || d.lastPaidAt || d.last_paid_at || '',
                lastPaymentAmount: toInt(d.lastPaymentAmount ?? d.last_payment_amount ?? 0)
            }));

            const all = normalized.filter(d => {
                const matchesDriver = !driverFilter || d.driver === driverFilter;
                const matchesDate = !dateFilter || d.baseDate === dateFilter;
                return matchesDriver && matchesDate;
            }).sort((a, b) => {
                const timeA = new Date(a.lastPayment || a.baseDate || 0).getTime();
                const timeB = new Date(b.lastPayment || b.baseDate || 0).getTime();
                return timeB - timeA;
            });

            const total = all.length;
            const totalPages = Math.max(1, Math.ceil(total / debtHistoryPageSize));
            debtHistoryTotalPages = totalPages;
            if (debtHistoryCurrentPage > totalPages) debtHistoryCurrentPage = totalPages;
            if (debtHistoryCurrentPage < 1) debtHistoryCurrentPage = 1;
            const startIdx = (debtHistoryCurrentPage - 1) * debtHistoryPageSize;
            const endIdx = Math.min(startIdx + debtHistoryPageSize, total);
            const pageItems = all.slice(startIdx, endIdx);

            const html = pageItems.map(d => {
                const lastPaymentAmount = toInt(d.lastPaymentAmount ?? 0);
                const remaining = Math.max(d.amount - d.paidAmount, 0);
                const isPaid = remaining <= 0 || d.status === 'lunas';
                const badgeClass = isPaid ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
                const statusLabel = isPaid ? 'Lunas' : 'Belum Lunas';
                const paidAt = d.lastPayment || d.baseDate;
                return `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 dark:text-white">${d.driver || '-'}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 dark:text-white">${d.baseDate ? formatDate(d.baseDate) : '-'}</td>
                        <td class="px-6 py-3 text-sm text-gray-900 dark:text-white max-w-xs truncate">${d.notes || ''}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 dark:text-white">${formatCurrency(d.amount)}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-semibold text-green-600 dark:text-green-400">${formatCurrency(d.paidAmount)}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm ${remaining > 0 ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'}">${formatCurrency(remaining)}</td>
                        <td class="px-6 py-3 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${badgeClass}">${statusLabel}</span>
                        </td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 dark:text-white">${paidAt ? formatDate(paidAt) : '-'}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 dark:text-white">${formatCurrency(lastPaymentAmount)}</td>
                    </tr>
                `;
            }).join('');
            tbody.innerHTML = html || '<tr><td colspan="9" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">Tidak ada data</td></tr>';

            const pag = document.getElementById('debtHistoryPagination');
            const rangeEl = document.getElementById('debtHistoryPageRange');
            const totalEl = document.getElementById('debtHistoryTotal');
            const infoEl = document.getElementById('debtHistoryPageInfo');
            const prevBtn = document.getElementById('debtHistoryPrevPage');
            const nextBtn = document.getElementById('debtHistoryNextPage');
            if (total > debtHistoryPageSize) pag?.classList.remove('hidden'); else pag?.classList.add('hidden');
            if (rangeEl) rangeEl.textContent = total === 0 ? '0-0' : `${startIdx + 1}-${endIdx}`;
            if (totalEl) totalEl.textContent = String(total);
            if (infoEl) infoEl.textContent = `${total === 0 ? 0 : debtHistoryCurrentPage}/${Math.max(1, totalPages)}`;
            if (prevBtn) prevBtn.disabled = debtHistoryCurrentPage <= 1;
            if (nextBtn) nextBtn.disabled = debtHistoryCurrentPage >= totalPages;

            const remTotalEl = document.getElementById('debtHistoryTotalRemaining');
            if (remTotalEl) {
                const totalRemaining = all.reduce((sum, d) => sum + Math.max(d.amount - d.paidAmount, 0), 0);
                remTotalEl.textContent = formatCurrency(totalRemaining);
            }
        }
        function populateScheduleDriverFilter() {
            const select = document.getElementById('filterScheduleDriver');
            if (!select) return;
            const current = select.value;
            const names = Array.from(new Set(drivers.map(d => d.name))).sort();
            const options = ['<option value="">Semua Supir</option>'].concat(
                names.map(n => `<option value="${n}">${n}</option>`)
            );
            select.innerHTML = options.join('');
            // restore previous selection if still present
            if (names.includes(current)) select.value = current;
        }

        function updateOutstandingSummary() {
            const filteredTotal = filteredSchedules.reduce((sum, s) => {
                const share = s.companyShare ?? (s.fare * 0.4);
                const paid = s.paidCompanyAmount || 0;
                return sum + Math.max(share - paid, 0);
            }, 0);
            const el = document.getElementById('totalOutstanding');
            if (el) el.textContent = formatCurrency(filteredTotal);
        }

        function renderSchedules() {
            const grid = document.getElementById('schedulesGrid');
            const table = document.getElementById('schedulesTable');

            if (currentSchedulesView === 'grid') {
                grid.classList.remove('hidden');
                table.classList.add('hidden');
                renderSchedulesGrid();
            } else {
                grid.classList.add('hidden');
                table.classList.remove('hidden');
                renderSchedulesTable();
            }
        }

        function renderSchedulesGrid() {
            const grid = document.getElementById('schedulesGrid');
            const todayString = new Date().toISOString().split('T')[0];

            const html = filteredSchedules.map(schedule => {
                const scheduleId = jsString(schedule.id);
                const deleteMsg = jsString(`Hapus jadwal untuk ${schedule.driver || ''}?`);
                const scheduleDateString = String(schedule.date || '').split('T')[0];
                const isToday = scheduleDateString === todayString;

                let statusClass;
                switch (schedule.status) {
                    case 'nunggak':
                        statusClass = 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
                        break;
                    case 'lunas':
                        statusClass = 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
                        break;
                    default:
                        statusClass = 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200';
                }

                let orderTypeClass;
                switch ((schedule.orderType || '').toLowerCase()) {
                    case 'online':
                        orderTypeClass = 'bg-green-200 text-green-800';
                        break;
                    case 'offline':
                        orderTypeClass = 'bg-pink-200 text-pink-800';
                        break;
                    default:
                        orderTypeClass = 'bg-gray-200 text-gray-800';
                }

                const cardClass = isToday
                    ? 'bg-green-50 dark:bg-green-900/20 rounded-xl shadow-sm p-5 card-hover border border-green-400 dark:border-green-500 ring-1 ring-green-200/60 dark:ring-green-500/40'
                    : 'bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-5 card-hover';

                const dateClass = isToday
                    ? 'text-sm font-semibold text-green-600 dark:text-green-300 inline-flex items-center gap-2'
                    : 'text-sm text-gray-500 dark:text-gray-400';

                const dateBadge = isToday
                    ? '<span class="inline-flex items-center px-2 py-0.5 rounded-full bg-green-200 text-green-800 dark:bg-green-900/60 dark:text-green-300 text-xs font-medium">Hari ini</span>'
                    : '';

                return `
                    <div class="${cardClass}">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center space-x-2">
                                <div class="w-10 h-10 bg-indigo-100 dark:bg-indigo-900 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-truck text-indigo-600 dark:text-indigo-400"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900 dark:text-white">${schedule.driver}</h3>
                                    <p class="${dateClass}">${formatDate(schedule.date)}${dateBadge ? ' ' + dateBadge : ''}</p>
                                </div>
                            </div>
                            <div class="flex flex-col items-end space-y-2">
                                <span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">
                                    ${formatStatus(schedule.status)}
                                </span>
                                <span class="px-2 py-1 text-xs font-medium rounded-full ${orderTypeClass}">
                                    ${schedule.orderType}
                                </span>
                            </div>
                        </div>

                        <div class="space-y-2">
                            <div class="text-sm">
                                <p class="text-gray-600 dark:text-gray-400 mb-1">RIT: <span class="font-medium text-gray-900 dark:text-white">${schedule.rit}</span></p>
                            </div>
                            <div class="text-sm">
                                <p class="text-gray-600 dark:text-gray-400"><i class="fas fa-map-marker-alt text-green-500 mr-2"></i>Muat: ${schedule.origin}</p>
                                <p class="text-gray-600 dark:text-gray-400 mt-1"><i class="fas fa-flag text-red-500 mr-2"></i>Bongkar: ${schedule.destination}</p>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600 dark:text-gray-400">Argo:</span>
                                <span class="font-medium text-gray-900 dark:text-white">${formatCurrency(schedule.fare)}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600 dark:text-gray-400">Setoran (40%):</span>
                                <span class="font-medium text-green-600 dark:text-green-400">${formatCurrency(schedule.companyShare ?? (schedule.fare * 0.4))}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600 dark:text-gray-400">Terbayar:</span>
                                <span class="font-medium text-gray-900 dark:text-white">${formatCurrency(schedule.paidCompanyAmount || 0)}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600 dark:text-gray-400">Sisa:</span>
                                <span class="font-medium ${((schedule.companyShare ?? (schedule.fare * 0.4)) - (schedule.paidCompanyAmount || 0)) > 0 ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'}">${formatCurrency(Math.max((schedule.companyShare ?? (schedule.fare * 0.4)) - (schedule.paidCompanyAmount || 0), 0))}</span>
                            </div>
                        </div>

                        <div class="flex justify-between items-center mt-5 pt-4 border-t border-gray-200 dark:border-gray-700">
                            <div class="flex items-center gap-2">
                                <button onclick="openEditSchedule(${scheduleId})" class="inline-flex items-center px-3 py-2 text-xs font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors">
                                    <i class="fas fa-edit mr-1.5"></i>Edit
                                </button>
                                <button onclick="paySchedule(${scheduleId})" class="inline-flex items-center px-3 py-2 text-xs font-medium text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-900/20 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/40 transition-colors">
                                    <i class="fas fa-credit-card mr-1.5"></i>Payment
                                </button>
                            </div>
                                <button onclick="openConfirmDelete('schedule', ${scheduleId}, ${deleteMsg})" class="inline-flex items-center px-3 py-2 text-xs font-medium text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors">
                                    <i class="fas fa-trash mr-1.5"></i>Hapus
                                </button>
                        </div>
                    </div>
                `;
            }).join('');

            grid.innerHTML = html || '<div class="col-span-full text-center py-12 text-gray-500 dark:text-gray-400">Tidak ada jadwal ditemukan</div>';
        }

        function renderSchedulesTable() {
            const tbody = document.getElementById('schedulesTableBody');

            const html = filteredSchedules.map(schedule => {
                const scheduleId = jsString(schedule.id);
                const deleteMsg = jsString(`Hapus jadwal untuk ${schedule.driver || ''}?`);
                let statusClass;
                switch (schedule.status) {
                    case 'nunggak':
                        statusClass = 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
                        break;
                    case 'lunas':
                        statusClass = 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
                        break;
                    default:
                        statusClass = 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200';
                }

                return `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${schedule.driver}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${formatDate(schedule.date)}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-white max-w-xs truncate">${schedule.origin}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-white max-w-xs truncate">${schedule.destination}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${schedule.rit}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${schedule.orderType}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${formatCurrency(schedule.fare)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <div>
                                <div class="font-medium text-green-600 dark:text-green-400">${formatCurrency(schedule.companyShare ?? (schedule.fare * 0.4))}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">Terbayar: ${formatCurrency(schedule.paidCompanyAmount || 0)}</div>
                                <div class="text-xs ${((schedule.companyShare ?? (schedule.fare * 0.4)) - (schedule.paidCompanyAmount || 0)) > 0 ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'}">Sisa: ${formatCurrency(Math.max((schedule.companyShare ?? (schedule.fare * 0.4)) - (schedule.paidCompanyAmount || 0), 0))}</div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">
                                ${formatStatus(schedule.status)}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex space-x-2">
                                <button onclick="openEditSchedule(${scheduleId})" class="inline-flex items-center px-2 py-1 text-xs font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 rounded-md hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors">
                                    <i class="fas fa-edit mr-1"></i>Edit
                                </button>
                                <button onclick="paySchedule(${scheduleId})" class="inline-flex items-center px-2 py-1 text-xs font-medium text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-900/20 rounded-md hover:bg-green-100 dark:hover:bg-green-900/40 transition-colors">
                                    <i class="fas fa-credit-card mr-1"></i>Payment
                                </button>
                                <button onclick="openConfirmDelete('schedule', ${scheduleId}, ${deleteMsg})" class="inline-flex items-center px-2 py-1 text-xs font-medium text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 rounded-md hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors">
                                    <i class="fas fa-trash mr-1"></i>Hapus
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = html || '<tr><td colspan="10" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">Tidak ada jadwal ditemukan</td></tr>';
        }

        // Global variables for schedules view
        let filteredSchedules = [...schedules];
        let currentSchedulesView = 'grid';

        async function addSchedule(scheduleData) {
            const body = {
                status: 'nunggak',
                companyShare: scheduleData.fare * 0.4,
                driverShare: scheduleData.fare * 0.6,
                paidCompanyAmount: 0,
                ...scheduleData
            };
            try {
                const created = await apiRequest('schedules.php', { method: 'POST', data: body });
                schedules.unshift(created);
                localStorage.setItem('schedules', JSON.stringify(schedules));
                loadSchedules();
                try { if (document.getElementById('debt-content') && !document.getElementById('debt-content').classList.contains('hidden')) { loadDebts(); } } catch (e) { }
                addActivity(`Jadwal tarikan untuk ${created.driver || scheduleData.driver} ditambahkan`);
                showToast('Berhasil', `Jadwal tarikan untuk ${created.driver || scheduleData.driver} ditambahkan`, 'success');
            } catch (e) { console.error(e); alert('Gagal menambah jadwal'); }
        }

        function updateScheduleStatus(id) {
            const schedule = schedules.find(s => sameId(s.id, id));
            const statuses = ['nunggak', 'lunas'];
            const currentIndex = statuses.indexOf(schedule.status);
            const nextIndex = (currentIndex + 1) % statuses.length;
            schedule.status = statuses[nextIndex];
            localStorage.setItem('schedules', JSON.stringify(schedules));
            loadSchedules();
            addActivity(`Status jadwal ${schedule.driver} diubah menjadi ${formatStatus(schedule.status)}`);
            showToast('Status Diubah', `Status jadwal ${schedule.driver} menjadi ${formatStatus(schedule.status)}`, 'success');
        }

        function paySchedule(id, type = 'schedule') {
            const isDebt = type === 'debt';
            const record = isDebt ? (debts || []).find(d => sameId(d.id, id)) : schedules.find(s => sameId(s.id, id));
            if (!record) return;
            const form = document.getElementById('paymentScheduleForm');
            const modalTitle = document.getElementById('paymentModalTitle');
            const modalSubtitle = document.getElementById('paymentModalSubtitle');
            const totalLabel = document.getElementById('paymentCompanyShareLabel');
            const notesLabel = document.getElementById('paymentNotesLabel');

            form.dataset.recordType = isDebt ? 'debt' : 'schedule';
            form.dataset.recordId = id;
            if (!isDebt) {
                form.dataset.scheduleId = id;
            } else {
                delete form.dataset.scheduleId;
            }

            const total = isDebt
                ? toInt(record.amount)
                : toInt(record.companyShare ?? (toInt(record.fare) * 0.4));
            const paid = isDebt
                ? toInt(record.paidAmount)
                : toInt(record.paidCompanyAmount);
            const remaining = Math.max(total - paid, 0);

            if (modalTitle) modalTitle.textContent = isDebt ? 'Pembayaran Hutang' : 'Pembayaran Setoran (40%)';
            if (modalSubtitle) {
                modalSubtitle.textContent = isDebt
                    ? 'Catat pembayaran hutang untuk supir ini.'
                    : 'Input jumlah pembayaran untuk jadwal ini';
            }
            if (totalLabel) totalLabel.textContent = isDebt ? 'Total Hutang' : 'Setoran (40%)';

            document.getElementById('paymentCompanyShare').textContent = formatCurrency(total);
            document.getElementById('paymentPaid').textContent = formatCurrency(paid);
            document.getElementById('paymentRemaining').textContent = formatCurrency(Math.max(remaining, 0));
            const amountInput = form.querySelector('input[name="amount"]');
            if (amountInput) amountInput.value = remaining > 0 ? remaining : '';
            if (notesLabel) notesLabel.textContent = isDebt ? 'Catatan Hutang' : 'Catatan';
            const notesInput = form.querySelector('textarea[name="notes"]');
            if (notesInput) {
                notesInput.placeholder = isDebt ? 'Catatan hutang (opsional)' : 'Opsional';
                notesInput.value = (record.paymentNotes || record.lastPaymentNotes || record.notes || '');
            }
            openModal('paymentScheduleModal');
        }

        async function deleteSchedule(id) {
            try { await apiRequest('schedules.php', { method: 'DELETE', data: { id } }); } catch (e) { console.warn(e); }
            const schedule = schedules.find(s => sameId(s.id, id));
            schedules = schedules.filter(s => !sameId(s.id, id));
            localStorage.setItem('schedules', JSON.stringify(schedules));
            loadSchedules();
            try { if (document.getElementById('debt-content') && !document.getElementById('debt-content').classList.contains('hidden')) { loadDebts(); } } catch (e) { }
            addActivity(`Jadwal tarikan untuk ${schedule?.driver || ''} dihapus`);
            showToast('Berhasil', `Jadwal tarikan untuk ${schedule?.driver || ''} dihapus`, 'success');
        }

        function openEditSchedule(id) {
            const schedule = schedules.find(s => sameId(s.id, id));
            if (!schedule) return;
            const form = document.getElementById('editScheduleForm');
            form.dataset.editId = id;

            // Populate drivers
            const driverSelect = form.querySelector('select[name="driver"]');
            const driverOptions = drivers.map(driver => `<option value="${driver.name}">${driver.name} (${driver.vehicle})</option>`).join('');
            driverSelect.innerHTML = '<option value="">Pilih Supir</option>' + driverOptions;

            // Set values
            driverSelect.value = schedule.driver || '';
            form.querySelector('input[name="date"]').value = schedule.date || '';
            form.querySelector('input[name="origin"]').value = schedule.origin || '';
            form.querySelector('input[name="destination"]').value = schedule.destination || '';
            form.querySelector('input[name="rit"]').value = schedule.rit || '';
            form.querySelector('select[name="orderType"]').value = schedule.orderType || 'online';
            form.querySelector('select[name="status"]').value = schedule.status || 'nunggak';
            form.querySelector('textarea[name="notes"]').value = schedule.notes || '';

            // Debt-specific UI adjustments
            const titleEl = document.getElementById('editScheduleTitle');
            const subtitleEl = document.getElementById('editScheduleSubtitle');
            const routeSection = document.getElementById('editRouteSection');
            const orderSection = document.getElementById('editOrderSection');
            const orderTypeGroup = document.getElementById('editOrderTypeGroup');
            const statusGroup = document.getElementById('editStatusGroup');
            const fareLabel = document.getElementById('editFareLabel');
            const fareInput = form.querySelector('input[name="fare"]');
            // Reset edit modal sections before applying type-specific changes
            routeSection?.classList.remove('hidden');
            orderSection?.classList.remove('hidden');
            orderTypeGroup?.classList.remove('hidden');
            statusGroup?.classList.remove('hidden');
            if (fareLabel) fareLabel.textContent = 'Argo';
            if (fareInput) {
                fareInput.value = schedule.fare || 0;
                fareInput.placeholder = '500000';
            }

            if (schedule.orderType === 'hutang') {
                if (titleEl) titleEl.textContent = 'Edit Hutang';
                if (subtitleEl) subtitleEl.textContent = 'Perbarui keterangan dan jumlah hutang';
                orderSection?.classList.add('hidden');
                orderTypeGroup?.classList.add('hidden');
                statusGroup?.classList.add('hidden');
                if (fareLabel) fareLabel.textContent = 'Jumlah Hutang';
                if (fareInput) {
                    const amount = schedule.companyShare ?? Math.round((schedule.fare || 0) * 0.4);
                    fareInput.value = amount;
                    fareInput.placeholder = 'Contoh: 200000';
                }
            } else {
                if (titleEl) titleEl.textContent = 'Edit Jadwal Tarikan';
                if (subtitleEl) subtitleEl.textContent = 'Perbarui informasi order tarikan';
            }

            openModal('editScheduleModal');
        }

        // General delete confirmation modal (used by drivers, documents, services, schedules)
        let pendingDelete = { type: null, id: null };
        function openConfirmDelete(typeOrId, id, messageOverride) {
            let type;
            // Backward compatibility: openConfirmDelete(id) => schedule
            if (typeof typeOrId === 'number') {
                type = 'schedule';
                pendingDelete = { type, id: typeOrId };
            } else {
                type = String(typeOrId || '').toLowerCase();
                pendingDelete = { type, id };
            }

            const titleEl = document.getElementById('confirmDeleteTitle');
            const msgEl = document.getElementById('confirmDeleteMessage');

            let title = 'Hapus';
            let msg = 'Yakin ingin menghapus item ini?';
            switch (pendingDelete.type) {
                case 'driver':
                    title = 'Hapus Supir';
                    if (!messageOverride) {
                        const d = drivers.find(x => x.id === pendingDelete.id);
                        msg = d ? `Hapus supir ${d.name}?` : msg;
                    }
                    break;
                case 'document':
                case 'tax-kir':
                    title = 'Hapus Dokumen';
                    if (!messageOverride) {
                        const doc = documents.find(x => x.id === pendingDelete.id);
                        msg = doc ? `Hapus dokumen ${doc.type || ''} untuk ${doc.vehicle || ''}?` : msg;
                    }
                    break;
                case 'service':
                    title = 'Hapus Service';
                    if (!messageOverride) {
                        const srv = services.find(x => x.id === pendingDelete.id);
                        msg = srv ? `Hapus service untuk ${srv.vehicle || srv.driver || ''}?` : msg;
                    }
                    break;
                case 'schedule':
                default:
                    title = 'Hapus Jadwal';
                    if (!messageOverride) {
                        const sch = schedules.find(x => x.id === (pendingDelete.id ?? id));
                        msg = sch ? `Hapus jadwal untuk ${sch.driver}?` : msg;
                    }
                    break;
            }
            if (messageOverride) msg = messageOverride;
            if (titleEl) titleEl.textContent = title;
            if (msgEl) msgEl.textContent = msg;
            openModal('confirmDeleteModal', { lockScroll: false });
        }

        // Export confirmation
        function openConfirmExport() {
            openModal('confirmExportModal', { lockScroll: false });
        }
        function confirmExport() {
            try { exportReportsPDF(); } catch (e) { console.error(e); }
            closeModal('confirmExportModal');
        }

        function confirmDelete() {
            if (!pendingDelete || pendingDelete.id == null) { closeModal('confirmDeleteModal'); return; }
            try {
                switch (pendingDelete.type) {
                    case 'driver': deleteDriver(pendingDelete.id); break;
                    case 'document':
                    case 'tax-kir': deleteDocument(pendingDelete.id); break;
                    case 'service': deleteService(pendingDelete.id); break;
                    case 'schedule':
                    default: deleteSchedule(pendingDelete.id); break;
                }
            } finally {
                pendingDelete = { type: null, id: null };
                closeModal('confirmDeleteModal');
            }
        }

        function openHistorySchedules() {
            // Populate driver filter options
            const select = document.getElementById('historyFilterDriver');
            if (select) {
                const current = select.value;
                const names = Array.from(new Set(drivers.map(d => d.name))).sort();
                const options = ['<option value="">Semua Supir</option>'].concat(names.map(n => `<option value="${n}">${n}</option>`));
                select.innerHTML = options.join('');
                if (names.includes(current)) select.value = current; else select.value = '';
            }
            historyCurrentPage = 1;
            // Bind events safely in case initial binding failed
            const prevBtn = document.getElementById('historyPrevPage');
            const nextBtn = document.getElementById('historyNextPage');
            const filterDriver = document.getElementById('historyFilterDriver');
            const filterDate = document.getElementById('historyFilterDate');
            // Buttons now use inline onclick to avoid duplicate bindings
            if (prevBtn && !prevBtn.dataset.bound) { prevBtn.dataset.bound = '1'; }
            if (nextBtn && !nextBtn.dataset.bound) { nextBtn.dataset.bound = '1'; }
            if (filterDriver && !filterDriver.dataset.bound) {
                filterDriver.addEventListener('change', () => { historyCurrentPage = 1; renderHistoryModal(); });
                filterDriver.dataset.bound = '1';
            }
            if (filterDate && !filterDate.dataset.bound) {
                filterDate.addEventListener('change', () => { historyCurrentPage = 1; renderHistoryModal(); });
                filterDate.dataset.bound = '1';
            }
            renderHistoryModal();
            openModal('historyScheduleModal');
        }

        let historyCurrentPage = 1;
        let historyTotalPages = 1;
        const historyPageSize = 5;

        function renderHistoryModal() {
            const tbody = document.getElementById('historySchedulesBody');
            if (!tbody) return;
            const driverFilter = document.getElementById('historyFilterDriver')?.value || '';
            const dateFilter = document.getElementById('historyFilterDate')?.value || '';
            const lunasAll = schedules.filter(s => s.status === 'lunas').filter(s => {
                const matchesDriver = !driverFilter || s.driver === driverFilter;
                const matchesDate = !dateFilter || s.date === dateFilter;
                return matchesDriver && matchesDate;
            });
            const total = lunasAll.length;
            const totalPages = Math.max(1, Math.ceil(total / historyPageSize));
            historyTotalPages = totalPages;
            if (historyCurrentPage > totalPages) historyCurrentPage = totalPages;
            const startIdx = (historyCurrentPage - 1) * historyPageSize;
            const endIdx = Math.min(startIdx + historyPageSize, total);
            const lunas = lunasAll.slice(startIdx, endIdx);

            const html = lunas.map(schedule => {
                const companyShare = toInt(schedule.companyShare ?? (schedule.fare * 0.4));
                const orderTypeRaw = (schedule.orderType || '').toLowerCase();
                const typeClass = orderTypeRaw === 'offline'
                    ? 'px-2 py-1 text-xs font-semibold rounded-full bg-red-200 text-red-800'
                    : 'px-2 py-1 text-xs font-semibold rounded-full bg-green-200 text-green-800';
                const typeLabel = orderTypeRaw ? orderTypeRaw.charAt(0).toUpperCase() + orderTypeRaw.slice(1) : '-';
                const paidAt = schedule.paidOffAt || schedule.lastPaidAt || schedule.paidAt || '';
                return `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 dark:text-white">${schedule.driver || '-'}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 dark:text-white">${schedule.date ? formatDate(schedule.date) : '-'}</td>
                    <td class="px-6 py-3 text-sm text-gray-900 dark:text-white max-w-xs truncate">${schedule.origin || ''}</td>
                    <td class="px-6 py-3 text-sm text-gray-900 dark:text-white max-w-xs truncate">${schedule.destination || ''}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 dark:text-white">${schedule.rit || ''}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                        <span class="${typeClass}">${typeLabel}</span>
                    </td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 dark:text-white">${formatCurrency(schedule.fare)}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-green-600 dark:text-green-400">${formatCurrency(companyShare)}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 dark:text-white">${paidAt ? formatDate(paidAt) : '-'}</td>
                </tr>`;
            }).join('');
            tbody.innerHTML = html || '<tr><td colspan="9" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">Belum ada tarikan lunas</td></tr>';

            const pag = document.getElementById('historyPagination');
            const rangeEl = document.getElementById('historyPageRange');
            const totalEl = document.getElementById('historyTotal');
            const infoEl = document.getElementById('historyPageInfo');
            const prevBtn = document.getElementById('historyPrevPage');
            const nextBtn = document.getElementById('historyNextPage');

            if (total > historyPageSize) {
                pag?.classList.remove('hidden');
            } else {
                pag?.classList.add('hidden');
            }

            if (rangeEl) rangeEl.textContent = total === 0 ? '0-0' : `${startIdx + 1}-${endIdx}`;
            if (totalEl) totalEl.textContent = String(total);
            if (infoEl) infoEl.textContent = `${total === 0 ? 0 : historyCurrentPage}/${Math.max(1, totalPages)}`;
            if (prevBtn) prevBtn.disabled = historyCurrentPage <= 1;
            if (nextBtn) nextBtn.disabled = historyCurrentPage >= totalPages;
        }



        // Reports Functions
        function loadReports() {
            const period = parseInt(document.getElementById('reportPeriod').value);
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - period);

            // Filter data by period
            const periodSchedules = schedules.filter(s => {
                const scheduleDate = new Date(s.date);
                return scheduleDate >= startDate && scheduleDate <= endDate;
            });

            const periodServices = services.filter(s => {
                const serviceDate = new Date(s.date);
                return serviceDate >= startDate && serviceDate <= endDate;
            });

            // Calculate metrics
            const totalTrips = periodSchedules.filter(s => s.status === 'lunas').length;
            const totalRevenue = periodSchedules.filter(s => s.status === 'lunas').reduce((sum, s) => sum + s.fare, 0);
            const totalServiceCost = periodServices.filter(s => s.status === 'selesai').reduce((sum, s) => sum + s.cost, 0);
            const profit = totalRevenue - totalServiceCost;

            // Update report cards
            document.getElementById('reportTotalTrips').textContent = totalTrips;
            document.getElementById('reportRevenue').textContent = formatCurrencyShort(totalRevenue);
            document.getElementById('reportServiceCost').textContent = formatCurrency(totalServiceCost);
            document.getElementById('reportProfit').textContent = formatCurrencyShort(profit);

            // Update charts
            updateRevenueChart(periodSchedules);
            updateVehicleStatusChart();

            // Populate export driver filter options
            try {
                const sel = document.getElementById('expDriverFilter');
                if (sel) {
                    const prev = sel.value;
                    const names = Array.from(new Set((drivers || []).map(d => d.name).filter(Boolean))).sort();
                    sel.innerHTML = ['<option value="">Semua Supir</option>'].concat(names.map(n => `<option value="${n}">${n}</option>`)).join('');
                    if (names.includes(prev)) sel.value = prev; else sel.value = '';
                }
            } catch (e) { }
        }

        // Export Reports to PDF
        function exportReportsPDF() {
            try {
                const jspdfNS = window.jspdf || {};
                const jsPDF = jspdfNS.jsPDF || jspdfNS.jsPDF;
                if (!jsPDF || !window.jspdf || !(window.jspdf.jsPDF)) {
                    alert('Library PDF belum termuat. Mohon cek koneksi internet/CDN.');
                    return;
                }
                const doc = new window.jspdf.jsPDF('p', 'pt', 'a4');
                const pageWidth = doc.internal.pageSize.getWidth();
                const marginX = 36;
                let cursorY = 40;

                // Header
                doc.setFontSize(16);
                doc.text('Laporan OkeKirim', pageWidth / 2, cursorY, { align: 'center' });
                cursorY += 18;

                // Period (for schedule/debt)
                const period = parseInt(document.getElementById('reportPeriod')?.value || '30', 10);
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - period);
                const selectedDriver = (document.getElementById('expDriverFilter')?.value || '').trim();
                const typesSelect = document.getElementById('expDataTypes');
                const selType = (typesSelect?.value || '').trim();
                if (!selType) {
                    alert('Pilih satu jenis data untuk diekspor.');
                    return;
                }
                const include = {
                    drivers: selType === 'drivers',
                    documents: selType === 'documents',
                    serviceHistory: selType === 'serviceHistory',
                    tripsPerDriver: selType === 'tripsPerDriver',
                    debts: selType === 'debts',
                };
                const fmt = (d) => {
                    const mm = String(d.getMonth() + 1).padStart(2, '0');
                    const dd = String(d.getDate()).padStart(2, '0');
                    return `${d.getFullYear()}-${mm}-${dd}`;
                };
                doc.setFontSize(10);
                doc.text(`Periode: ${fmt(startDate)} s.d. ${fmt(endDate)}`, pageWidth / 2, cursorY, { align: 'center' });
                if (selectedDriver) {
                    cursorY += 12;
                    doc.text(`Supir: ${selectedDriver}`, pageWidth / 2, cursorY, { align: 'center' });
                }
                cursorY += 14;

                const addTable = (title, head, bodyRows) => {
                    if (!Array.isArray(bodyRows) || bodyRows.length === 0) return;
                    cursorY += 10;
                    doc.setFontSize(12);
                    doc.text(title, marginX, cursorY);
                    cursorY += 6;
                    doc.autoTable({
                        startY: cursorY,
                        head: [head],
                        body: bodyRows,
                        margin: { left: marginX, right: marginX },
                        styles: { fontSize: 8 },
                        headStyles: { fillColor: [59, 130, 246] },
                        didDrawPage: (data) => { cursorY = data.cursor.y; }
                    });
                    cursorY = doc.lastAutoTable.finalY || cursorY;
                };

                // Data Supir
                try {
                    if (include.drivers) {
                        const rows = (drivers || [])
                            .filter(d => !selectedDriver || d.name === selectedDriver)
                            .map(d => [
                                d.name || '-', d.vehicle || '-', d.phone || '-',
                                (d.status || '').toString(), (d.joinDate ? formatDate(d.joinDate) : '-')
                            ]);
                        addTable('Data Supir', ['Nama', 'Kendaraan', 'Telepon', 'Status', 'Bergabung'], rows);
                    }
                } catch (e) { }

                // Data Pajak & KIR
                try {
                    if (include.documents) {
                        const now = new Date();
                        const rows = (documents || [])
                            .filter(docu => {
                                if (!selectedDriver) return true;
                                const name = getDriverNameByVehicle(docu.vehicle) || '';
                                return name === selectedDriver;
                            })
                            .map(docu => {
                                const expiry = docu.expiry ? formatDate(docu.expiry) : '-';
                                const days = docu.expiry ? Math.ceil((new Date(docu.expiry) - now) / (1000 * 60 * 60 * 24)) : '';
                                let status = 'Aktif';
                                if (docu.expiry) {
                                    if (days < 0) status = 'Berakhir';
                                    else if (days <= 30) status = 'Akan Berakhir';
                                }
                                return [docu.vehicle || '-', docu.type || '-', expiry, (isNaN(days) ? '-' : days + ' hari'), status];
                            });
                        addTable('Data Pajak & KIR', ['Kendaraan', 'Dokumen', 'Expired', 'Sisa Hari', 'Status'], rows);
                    }
                } catch (e) { }

                // Data History Service
                try {
                    if (include.serviceHistory) {
                        const rows = (serviceHistory || [])
                            .filter(s => !selectedDriver || (getDriverNameByVehicle(s.vehicle) || s.driver || '') === selectedDriver)
                            .map(s => [
                                s.date ? formatDate(s.date) : '-',
                                s.vehicle || '-',
                                getDriverNameByVehicle(s.vehicle) || s.driver || '-',
                                s.type || '-',
                                formatCurrency(s.cost || 0)
                            ]);
                        addTable('History Service', ['Tanggal', 'Kendaraan', 'Supir', 'Jenis', 'Biaya'], rows);
                    }
                } catch (e) { }

                // Data Tarikan per Supir (periode + hanya lunas)
                try {
                    if (include.tripsPerDriver) {
                        const periodSchedules = (schedules || []).filter(s => {
                            const sd = new Date(s.date);
                            const name = s.driver || getDriverNameByVehicle(s.vehicle) || '';
                            const matchesDriver = !selectedDriver || name === selectedDriver;
                            return sd >= startDate && sd <= endDate && s.status === 'lunas' && s.orderType !== 'hutang' && matchesDriver;
                        });
                        const agg = {};
                        periodSchedules.forEach(s => {
                            const key = s.driver || getDriverNameByVehicle(s.vehicle) || 'Tanpa Nama';
                            if (!agg[key]) agg[key] = { trips: 0, total: 0, share: 0 };
                            agg[key].trips += 1;
                            const fare = s.fare || 0;
                            agg[key].total += fare;
                            agg[key].share += (s.companyShare ?? (fare * 0.4));
                        });
                        const rows = Object.keys(agg).sort().map(name => [
                            name, agg[name].trips, formatCurrency(agg[name].total), formatCurrency(agg[name].share)
                        ]);
                        addTable('Tarikan per Supir', ['Supir', 'Trips', 'Total Argo', 'Setoran (40%)'], rows);
                    }
                } catch (e) { }

                // Data Hutang (periode)
                try {
                    if (include.debts) {
                        const periodDebts = (schedules || []).filter(s => {
                            const sd = new Date(s.date);
                            const matchesDriver = !selectedDriver || (s.driver || '') === selectedDriver;
                            return sd >= startDate && sd <= endDate && s.orderType === 'hutang' && matchesDriver;
                        });
                        const rows = periodDebts.map(s => {
                            const total = s.companyShare || 0;
                            const paid = s.paidCompanyAmount || 0;
                            const remain = Math.max(total - paid, 0);
                            const status = remain <= 0 ? 'Lunas' : 'Belum Lunas';
                            return [
                                formatDate(s.date), s.driver || '-', (s.notes || '-'),
                                formatCurrency(total), formatCurrency(paid), formatCurrency(remain), status
                            ];
                        });
                        addTable('Data Hutang', ['Tanggal', 'Supir', 'Keterangan', 'Jumlah', 'Terbayar', 'Sisa', 'Status'], rows);
                    }
                } catch (e) { }

                const filename = `Laporan_OkeKirim_${fmt(endDate).replace(/-/g, '')}.pdf`;
                doc.save(filename);
            } catch (err) {
                console.error(err);
                alert('Gagal mengekspor PDF');
            }
        }

        // Standalone History page removed: showHistorySchedulesPage/backToSchedulesPage

        function renderHistorySchedulesPage() {
            const tbody = document.getElementById('historySchedulesBodyPage');
            if (!tbody) return;
            const lunas = schedules.filter(s => s.status === 'lunas').sort((a, b) => new Date(b.date) - new Date(a.date));
            // Update summary cards
            const totalFare = lunas.reduce((sum, s) => sum + (s.fare || 0), 0);
            const totalCompanyShare = lunas.reduce((sum, s) => sum + (s.companyShare ?? (s.fare * 0.4)), 0);
            const countEl = document.getElementById('historyCount');
            const fareEl = document.getElementById('historyTotalFare');
            const shareEl = document.getElementById('historyTotalCompanyShare');
            if (countEl) countEl.textContent = lunas.length;
            if (fareEl) fareEl.textContent = formatCurrency(totalFare);
            if (shareEl) shareEl.textContent = formatCurrency(totalCompanyShare);
            const html = lunas.map(schedule => `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 dark:text-white">${schedule.driver}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 dark:text-white">${formatDate(schedule.date)}</td>
                    <td class="px-6 py-3 text-sm text-gray-900 dark:text-white max-w-xs truncate">${schedule.origin || ''}</td>
                    <td class="px-6 py-3 text-sm text-gray-900 dark:text-white max-w-xs truncate">${schedule.destination || ''}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 dark:text-white">${schedule.rit || ''}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 dark:text-white">${schedule.orderType}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 dark:text-white">${formatCurrency(schedule.fare)}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-green-600 dark:text-green-400">${formatCurrency(schedule.companyShare ?? (schedule.fare * 0.4))}</td>
                </tr>
            `).join('');
            tbody.innerHTML = html || '<tr><td colspan="8" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">Belum ada tarikan lunas</td></tr>';

            const cards = document.getElementById('historySchedulesCards');
            if (cards) {
                const cardsHtml = lunas.map(s => `
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-4">
                        <div class="flex items-start justify-between">
                            <div>
                                <h4 class="font-semibold text-gray-900 dark:text-white">${s.driver}</h4>
                                <p class="text-xs text-gray-500 dark:text-gray-400">${formatDate(s.date)}</p>
                            </div>
                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">Lunas</span>
                        </div>
                        <div class="mt-3 text-sm space-y-1">
                            <p class="text-gray-700 dark:text-gray-300"><i class="fas fa-map-marker-alt text-green-500 mr-2"></i>Muat: ${s.origin || '-'}</p>
                            <p class="text-gray-700 dark:text-gray-300"><i class="fas fa-flag text-red-500 mr-2"></i>Bongkar: ${s.destination || '-'}</p>
                            <div class="grid grid-cols-2 gap-2 mt-2">
                                <div>
                                    <p class="text-gray-500 dark:text-gray-400 text-xs">RIT</p>
                                    <p class="text-gray-900 dark:text-white">${s.rit || '-'}</p>
                                </div>
                                <div>
                                    <p class="text-gray-500 dark:text-gray-400 text-xs">Tipe</p>
                                    <p class="text-gray-900 dark:text-white">${s.orderType}</p>
                                </div>
                                <div>
                                    <p class="text-gray-500 dark:text-gray-400 text-xs">Argo</p>
                                    <p class="text-gray-900 dark:text-white">${formatCurrency(s.fare)}</p>
                                </div>
                                <div>
                                    <p class="text-gray-500 dark:text-gray-400 text-xs">Setoran (40%)</p>
                                    <p class="text-green-600 dark:text-green-400 font-medium">${formatCurrency(s.companyShare ?? (s.fare * 0.4))}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                cards.innerHTML = cardsHtml || '<div class="text-center py-8 text-gray-500 dark:text-gray-400">Belum ada tarikan lunas</div>';
            }
        }

        function updateRevenueChart(periodSchedules) {
            try {
                const canvas = document.getElementById('revenueChart');
                if (!canvas) return;

                const ctx = canvas.getContext('2d');

                // Destroy existing chart
                if (revenueChartInstance) {
                    revenueChartInstance.destroy();
                }

                // Group revenue by date
                const revenueByDate = {};
                periodSchedules.filter(s => s.status === 'lunas').forEach(schedule => {
                    const date = schedule.date;
                    revenueByDate[date] = (revenueByDate[date] || 0) + schedule.fare;
                });

                const dates = Object.keys(revenueByDate).sort();
                const revenues = dates.map(date => revenueByDate[date]);

                // If no data, show placeholder
                if (dates.length === 0) {
                    dates.push('Tidak ada data');
                    revenues.push(0);
                }

                revenueChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dates.map(date => date === 'Tidak ada data' ? date : formatDate(date)),
                        datasets: [{
                            label: 'Pendapatan',
                            data: revenues,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointBackgroundColor: 'rgb(59, 130, 246)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: 'rgba(255, 255, 255, 0.1)',
                                borderWidth: 1,
                                callbacks: {
                                    label: function (context) {
                                        return 'Pendapatan: ' + formatCurrency(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: '#6B7280',
                                    maxRotation: window.innerWidth < 640 ? 90 : 45,
                                    font: {
                                        size: window.innerWidth < 640 ? 9 : 12
                                    },
                                    callback: function (value, index) {
                                        const label = this.getLabelForValue(value);
                                        if (window.innerWidth < 640) {
                                            // Show only first name on mobile
                                            return label.split(' ')[0];
                                        }
                                        return label;
                                    }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(107, 114, 128, 0.1)'
                                },
                                ticks: {
                                    color: '#6B7280',
                                    font: {
                                        size: window.innerWidth < 640 ? 10 : 12
                                    },
                                    callback: function (value) {
                                        if (window.innerWidth < 640) {
                                            // Shorter format for mobile
                                            if (value >= 1000000) {
                                                return (value / 1000000).toFixed(0) + 'M';
                                            } else if (value >= 1000) {
                                                return (value / 1000).toFixed(0) + 'K';
                                            }
                                            return value;
                                        }
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating revenue chart:', error);
            }
        }

        function updateVehicleStatusChart() {
            try {
                const canvas = document.getElementById('vehicleStatusChart');
                if (!canvas) return;

                const ctx = canvas.getContext('2d');

                // Destroy existing chart
                if (vehicleStatusChartInstance) {
                    vehicleStatusChartInstance.destroy();
                }

                const activeVehicles = drivers.filter(d => d.status === 'aktif').length;
                const inactiveVehicles = drivers.filter(d => d.status === 'nonaktif').length;

                // If no data, show placeholder
                const hasData = activeVehicles > 0 || inactiveVehicles > 0;
                const labels = hasData ? ['Aktif', 'Non-Aktif'] : ['Tidak ada data'];
                const data = hasData ? [activeVehicles, inactiveVehicles] : [1];
                const colors = hasData ? ['rgb(34, 197, 94)', 'rgb(239, 68, 68)'] : ['rgb(156, 163, 175)'];

                vehicleStatusChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderColor: '#fff',
                            borderWidth: 2,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    color: '#6B7280'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: 'rgba(255, 255, 255, 0.1)',
                                borderWidth: 1,
                                callbacks: {
                                    label: function (context) {
                                        if (!hasData) return 'Belum ada kendaraan';
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((context.parsed / total) * 100);
                                        return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                                    }
                                }
                            }
                        },
                        cutout: '60%'
                    }
                });
            } catch (error) {
                console.error('Error creating vehicle status chart:', error);
            }
        }

        // Settings Functions
        function loadSettings() {
            document.getElementById('companyName').value = settings.companyName;
            document.getElementById('companyEmail').value = settings.companyEmail;
            document.getElementById('companyPhone').value = settings.companyPhone;
            document.getElementById('companyAddress').value = settings.companyAddress;
            document.getElementById('emailNotifications').checked = settings.emailNotifications;
            document.getElementById('documentReminders').checked = settings.documentReminders;
            document.getElementById('serviceNotifications').checked = settings.serviceNotifications;
            document.getElementById('timezone').value = settings.timezone;
            document.getElementById('dateFormat').value = settings.dateFormat;
            document.getElementById('currency').value = settings.currency;
            document.getElementById('language').value = settings.language;
        }

        function saveSettings() {
            settings = {
                companyName: document.getElementById('companyName').value,
                companyEmail: document.getElementById('companyEmail').value,
                companyPhone: document.getElementById('companyPhone').value,
                companyAddress: document.getElementById('companyAddress').value,
                emailNotifications: document.getElementById('emailNotifications').checked,
                documentReminders: document.getElementById('documentReminders').checked,
                serviceNotifications: document.getElementById('serviceNotifications').checked,
                timezone: document.getElementById('timezone').value,
                dateFormat: document.getElementById('dateFormat').value,
                currency: document.getElementById('currency').value,
                language: document.getElementById('language').value
            };
            localStorage.setItem('settings', JSON.stringify(settings));
            addActivity('Pengaturan sistem diperbarui');
            alert('Pengaturan berhasil disimpan!');
        }

        // Modal Functions
        function openModal(modalId, opts) {
            const overlay = document.getElementById(modalId);
            if (!overlay) return;
            overlay.classList.remove('hidden');
            overlay.classList.add('opacity-0');

            // Optional scroll locking (default: lock) - confirmations can skip this
            const shouldLock = !(opts && opts.lockScroll === false);
            overlay.dataset.lockScroll = shouldLock ? '1' : '0';
            if (shouldLock) {
                lockScroll();
            }
            const panel = overlay.querySelector('.modal');
            if (panel) {
                panel.classList.add('opacity-0', 'scale-95');
                // ensure starting state applied before transition
                requestAnimationFrame(() => {
                    overlay.classList.add('transition', 'duration-200', 'ease-out');
                    overlay.classList.remove('opacity-0');
                    overlay.classList.add('opacity-100');
                    panel.classList.add('transition', 'duration-200', 'ease-out');
                    panel.classList.remove('opacity-0', 'scale-95');
                    panel.classList.add('opacity-100', 'scale-100');
                });
            }
            // Hide floating hamburger on mobile so it doesn't overlap modal
            try {
                const mobileBtn = document.getElementById('mobile-menu-btn');
                if (mobileBtn) {
                    mobileBtn.classList.add('opacity-0', 'pointer-events-none', 'z-10');
                    mobileBtn.classList.remove('z-[70]');
                }
            } catch (e) { }
        }

        function closeModal(modalId) {
            const overlay = document.getElementById(modalId);
            if (!overlay) return;
            const panel = overlay.querySelector('.modal');
            if (panel) {
                panel.classList.add('transition', 'duration-150', 'ease-in');
                panel.classList.remove('opacity-100', 'scale-100');
                panel.classList.add('opacity-0', 'scale-95');
                setTimeout(() => {
                    overlay.classList.add('hidden');
                    // Only remove scroll lock if this modal locked it
                    const locked = overlay.dataset.lockScroll === '1';
                    if (locked) {
                        unlockScroll();
                    }
                    panel.classList.remove('opacity-0', 'scale-95', 'transition', 'duration-150', 'ease-in', 'opacity-100', 'scale-100');
                    overlay.classList.remove('opacity-100', 'transition', 'duration-200', 'ease-out');
                    // Restore hamburger button visibility
                    try {
                        const mobileBtn = document.getElementById('mobile-menu-btn');
                        if (mobileBtn) {
                            mobileBtn.classList.remove('opacity-0', 'pointer-events-none', 'z-10');
                            mobileBtn.classList.add('z-[70]');
                        }
                    } catch (e) { }
                }, 150);
            } else {
                overlay.classList.add('hidden');
                const locked = overlay.dataset.lockScroll === '1';
                if (locked) {
                    unlockScroll();
                }
                // Restore hamburger button visibility
                try {
                    const mobileBtn = document.getElementById('mobile-menu-btn');
                    if (mobileBtn) {
                        mobileBtn.classList.remove('opacity-0', 'pointer-events-none', 'z-10');
                        mobileBtn.classList.add('z-[70]');
                    }
                } catch (e) { }
            }
        }

        // Dark Mode Functions (copied from indexaspal)
        function toggleDarkMode() {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');
            if (isDark) {
                html.classList.remove('dark');
                try { localStorage.setItem('darkMode', 'light'); } catch (e) { }
            } else {
                html.classList.add('dark');
                try { localStorage.setItem('darkMode', 'dark'); } catch (e) { }
            }
            updateDarkModeButton();
        }

        function updateDarkModeButton() {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');
            const button = document.getElementById('dark-mode-toggle');
            if (!button) return;
            button.setAttribute('title', isDark ? 'Beralih ke Mode Terang' : 'Beralih ke Mode Gelap');
        }

        function initializeDarkMode() {
            const savedMode = localStorage.getItem('darkMode');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedMode === 'dark') {
                document.documentElement.classList.add('dark');
            } else if (savedMode === 'light') {
                document.documentElement.classList.remove('dark');
            } else if (savedMode === null && prefersDark) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            updateDarkModeButton();
        }

        // Notification Functions
        function loadNotifications() {
            const unreadCount = notifications.filter(n => !n.read).length;
            const countElement = document.getElementById('notificationCount');
            const countText = countElement.querySelector('span');

            countText.textContent = unreadCount;
            countElement.style.display = unreadCount > 0 ? 'flex' : 'none';

            const notificationList = document.getElementById('notificationList');
            const html = notifications.map(notification => {
                const notificationId = jsString(notification.id);
                const typeColors = {
                    'warning': 'text-yellow-600 bg-yellow-100',
                    'info': 'text-blue-600 bg-blue-100',
                    'success': 'text-green-600 bg-green-100',
                    'error': 'text-red-600 bg-red-100'
                };
                const typeIcons = {
                    'warning': 'fas fa-exclamation-triangle',
                    'info': 'fas fa-info-circle',
                    'success': 'fas fa-check-circle',
                    'error': 'fas fa-times-circle'
                };

                return `
                    <div class="p-4 border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer ${!notification.read ? 'bg-blue-50 dark:bg-blue-900/20' : ''}" onclick="markNotificationRead(${notificationId})">
                        <div class="flex items-start space-x-2">
                            <div class="w-8 h-8 rounded-lg flex items-center justify-center ${typeColors[notification.type]}">
                                <i class="${typeIcons[notification.type]} text-sm"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900 dark:text-white">${notification.title}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">${notification.message}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-500 mt-2">${new Date(notification.timestamp).toLocaleString('id-ID')}</p>
                            </div>
                            ${!notification.read ? '<div class="w-2 h-2 bg-blue-600 rounded-full"></div>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
            notificationList.innerHTML = html || '<p class="text-gray-500 text-center py-8">Tidak ada notifikasi</p>';
        }

        // User helper: fetch current user and update UI with username (email prefix)
        let currentUser = null;
        async function loadCurrentUser() {
            try {
                const res = await fetch((window.API_BASE || 'api') + '/auth.php?action=me', { credentials: 'same-origin' });
                const data = await res.json().catch(() => ({}));
                if (res.ok && data && data.success && data.user) {
                    currentUser = data.user;
                    const email = String(currentUser.email || '');
                    const username = (currentUser.name && String(currentUser.name).trim()) ? String(currentUser.name).trim() : (email.includes('@') ? email.split('@')[0] : 'User');
                    // Top button
                    try { document.getElementById('userDisplayNameTop').textContent = username; } catch (e) { }
                    try { document.getElementById('userEmailTop').textContent = email; } catch (e) { }
                    // Dropdown header
                    try { document.getElementById('userDisplayNameDrop').textContent = username; } catch (e) { }
                    try { document.getElementById('userEmailDrop').textContent = email; } catch (e) { }
                    // Prefill profile form
                    try {
                        const f = document.getElementById('userProfileForm');
                        if (f) {
                            if (f.elements['fullName']) f.elements['fullName'].value = currentUser.name || username;
                            if (f.elements['email']) f.elements['email'].value = email;
                        }
                    } catch (e) { }
                }
            } catch (e) { /* ignore */ }
        }

        function markNotificationRead(id) {
            const notification = notifications.find(n => sameId(n.id, id));
            if (notification) {
                notification.read = true;
                localStorage.setItem('notifications', JSON.stringify(notifications));
                loadNotifications();
            }
        }

        function markAllNotificationsRead() {
            notifications.forEach(n => n.read = true);
            localStorage.setItem('notifications', JSON.stringify(notifications));
            loadNotifications();
        }

        function clearAllNotifications() {
            notifications = [];
            try { localStorage.setItem('notifications', JSON.stringify(notifications)); } catch (e) { }
            loadNotifications();
            showToast('Berhasil', 'Semua notifikasi dihapus', 'success');
            try { document.getElementById('notificationDropdown').classList.add('hidden'); } catch (e) { }
        }

        function addNotification(title, message, type = 'info') {
            const notification = {
                id: Date.now(),
                title: title,
                message: message,
                type: type,
                read: false,
                timestamp: new Date().toISOString()
            };
            notifications.unshift(notification);
            if (notifications.length > 50) notifications = notifications.slice(0, 50);
            localStorage.setItem('notifications', JSON.stringify(notifications));
            loadNotifications();
        }

        // Toast helper (iPhone-like)
        function showToast(title, message, type = 'success', timeout = 4200) {
            let container = document.getElementById('toastContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toastContainer';
                container.className = 'fixed top-6 left-1/2 -translate-x-1/2 z-[9999] flex flex-col items-center gap-3 px-4 pointer-events-none';
                document.body.appendChild(container);
            }

            const palette = {
                success: { icon: 'fas fa-check', badge: 'bg-emerald-500/15', iconClass: 'text-emerald-500' },
                error: { icon: 'fas fa-times', badge: 'bg-rose-500/15', iconClass: 'text-rose-500' },
                warning: { icon: 'fas fa-exclamation', badge: 'bg-amber-500/15', iconClass: 'text-amber-500' },
                info: { icon: 'fas fa-info', badge: 'bg-sky-500/15', iconClass: 'text-sky-500' }
            }[type] || { icon: 'fas fa-info', badge: 'bg-sky-500/15', iconClass: 'text-sky-500' };

            const toast = document.createElement('div');
            toast.className = 'toast-enter pointer-events-auto w-full';
            toast.style.maxWidth = '420px';
            toast.style.width = 'min(92vw, 420px)';
            toast.innerHTML = `
                <div class="relative w-full flex items-center justify-center">
                    <div class="relative flex items-center gap-3 px-5 py-4 rounded-3xl shadow-xl border border-gray-200/80 bg-white text-gray-900">
                        <div class="w-10 h-10 ${palette.badge} rounded-2xl flex items-center justify-center shrink-0 shadow-inner">
                            <i class="${palette.icon} ${palette.iconClass || ''}"></i>
                        </div>
                        <div class="min-w-0">
                            <p class="text-sm font-semibold text-gray-900">${title}</p>
                            <p class="text-sm text-gray-600 mt-1">${message}</p>
                        </div>
                        <button class="toast-close-btn ml-2 text-gray-400 hover:text-gray-600 transition-colors" aria-label="Tutup" title="Tutup">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;

            let closed = false;
            const removeToast = () => {
                if (closed) return;
                closed = true;
                toast.classList.remove('toast-enter');
                toast.classList.add('toast-leave');
                setTimeout(() => toast.remove(), 180);
            };

            const closeBtn = toast.querySelector('.toast-close-btn') || toast.querySelector('button');
            if (closeBtn) closeBtn.addEventListener('click', removeToast);

            container.appendChild(toast);

            let autoTimer = setTimeout(removeToast, timeout);
            toast.addEventListener('pointerenter', () => {
                clearTimeout(autoTimer);
            });
            toast.addEventListener('pointerleave', () => {
                clearTimeout(autoTimer);
                autoTimer = setTimeout(removeToast, timeout);
            });
        }

        function openUserProfile() {
            openModal('userProfileModal');
            closeDropdown('userDropdown');
        }

        function openChangePassword() {
            openModal('changePasswordModal');
            closeDropdown('userDropdown');
        }

        function openAccountSettings() {
            // Show settings content directly (sidebar item removed)
            document.querySelectorAll('.page-content').forEach(el => {
                el.classList.add('hidden');
                el.classList.remove('fade-in');
            });
            const target = document.getElementById('settings-content');
            if (target) {
                target.classList.remove('hidden');
                requestAnimationFrame(() => target.classList.add('fade-in'));
            }
            const title = document.getElementById('pageTitle');
            if (title) title.textContent = 'Pengaturan';
            closeDropdown('userDropdown');
            try { if (window.innerWidth < 1024) closeSidebarFunc(); } catch (e) { }
        }

        function closeDropdown(dropdownId) {
            document.getElementById(dropdownId).classList.add('hidden');
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            initializeDarkMode();
            loadCurrentUser();
            loadNotifications();
            // Clear dummy/local data and rely on API
            try { ['drivers', 'documents', 'services', 'serviceHistory', 'schedules'].forEach(k => localStorage.removeItem(k)); } catch (e) { }
            drivers = [];
            documents = [];
            services = [];
            serviceHistory = [];
            schedules = [];
            updateDashboard();
            const initialContent = document.getElementById('dashboard-content');
            if (initialContent) {
                initialContent.classList.remove('fade-in');
                requestAnimationFrame(() => initialContent.classList.add('fade-in'));
            }
            // Sync from API so app uses real DB data
            bootstrapFromAPI();

            // Modal close buttons (with smooth animation)
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const overlay = e.target.closest('.fixed');
                    if (overlay && overlay.id) {
                        closeModal(overlay.id);
                    }
                });
            });

            // Add buttons
            document.getElementById('addDriverBtn').addEventListener('click', () => openModal('addDriverModal'));
            document.getElementById('addDocumentBtn').addEventListener('click', () => openModal('addDocumentModal'));
            document.getElementById('addServiceBtn').addEventListener('click', () => {
                const form = document.getElementById('addServiceForm');
                if (form) {
                    form.reset();
                    delete form.dataset.editId;
                    const receiptGroup = document.getElementById('serviceReceiptGroup');
                    if (receiptGroup) receiptGroup.classList.add('hidden');
                    const receiptInput = form.querySelector('input[name="receipt"]');
                    if (receiptInput) receiptInput.value = '';
                }
                document.querySelector('#addServiceModal h3').textContent = 'Jadwalkan Service';
                document.querySelector('#addServiceModal button[type="submit"]').innerHTML = '<i class="fas fa-save mr-2"></i>Jadwalkan Service';
                populateServiceVehicleDropdown();
                openModal('addServiceModal');
            });
            document.getElementById('addScheduleBtn').addEventListener('click', () => openModal('addScheduleModal'));
            document.getElementById('openHistoryBtn').addEventListener('click', () => openHistorySchedules());
            // Debt page buttons
            document.getElementById('addDebtBtn')?.addEventListener('click', openAddDebt);
            document.getElementById('openDebtHistoryBtn')?.addEventListener('click', openDebtHistory);
            // Removed standalone history page button
            // document.getElementById('backToSchedulesBtn')?.addEventListener('click', () => backToSchedulesPage());

            // Payment form submit
            document.getElementById('paymentScheduleForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const { recordType = 'schedule', recordId } = form.dataset;
                const formData = new FormData(form);
                const amountRaw = toInt(formData.get('amount'));
                const notes = (formData.get('notes') || '').trim();
                const nowIso = new Date().toISOString();

                if (recordType === 'debt') {
                    const debt = (debts || []).find(d => sameId(d.id, recordId));
                    if (!debt) {
                        alert('Data hutang tidak ditemukan');
                        return;
                    }
                    const total = toInt(debt.amount);
                    const prevPaid = toInt(debt.paidAmount);
                    const maxPayable = Math.max(total - prevPaid, 0);
                    const normalizedAmount = Math.max(amountRaw, 0);
                    const applyPayment = normalizedAmount > 0;
                    if (!applyPayment && !notes) {
                        alert('Isi catatan hutang atau masukkan jumlah pembayaran.');
                        return;
                    }
                    if (applyPayment && normalizedAmount > maxPayable) {
                        showToast('Informasi', 'Jumlah melebihi sisa hutang', 'info');
                        return;
                    }
                    const appliedAmount = applyPayment ? Math.min(normalizedAmount, maxPayable) : 0;
                    const newPaid = prevPaid + appliedAmount;
                    const remaining = Math.max(total - newPaid, 0);
                    const priorStatus = (debt.status || '').toLowerCase();
                    let status = remaining <= 0 ? 'lunas' : (priorStatus || 'belum_lunas');
                    if (!applyPayment && remaining > 0 && priorStatus) {
                        status = priorStatus;
                    }
                    let lastPaidAt = debt.lastPaidAt || debt.last_paid_at || null;
                    if (applyPayment) {
                        lastPaidAt = nowIso;
                    }
                    let paidOffAt = debt.paidOffAt || debt.paid_off_at || null;
                    if (status === 'lunas') {
                        paidOffAt = paidOffAt || nowIso;
                    } else if (applyPayment) {
                        paidOffAt = null;
                    }
                    const noteToPersist = notes;
                    const payload = {
                        id: debt.id,
                        driver: debt.driver,
                        vehicle: debt.vehicle,
                        type: debt.type,
                        amount: total,
                        date: debt.date,
                        dueDate: debt.dueDate ?? debt.due_date ?? null,
                        status,
                        paidAmount: newPaid,
                        lastPaidAt,
                        paidOffAt,
                        notes: debt.notes || '',
                        paymentNote: noteToPersist || null,
                        paymentAmount: appliedAmount
                    };
                    try {
                        const updated = await apiRequest('debts.php', { method: 'PUT', data: payload });
                        const idx = (debts || []).findIndex(d => sameId(d.id, debt.id));
                        const merged = { ...debt, ...updated };
                        if (typeof updated.notes !== 'undefined') {
                            merged.notes = updated.notes;
                        } else if (typeof merged.notes === 'undefined') {
                            merged.notes = debt.notes || '';
                        }
                        if (typeof updated.lastPaymentNotes !== 'undefined') {
                            merged.lastPaymentNotes = updated.lastPaymentNotes;
                        } else if (noteToPersist) {
                            merged.lastPaymentNotes = noteToPersist;
                        }
                        if (noteToPersist) {
                            merged.paymentNotes = noteToPersist;
                        }
                        if (typeof updated.lastPaymentAmount !== 'undefined') {
                            merged.lastPaymentAmount = toInt(updated.lastPaymentAmount);
                        } else if (typeof merged.lastPaymentAmount === 'undefined') {
                            merged.lastPaymentAmount = toInt(appliedAmount);
                        }
                        if (typeof updated.lastPaidAt !== 'undefined') {
                            merged.lastPaidAt = updated.lastPaidAt;
                        }
                        merged.paidAmount = toInt(merged.paidAmount ?? updated.paidAmount ?? newPaid);
                        if (idx !== -1) {
                            debts[idx] = merged;
                        }
                        localStorage.setItem('debts', JSON.stringify(debts));
                        loadDebts();
                        try { renderDebtHistoryModal(); } catch (err) { }
                        if (applyPayment) {
                            addActivity(`Pembayaran hutang ${formatCurrency(appliedAmount)} untuk ${merged.driver}. Sisa: ${formatCurrency(Math.max(total - merged.paidAmount, 0))}`);
                            showToast('Pembayaran Hutang', `Pembayaran ${formatCurrency(appliedAmount)} tercatat untuk ${merged.driver}`, 'success');
                        } else {
                            addActivity(`Catatan hutang untuk ${merged.driver} diperbarui`);
                            showToast('Catatan Disimpan', `Catatan hutang untuk ${merged.driver} tersimpan`, 'success');
                        }
                        closeModal('paymentScheduleModal');
                        form.reset();
                        delete form.dataset.recordId;
                        delete form.dataset.recordType;
                        delete form.dataset.scheduleId;
                    } catch (err) {
                        console.error(err);
                        showToast('Gagal', 'Gagal menyimpan pembayaran hutang', 'error');
                    }
                    return;
                }

                if (amountRaw <= 0) {
                    alert('Jumlah pembayaran tidak valid');
                    return;
                }
                const targetId = recordId ?? form.dataset.scheduleId;
                const schedule = schedules.find(s => sameId(s.id, targetId));
                if (!schedule) {
                    alert('Jadwal tidak ditemukan');
                    return;
                }
                const share = toInt(schedule.companyShare ?? (toInt(schedule.fare) * 0.4));
                const prevPaid = toInt(schedule.paidCompanyAmount);
                const maxPayable = Math.max(share - prevPaid, 0);
                if (maxPayable <= 0) {
                    showToast('Informasi', 'Jadwal ini sudah lunas', 'info');
                    return;
                }
                const appliedAmount = Math.min(amountRaw, maxPayable);
                if (appliedAmount <= 0) {
                    alert('Jumlah pembayaran tidak valid');
                    return;
                }
                const paidAfter = prevPaid + appliedAmount;
                const remaining = Math.max(share - paidAfter, 0);
                const wasLunas = schedule.status === 'lunas';
                schedule.companyShare = share;
                schedule.paidCompanyAmount = paidAfter;
                schedule.status = remaining <= 0 ? 'lunas' : 'nunggak';
                schedule.lastPaidAt = nowIso;
                if (schedule.status === 'lunas') {
                    if (!wasLunas) schedule.paidOffAt = nowIso;
                } else {
                    schedule.paidOffAt = null;
                }
                schedule.notes = notes;
                schedule.paymentNotes = notes;
                schedule.lastPaymentNotes = notes;

                try {
                    await apiRequest('schedules.php', {
                        method: 'PUT', data: {
                            id: schedule.id,
                            driver: schedule.driver,
                            vehicle: schedule.vehicle,
                            date: schedule.date,
                            origin: schedule.origin,
                            destination: schedule.destination,
                            rit: schedule.rit,
                            orderType: schedule.orderType,
                            fare: toInt(schedule.fare),
                            status: schedule.status,
                            companyShare: share,
                            paidCompanyAmount: schedule.paidCompanyAmount,
                            notes: schedule.notes || '',
                            paymentNotes: schedule.paymentNotes || '',
                            lastPaidAt: schedule.lastPaidAt || null,
                            paidOffAt: schedule.paidOffAt || null
                        }
                    });
                } catch (err) {
                    console.warn(err);
                }

                localStorage.setItem('schedules', JSON.stringify(schedules));
                loadSchedules();
                try {
                    if (document.getElementById('debt-content') && !document.getElementById('debt-content').classList.contains('hidden')) {
                        loadDebts();
                    }
                } catch (err) { }
                addActivity(`Pembayaran ${formatCurrency(appliedAmount)} untuk ${schedule.driver}. Sisa: ${formatCurrency(remaining)}`);
                showToast('Pembayaran Tercatat', `Pembayaran ${formatCurrency(appliedAmount)} untuk ${schedule.driver}`, 'success');
                closeModal('paymentScheduleModal');
                form.reset();
                delete form.dataset.recordId;
                delete form.dataset.recordType;
                delete form.dataset.scheduleId;
            });


            // Edit schedule form submit
            document.getElementById('editScheduleForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const editId = form.dataset.editId;
                if (!editId) {
                    alert('Jadwal tidak ditemukan');
                    return;
                }
                const index = schedules.findIndex(s => sameId(s.id, editId));
                if (index === -1) {
                    alert('Jadwal tidak ditemukan');
                    return;
                }
                const formData = new FormData(form);
                const data = Object.fromEntries(formData);
                const original = schedules[index];
                const updated = { ...original };

                updated.driver = data.driver || original.driver;
                updated.date = data.date || original.date;
                updated.origin = data.origin || '';
                updated.destination = data.destination || '';
                updated.rit = data.rit || '';
                updated.orderType = data.orderType || original.orderType;
                updated.status = data.status || original.status;
                updated.notes = data.notes || '';

                let baseFare = toInt(data.fare || original.fare);
                let companyShare = toInt(original.companyShare ?? Math.round(toInt(original.fare) * 0.4));
                if (updated.orderType === 'hutang') {
                    const amount = Math.max(toInt(data.fare), 0);
                    companyShare = amount > 0 ? amount : companyShare;
                    baseFare = companyShare > 0 ? Math.round(companyShare / 0.4) : baseFare;
                    updated.status = updated.status || 'nunggak';
                } else {
                    baseFare = Math.max(baseFare, 0);
                    companyShare = Math.round(baseFare * 0.4);
                }
                updated.fare = baseFare;
                updated.companyShare = companyShare;
                updated.driverShare = Math.round(updated.fare * 0.6);

                const paid = toInt(updated.paidCompanyAmount);
                updated.paidCompanyAmount = paid;
                if (companyShare > 0 && paid >= companyShare) {
                    updated.paidCompanyAmount = companyShare;
                    if (updated.status !== 'lunas') {
                        updated.status = 'lunas';
                    }
                    if (!updated.paidOffAt) {
                        updated.paidOffAt = new Date().toISOString();
                    }
                } else {
                    if (updated.status === 'lunas' && paid < companyShare) {
                        updated.status = 'nunggak';
                    }
                    if (paid < companyShare) {
                        updated.paidOffAt = null;
                    }
                }

                schedules[index] = updated;

                try {
                    await apiRequest('schedules.php', {
                        method: 'PUT',
                        data: {
                            id: updated.id,
                            driver: updated.driver,
                            vehicle: updated.vehicle,
                            date: updated.date,
                            origin: updated.origin,
                            destination: updated.destination,
                            rit: updated.rit,
                            orderType: updated.orderType,
                            fare: toInt(updated.fare),
                            status: updated.status,
                            companyShare: updated.companyShare,
                            paidCompanyAmount: toInt(updated.paidCompanyAmount),
                            notes: updated.notes || '',
                            paymentNotes: updated.paymentNotes || '',
                            lastPaidAt: updated.lastPaidAt || null,
                            paidOffAt: updated.paidOffAt || null
                        }
                    });
                } catch (err) {
                    console.warn(err);
                }

                localStorage.setItem('schedules', JSON.stringify(schedules));
                loadSchedules();
                try {
                    if (document.getElementById('debt-content') && !document.getElementById('debt-content').classList.contains('hidden')) {
                        loadDebts();
                    }
                } catch (err) { }
                addActivity(`Jadwal ${updated.driver} diperbarui`);
                showToast('Berhasil', `Jadwal ${updated.driver} diperbarui`, 'success');
                closeModal('editScheduleModal');
                form.reset();
                delete form.dataset.editId;
            });

            // Forms
            document.getElementById('addDriverForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const driverData = Object.fromEntries(formData);

                const editId = e.target.dataset.editId;
                if (editId) {
                    try {
                        const updated = await apiRequest('drivers.php', { method: 'PUT', data: { id: editId, ...driverData } });
                        const driverIndex = drivers.findIndex(d => d.id == editId);
                        if (driverIndex !== -1) {
                            drivers[driverIndex] = updated;
                            localStorage.setItem('drivers', JSON.stringify(drivers));
                            loadDrivers();
                            addActivity(`Supir ${updated.name || driverData.name} diperbarui`);
                            showToast('Berhasil', `Supir ${updated.name || driverData.name} diperbarui`, 'success');
                        }
                    } catch (err) { showToast('Gagal', 'Gagal memperbarui supir', 'error'); }
                    delete e.target.dataset.editId;

                    // Reset modal title and button
                    document.querySelector('#addDriverModal h3').textContent = 'Tambah Supir Baru';
                    document.querySelector('#addDriverModal button[type="submit"]').innerHTML = '<i class="fas fa-save mr-2"></i>Simpan Supir';
                } else {
                    // Add new driver
                    addDriver(driverData);
                }

                closeModal('addDriverModal');
                e.target.reset();
            });

            document.getElementById('addDocumentForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const docData = Object.fromEntries(formData);

                const editId = e.target.dataset.editId;
                if (editId) {
                    try {
                        const updated = await apiRequest('documents.php', { method: 'PUT', data: { id: editId, ...docData } });
                        const docIndex = documents.findIndex(d => d.id == editId);
                        if (docIndex !== -1) {
                            documents[docIndex] = updated;
                            localStorage.setItem('documents', JSON.stringify(documents));
                            loadDocuments();
                            addActivity(`Dokumen ${updated.type || docData.type} untuk ${updated.vehicle || docData.vehicle} diperbarui`);
                            showToast('Berhasil', `Dokumen ${updated.type || docData.type} untuk ${updated.vehicle || docData.vehicle} diperbarui`, 'success');
                        }
                    } catch (err) { showToast('Gagal', 'Gagal memperbarui dokumen', 'error'); }
                    delete e.target.dataset.editId;

                    // Reset modal title and button
                    document.querySelector('#addDocumentModal h3').textContent = 'Tambah Dokumen Baru';
                    document.querySelector('#addDocumentModal button[type="submit"]').innerHTML = '<i class="fas fa-save mr-2"></i>Simpan Dokumen';
                } else {
                    // Add new document
                    addDocument(docData);
                }

                closeModal('addDocumentModal');
                e.target.reset();
            });

            document.getElementById('addServiceForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);
                const customType = (formData.get('customType') || '').toString().trim();
                if (customType) {
                    formData.set('type', customType);
                }
                formData.delete('customType');
                const parsedCost = parseInt(formData.get('cost'), 10) || 0;
                formData.set('cost', String(parsedCost));
                const receiptInput = form.querySelector('input[name="receipt"]');
                const receiptFile = receiptInput && receiptInput.files && receiptInput.files[0] ? receiptInput.files[0] : null;

                const serviceData = {};
                formData.forEach((value, key) => {
                    if (key === 'receipt') return;
                    serviceData[key] = value;
                });
                serviceData.cost = parsedCost;

                const editId = form.dataset.editId;
                if (editId) {
                    try {
                        const payload = new FormData();
                        Object.entries(serviceData).forEach(([key, value]) => {
                            if (value !== undefined && value !== null) {
                                payload.append(key, value);
                            }
                        });
                        payload.append('_method', 'PUT');
                        payload.append('id', editId);
                        if (receiptFile) {
                            payload.append('receipt', receiptFile);
                        }
                        const endpoint = (window.API_BASE || 'api') + '/services.php?id=' + encodeURIComponent(editId);
                        const response = await fetch(endpoint, { method: 'POST', body: payload });
                        if (!response.ok) {
                            const message = await response.text();
                            throw new Error(message || 'Gagal memperbarui service');
                        }
                        const updated = await response.json();
                        const status = (updated.status || '').toLowerCase();
                        const existingIdx = services.findIndex(s => sameId(s.id, editId));
                        const existingHistoryIdx = serviceHistory.findIndex(s => sameId(s.id, editId));
                        let nextServices = services.filter(s => !sameId(s.id, editId));
                        let nextHistory = serviceHistory.filter(s => !sameId(s.id, editId));
                        if (status === 'selesai') {
                            const insertHistoryIdx = existingHistoryIdx >= 0 ? Math.min(existingHistoryIdx, nextHistory.length) : 0;
                            nextHistory.splice(insertHistoryIdx, 0, updated);
                        } else {
                            const insertServiceIdx = existingIdx >= 0 ? Math.min(existingIdx, nextServices.length) : 0;
                            nextServices.splice(insertServiceIdx, 0, updated);
                        }
                        services = nextServices;
                        serviceHistory = nextHistory;
                        localStorage.setItem('services', JSON.stringify(services));
                        localStorage.setItem('serviceHistory', JSON.stringify(serviceHistory));
                        loadServices();
                        const activityVerb = status === 'selesai' ? 'diselesaikan' : 'diperbarui';
                        addActivity(`Service ${updated.type || serviceData.type || ''} untuk ${updated.vehicle || serviceData.vehicle || ''} ${activityVerb}`);
                        const toastVerb = status === 'selesai' ? 'diselesaikan' : 'diperbarui';
                        showToast('Berhasil', `Service ${updated.type || serviceData.type || ''} untuk ${updated.vehicle || serviceData.vehicle || ''} ${toastVerb}`, 'success');
                    } catch (err) {
                        showToast('Gagal', err.message || 'Gagal memperbarui service', 'error');
                    }
                    delete form.dataset.editId;
                    document.querySelector('#addServiceModal h3').textContent = 'Jadwalkan Service';
                    document.querySelector('#addServiceModal button[type="submit"]').innerHTML = '<i class="fas fa-save mr-2"></i>Jadwalkan Service';
                } else {
                    addService(serviceData);
                }

                closeModal('addServiceModal');
                form.reset();
                const receiptGroup = document.getElementById('serviceReceiptGroup');
                if (receiptGroup) receiptGroup.classList.add('hidden');
                if (receiptInput) receiptInput.value = '';
                const receiptPreview = document.getElementById('serviceReceiptPreview');
                const receiptPreviewContent = document.getElementById('serviceReceiptPreviewContent');
                if (receiptPreview && receiptPreviewContent) {
                    receiptPreview.classList.add('hidden');
                    receiptPreviewContent.innerHTML = '';
                }
            });

            document.getElementById('addScheduleForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const scheduleData = Object.fromEntries(formData);
                scheduleData.fare = parseInt(scheduleData.fare);
                addSchedule(scheduleData);
                closeModal('addScheduleModal');
                e.target.reset();
            });

            // Auto-calculate company and driver share when fare changes
            document.querySelector('#addScheduleForm input[name="fare"]')?.addEventListener('input', (e) => {
                const fare = parseInt(e.target.value) || 0;
                const companyShare = fare * 0.4;
                const driverShare = fare * 0.6;

                document.querySelector('#addScheduleForm input[name="companyShare"]').value = companyShare;
                document.querySelector('#addScheduleForm input[name="driverShare"]').value = driverShare;
            });

            // Add debt form submit
            document.getElementById('addDebtForm')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);
                const debtData = Object.fromEntries(formData);
                await saveDebt(form, debtData);
            });
            document.getElementById('monthlyTargetForm')?.addEventListener('submit', handleMonthlyTargetSubmit);
            // Debt form: no auto calc needed; amount is total hutang

            // Settings
            document.getElementById('saveSettings').addEventListener('click', saveSettings);

            // Reports
            document.getElementById('reportPeriod').addEventListener('change', loadReports);
            document.getElementById('exportReport').addEventListener('click', () => {
                openConfirmExport();
            });

            // Ranking Period Change
            document.getElementById('rankingPeriod')?.addEventListener('change', updateDriverRanking);

            // Dark Mode Toggle uses inline onclick (kept consistent with indexaspal)

            // Notification Dropdown
            document.getElementById('notificationBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                const bellIcon = e.currentTarget.querySelector('i');
                const dropdown = document.getElementById('notificationDropdown');

                // Add bell animation
                bellIcon.classList.add('bell-animation');
                setTimeout(() => {
                    bellIcon.classList.remove('bell-animation');
                }, 600);

                // Toggle dropdown with animation
                if (dropdown.classList.contains('hidden')) {
                    dropdown.classList.remove('hidden');
                    dropdown.classList.add('dropdown-enter');
                    setTimeout(() => {
                        dropdown.classList.remove('dropdown-enter');
                    }, 200);
                } else {
                    dropdown.classList.add('hidden');
                }

                // Close user dropdown if open
                document.getElementById('userDropdown').classList.add('hidden');
            });

            document.getElementById('markAllRead').addEventListener('click', markAllNotificationsRead);
            document.getElementById('clearAllNotificationsBtn').addEventListener('click', (e) => { e.stopPropagation(); clearAllNotifications(); });

            // User Dropdown
            document.getElementById('userMenuBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                const userBtn = e.currentTarget;
                const dropdown = document.getElementById('userDropdown');

                // Add user menu animation
                userBtn.classList.add('user-menu-animation');
                setTimeout(() => {
                    userBtn.classList.remove('user-menu-animation');
                }, 400);

                // Toggle dropdown with animation
                if (dropdown.classList.contains('hidden')) {
                    dropdown.classList.remove('hidden');
                    dropdown.classList.add('dropdown-enter');
                    setTimeout(() => {
                        dropdown.classList.remove('dropdown-enter');
                    }, 200);
                } else {
                    dropdown.classList.add('hidden');
                }

                // Close notification dropdown if open
                document.getElementById('notificationDropdown').classList.add('hidden');
            });

            // User Profile Form
            document.getElementById('userProfileForm').addEventListener('submit', (e) => {
                e.preventDefault();
                try {
                    const formData = new FormData(e.target);
                    const fullName = formData.get('fullName') || '';
                    const email = formData.get('email') || '';
                    // Update UI locally (no API endpoint provided for profile update)
                    const username = String(email).includes('@') ? String(email).split('@')[0] : (fullName || 'User');
                    try { document.getElementById('userDisplayNameTop').textContent = username; } catch (e) { }
                    try { document.getElementById('userEmailTop').textContent = email; } catch (e) { }
                    try { document.getElementById('userDisplayNameDrop').textContent = username; } catch (e) { }
                    try { document.getElementById('userEmailDrop').textContent = email; } catch (e) { }
                    showToast('Profil Disimpan', 'Profil berhasil diperbarui', 'success');
                } catch (err) {
                    showToast('Gagal', 'Tidak dapat menyimpan profil', 'error');
                }
                closeModal('userProfileModal');
            });

            // Change Password Form
            document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const oldPassword = formData.get('oldPassword');
                const newPassword = formData.get('newPassword');
                const confirmPassword = formData.get('confirmPassword');

                if (!oldPassword || !newPassword) {
                    alert('Lengkapi password lama dan baru.');
                    return;
                }
                if (newPassword !== confirmPassword) {
                    alert('Password baru dan konfirmasi tidak cocok!');
                    return;
                }

                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Menyimpan...';
                submitBtn.disabled = true;

                try {
                    const body = new URLSearchParams({ oldPassword, newPassword });
                    const res = await fetch((window.API_BASE || 'api') + '/auth.php?action=change_password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        credentials: 'same-origin',
                        body
                    });
                    const data = await res.json().catch(() => ({}));
                    if (res.ok && data && data.success) {
                        showToast('Berhasil', 'Password berhasil diubah', 'success');
                        closeModal('changePasswordModal');
                        e.target.reset();
                    } else {
                        showToast('Gagal', (data && data.message) ? data.message : 'Gagal mengubah password', 'error');
                    }
                } catch (err) {
                    showToast('Koneksi Gagal', 'Tidak dapat terhubung ke server', 'error');
                } finally {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', () => {
                document.getElementById('notificationDropdown').classList.add('hidden');
                document.getElementById('userDropdown').classList.add('hidden');
            });

            // Search and filter functionality for drivers
            document.getElementById('searchDriver')?.addEventListener('input', () => {
                filterAndSortDrivers();
                if (currentDriversView === 'grid') {
                    renderDriversGrid();
                } else {
                    renderDriversTable();
                }
            });

            document.getElementById('filterStatus')?.addEventListener('change', () => {
                filterAndSortDrivers();
                if (currentDriversView === 'grid') {
                    renderDriversGrid();
                } else {
                    renderDriversTable();
                }
            });

            document.getElementById('sortBy')?.addEventListener('change', () => {
                filterAndSortDrivers();
                if (currentDriversView === 'grid') {
                    renderDriversGrid();
                } else {
                    renderDriversTable();
                }
            });

            // View toggle for drivers
            document.getElementById('gridViewBtn')?.addEventListener('click', () => {
                currentDriversView = 'grid';
                document.getElementById('gridViewBtn').classList.add('bg-white', 'dark:bg-gray-600', 'text-gray-900', 'dark:text-white', 'shadow-sm');
                document.getElementById('gridViewBtn').classList.remove('text-gray-600', 'dark:text-gray-400');
                document.getElementById('tableViewBtn').classList.remove('bg-white', 'dark:bg-gray-600', 'text-gray-900', 'dark:text-white', 'shadow-sm');
                document.getElementById('tableViewBtn').classList.add('text-gray-600', 'dark:text-gray-400');
                renderDriversGrid();
            });

            document.getElementById('tableViewBtn')?.addEventListener('click', () => {
                currentDriversView = 'table';
                document.getElementById('tableViewBtn').classList.add('bg-white', 'dark:bg-gray-600', 'text-gray-900', 'dark:text-white', 'shadow-sm');
                document.getElementById('tableViewBtn').classList.remove('text-gray-600', 'dark:text-gray-400');
                document.getElementById('gridViewBtn').classList.remove('bg-white', 'dark:bg-gray-600', 'text-gray-900', 'dark:text-white', 'shadow-sm');
                document.getElementById('gridViewBtn').classList.add('text-gray-600', 'dark:text-gray-400');
                renderDriversTable();
            });

            // View toggle for documents
            document.getElementById('documentsGridViewBtn')?.addEventListener('click', () => {
                currentDocumentsView = 'grid';
                document.getElementById('documentsGridViewBtn').classList.add('bg-white', 'dark:bg-gray-600', 'text-gray-900', 'dark:text-white', 'shadow-sm');
                document.getElementById('documentsGridViewBtn').classList.remove('text-gray-600', 'dark:text-gray-400');
                document.getElementById('documentsTableViewBtn').classList.remove('bg-white', 'dark:bg-gray-600', 'text-gray-900', 'dark:text-white', 'shadow-sm');
                document.getElementById('documentsTableViewBtn').classList.add('text-gray-600', 'dark:text-gray-400');
                renderDocumentsGrid();
            });

            document.getElementById('documentsTableViewBtn')?.addEventListener('click', () => {
                currentDocumentsView = 'table';
                document.getElementById('documentsTableViewBtn').classList.add('bg-white', 'dark:bg-gray-600', 'text-gray-900', 'dark:text-white', 'shadow-sm');
                document.getElementById('documentsTableViewBtn').classList.remove('text-gray-600', 'dark:text-gray-400');
                document.getElementById('documentsGridViewBtn').classList.remove('bg-white', 'dark:bg-gray-600', 'text-gray-900', 'dark:text-white', 'shadow-sm');
                document.getElementById('documentsGridViewBtn').classList.add('text-gray-600', 'dark:text-gray-400');
                renderDocumentsTable();
            });

            // View toggle for services
            document.getElementById('servicesGridViewBtn')?.addEventListener('click', () => {
                currentServicesView = 'grid';
                document.getElementById('servicesGridViewBtn').classList.add('bg-white', 'dark:bg-gray-600', 'text-gray-900', 'dark:text-white', 'shadow-sm');
                document.getElementById('servicesGridViewBtn').classList.remove('text-gray-600', 'dark:text-gray-400');
                document.getElementById('servicesTableViewBtn').classList.remove('bg-white', 'dark:bg-gray-600', 'text-gray-900', 'dark:text-white', 'shadow-sm');
                document.getElementById('servicesTableViewBtn').classList.add('text-gray-600', 'dark:text-gray-400');
                renderServicesGrid();
            });

            document.getElementById('servicesTableViewBtn')?.addEventListener('click', () => {
                currentServicesView = 'table';
                document.getElementById('servicesTableViewBtn').classList.add('bg-white', 'dark:bg-gray-600', 'text-gray-900', 'dark:text-white', 'shadow-sm');
                document.getElementById('servicesTableViewBtn').classList.remove('text-gray-600', 'dark:text-gray-400');
                document.getElementById('servicesGridViewBtn').classList.remove('bg-white', 'dark:bg-gray-600', 'text-gray-900', 'dark:text-white', 'shadow-sm');
                document.getElementById('servicesGridViewBtn').classList.add('text-gray-600', 'dark:text-gray-400');
                renderServicesTable();
            });

            // Service History pagination + filters
            let historyCurrentPage = 1;
            const HISTORY_PAGE_SIZE = 5;

            function populateHistoryDriverFilter() {
                const sel = document.getElementById('historyDriverFilter');
                if (!sel) return;
                const prev = sel.value;
                const set = new Set();
                // Prefer drivers
                (drivers || []).forEach(d => d?.name && set.add(d.name));
                if (set.size === 0) {
                    (serviceHistory || []).forEach(h => {
                        const name = getDriverNameByVehicle(h.vehicle) || h.driver || '';
                        if (name) set.add(name);
                    });
                }
                const opts = ['<option value="">Semua Supir</option>']
                    .concat(Array.from(set).sort().map(n => `<option value="${n}">${n}</option>`))
                    .join('');
                sel.innerHTML = opts;
                if (Array.from(set).includes(prev)) sel.value = prev;
            }

            function getFilteredHistory() {
                const driver = document.getElementById('historyDriverFilter')?.value || '';
                const month = document.getElementById('historyMonthFilter')?.value || '';
                return (serviceHistory || []).filter(h => {
                    const name = getDriverNameByVehicle(h.vehicle) || h.driver || '';
                    const matchesDriver = !driver || name === driver;
                    const matchesMonth = !month || ((h.date || '').slice(0, 7) === month);
                    return matchesDriver && matchesMonth;
                });
            }

            function renderServiceHistory() {
                const tbody = document.getElementById('serviceHistoryTableBody');
                const prevBtn = document.getElementById('serviceHistoryPrevPage');
                const nextBtn = document.getElementById('serviceHistoryNextPage');
                const pageInfo = document.getElementById('serviceHistoryPageInfo');
                const data = getFilteredHistory().slice().reverse();
                const totalFilteredCost = data.reduce((sum, s) => sum + (s.cost || 0), 0);
                const totalEl = document.getElementById('historyTotalCost');
                if (totalEl) totalEl.textContent = formatCurrencyShort(totalFilteredCost);
                const totalPages = Math.max(1, Math.ceil(data.length / HISTORY_PAGE_SIZE));
                if (historyCurrentPage > totalPages) historyCurrentPage = totalPages;
                if (historyCurrentPage < 1) historyCurrentPage = 1;
                const start = (historyCurrentPage - 1) * HISTORY_PAGE_SIZE;
                const pageItems = data.slice(start, start + HISTORY_PAGE_SIZE);

                const html = pageItems.map(s => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${s.date ? formatDate(s.date) : '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${s.vehicle || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${getDriverNameByVehicle(s.vehicle) || s.driver || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${s.type || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${formatCurrency(s.cost || 0)}</td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">${s.status || 'selesai'}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap">${renderReceiptCell(s.receipt)}</td>
                    </tr>
                `).join('');
                tbody.innerHTML = html || '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">Belum ada history</td></tr>';

                pageInfo.textContent = `Halaman ${Math.min(historyCurrentPage, totalPages)} dari ${totalPages}`;
                if (prevBtn) {
                    prevBtn.disabled = historyCurrentPage <= 1;
                    prevBtn.classList.toggle('opacity-50', prevBtn.disabled);
                    prevBtn.classList.toggle('cursor-not-allowed', prevBtn.disabled);
                }
                if (nextBtn) {
                    nextBtn.disabled = historyCurrentPage >= totalPages;
                    nextBtn.classList.toggle('opacity-50', nextBtn.disabled);
                    nextBtn.classList.toggle('cursor-not-allowed', nextBtn.disabled);
                }
            }

            // Open history modal
            document.getElementById('viewServiceHistoryBtn')?.addEventListener('click', () => {
                historyCurrentPage = 1;
                populateHistoryDriverFilter();
                renderServiceHistory();
                openModal('serviceHistoryModal');
            });

            // History controls (service history modal)
            document.getElementById('historyDriverFilter')?.addEventListener('change', () => { historyCurrentPage = 1; renderServiceHistory(); });
            document.getElementById('historyMonthFilter')?.addEventListener('change', () => { historyCurrentPage = 1; renderServiceHistory(); });
            document.getElementById('serviceHistoryPrevPage')?.addEventListener('click', () => { historyCurrentPage--; renderServiceHistory(); });
            document.getElementById('serviceHistoryNextPage')?.addEventListener('click', () => { historyCurrentPage++; renderServiceHistory(); });

            // Service filters & search
            document.getElementById('searchService')?.addEventListener('input', () => {
                filterAndSortServices();
                if (currentServicesView === 'grid') renderServicesGrid(); else renderServicesTable();
            });
            document.getElementById('filterDriverVehicle')?.addEventListener('change', () => {
                filterAndSortServices();
                if (currentServicesView === 'grid') renderServicesGrid(); else renderServicesTable();
            });
            document.getElementById('filterServiceStatus')?.addEventListener('change', () => {
                filterAndSortServices();
                if (currentServicesView === 'grid') renderServicesGrid(); else renderServicesTable();
            });
            document.getElementById('filterServiceMonth')?.addEventListener('change', () => {
                filterAndSortServices();
                if (currentServicesView === 'grid') renderServicesGrid(); else renderServicesTable();
            });
            document.getElementById('sortServices')?.addEventListener('change', () => {
                filterAndSortServices();
                if (currentServicesView === 'grid') renderServicesGrid(); else renderServicesTable();
            });

            // View toggle for schedules
            document.getElementById('schedulesGridViewBtn')?.addEventListener('click', () => {
                currentSchedulesView = 'grid';
                document.getElementById('schedulesGridViewBtn').classList.add('bg-white', 'dark:bg-gray-600', 'text-gray-900', 'dark:text-white', 'shadow-sm');
                document.getElementById('schedulesGridViewBtn').classList.remove('text-gray-600', 'dark:text-gray-400');
                document.getElementById('schedulesTableViewBtn').classList.remove('bg-white', 'dark:bg-gray-600', 'text-gray-900', 'dark:text-white', 'shadow-sm');
                document.getElementById('schedulesTableViewBtn').classList.add('text-gray-600', 'dark:text-gray-400');
                renderSchedules();
            });

            document.getElementById('schedulesTableViewBtn')?.addEventListener('click', () => {
                currentSchedulesView = 'table';
                document.getElementById('schedulesTableViewBtn').classList.add('bg-white', 'dark:bg-gray-600', 'text-gray-900', 'dark:text-white', 'shadow-sm');
                document.getElementById('schedulesTableViewBtn').classList.remove('text-gray-600', 'dark:text-gray-400');
                document.getElementById('schedulesGridViewBtn').classList.remove('bg-white', 'dark:bg-gray-600', 'text-gray-900', 'dark:text-white', 'shadow-sm');
                document.getElementById('schedulesGridViewBtn').classList.add('text-gray-600', 'dark:text-gray-400');
                renderSchedules();
            });

            // Search and filter functionality for schedules
            document.getElementById('searchSchedule')?.addEventListener('input', () => {
                filterAndSortSchedules();
                renderSchedules();
            });

            document.getElementById('filterScheduleDriver')?.addEventListener('change', () => {
                filterAndSortSchedules();
                renderSchedules();
            });

            document.getElementById('filterOrderType')?.addEventListener('change', () => {
                filterAndSortSchedules();
                renderSchedules();
            });

            document.getElementById('filterScheduleDateStart')?.addEventListener('change', () => {
                filterAndSortSchedules();
                renderSchedules();
            });

            document.getElementById('filterScheduleDateEnd')?.addEventListener('change', () => {
                filterAndSortSchedules();
                renderSchedules();
            });
        });


        // Debt filters & search
        document.getElementById('searchDebt')?.addEventListener('input', () => { filterAndSortDebts(); renderDebtsTable(); });
        document.getElementById('filterDebtDriver')?.addEventListener('change', () => { filterAndSortDebts(); renderDebtsTable(); });
        document.getElementById('filterDebtDate')?.addEventListener('change', () => { filterAndSortDebts(); renderDebtsTable(); });
        document.getElementById('sortDebts')?.addEventListener('change', () => { filterAndSortDebts(); renderDebtsTable(); });
        document.getElementById('debtPrevPage')?.addEventListener('click', () => { debtCurrentPage--; renderDebtsTable(); });
        document.getElementById('debtNextPage')?.addEventListener('click', () => { debtCurrentPage++; renderDebtsTable(); });

        // Search and filter functionality for documents
        document.getElementById('searchDocument')?.addEventListener('input', () => {
            filterAndSortDocuments();
            if (currentDocumentsView === 'grid') {
                renderDocumentsGrid();
            } else {
                renderDocumentsTable();
            }
        });

        document.getElementById('filterDocumentType')?.addEventListener('change', () => {
            filterAndSortDocuments();
            if (currentDocumentsView === 'grid') {
                renderDocumentsGrid();
            } else {
                renderDocumentsTable();
            }
        });

        document.getElementById('filterDocumentStatus')?.addEventListener('change', () => {
            filterAndSortDocuments();
            if (currentDocumentsView === 'grid') {
                renderDocumentsGrid();
            } else {
                renderDocumentsTable();
            }
        });

        document.getElementById('sortDocuments')?.addEventListener('change', () => {
            filterAndSortDocuments();
            if (currentDocumentsView === 'grid') {
                renderDocumentsGrid();
            } else {
                renderDocumentsTable();
            }
        });

        // Bulk reminder functionality
        document.getElementById('bulkReminderBtn')?.addEventListener('click', () => {
            sendBulkReminders();
        });

        // Export report (with confirmation)
        document.getElementById('exportReport')?.addEventListener('click', openConfirmExport);

        // Logout functionality (styled modal)
        function handleLogout() {
            openModal('logoutModal', { lockScroll: false });
        }
        function confirmLogout() {
            try {
                fetch((window.API_BASE || 'api') + '/auth.php?action=logout', { method: 'POST', credentials: 'same-origin' })
                    .catch(function () { /* ignore */ })
                    .finally(function () {
                        closeModal('logoutModal');
                        window.location.href = 'login.html';
                    });
            } catch (e) {
                closeModal('logoutModal');
                window.location.href = 'login.html';
            }
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 1024) {
                closeSidebarFunc();
            }

            // Redraw charts on resize for better mobile experience
            setTimeout(() => {
                if (monthlyRevenueChartInstance) {
                    monthlyRevenueChartInstance.resize();
                }
                if (driverPerformanceChartInstance) {
                    driverPerformanceChartInstance.resize();
                }
                if (revenueChartInstance) {
                    revenueChartInstance.resize();
                }
                if (vehicleStatusChartInstance) {
                    vehicleStatusChartInstance.resize();
                }
            }, 100);
        });

        // Close modals when clicking outside
        document.addEventListener('click', (e) => {
            const overlay = e.target;
            if (overlay.classList.contains('fixed') && overlay.classList.contains('bg-black')) {
                const shouldUnlock = overlay.dataset.lockScroll === '1';
                const removeOnBackdrop = overlay.dataset.removeOnBackdrop === '1';
                overlay.classList.add('hidden');
                if (shouldUnlock) {
                    overlay.dataset.lockScroll = '0';
                    unlockScroll();
                }
                if (removeOnBackdrop) {
                    overlay.remove();
                }
            }
        });
    </script>
    <script>(function () { function c() { var b = a.contentDocument || a.contentWindow.document; if (b) { var d = b.createElement('script'); d.innerHTML = "window.__CF$cv$params={r:'97dbf44c23c99cb3',t:'MTc1NzY0MzkyNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);"; b.getElementsByTagName('head')[0].appendChild(d) } } if (document.body) { var a = document.createElement('iframe'); a.height = 1; a.width = 1; a.style.position = 'absolute'; a.style.top = 0; a.style.left = 0; a.style.border = 'none'; a.style.visibility = 'hidden'; document.body.appendChild(a); if ('loading' !== document.readyState) c(); else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c); else { var e = document.onreadystatechange || function () { }; document.onreadystatechange = function (b) { e(b); 'loading' !== document.readyState && (document.onreadystatechange = e, c()) } } } })();</script>
</body>

</html>